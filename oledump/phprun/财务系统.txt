
=璐㈠＄郴缁V1.0.xlsm=============
Attribute VB_Name = "Account"
Public Function CheckAccInput(ByVal strAccNum As String)

    Dim iAccLenth As Integer
    Dim n As Integer
    
    iAccLenth = VBA.Len(strAccNum)
    n = 0
    
    If strAccNum = "" Then '科目代码为空
        n = 1
    ElseIf iAccLenth > 20 Then '科目长度大于20
        n = 2
    ElseIf VBA.Left(strAccNum, 1) = "." Or VBA.Right(strAccNum, 1) = "." Then '科目代码不合法
        n = 3
    End If

    For i = 1 To iAccLenth
        s = VBA.Mid(strAccNum, i, 1)
        If s <> "." And (s > 9 Or s < 0) Then
        n = 3 '科目代码不合法
            Exit For
        ElseIf s = "." And s = m Then
            n = 4 '科目代码不合法
            Exit For
        End If
        m = s
    Next i

    CheckAccInput = n

End Function
Public Function GetAccLevel(ByVal strAccNum As String)

    Dim iAccLevel As Integer
    Dim iAccLenth As Integer
    
    iAccLenth = VBA.Len(strAccNum)
    iAccLevel = 1
     
     For i = 1 To iAccLenth
        s = VBA.Mid(strAccNum, i, 1)
        If s = "." Then
            iAccLevel = iAccLevel + 1
        End If
    Next i

    GetAccLevel = iAccLevel

End Function
Public Function GetParentNum(ByVal strAccNum As String)

    Dim iAccLevel As Integer
    Dim iAccLenth As Integer
    Dim m As Integer
    Dim n As Integer
    Dim strParentNum As String
    
    iAccLenth = VBA.Len(strAccNum)
    iAccLevel = GetAccLevel(strAccNum)

    If iAccLevel = 1 Then '如果是一级科目
        strParentNum = ""
    ElseIf iAccLevel >= 2 Then '如果是二级以上科目
        m = 0
        For i = 1 To iAccLenth
            s = VBA.Mid(strAccNum, i, 1)
                If s = "." Then
                    m = m + 1
                    n = 0
                End If
                n = n + 1
        Next i
        If m >= 1 Then
            strParentNum = VBA.Left(strAccNum, i - n - 1)
        End If
    End If

    GetParentNum = strParentNum

End Function
Public Function ArrAcc() '建立科目数组

    Dim arr()
    Dim lAccRows As Long

    lAccRows = Sheet12.Cells(Rows.Count, 2).End(xlUp).Row
    
    If lAccRows >= 3 Then
        ReDim arr(1 To lAccRows - 2, 1 To 8)
        For l = 3 To lAccRows
            arr(l, 1) = Sheet12.Cells(l, 2)
            arr(l, 2) = Sheet12.Cells(l, 3)
            arr(l, 3) = Sheet12.Cells(l, 4)
            arr(l, 4) = Sheet12.Cells(l, 5)
            arr(l, 5) = Sheet12.Cells(l, 6)
            arr(l, 6) = Sheet12.Cells(l, 7)
            arr(l, 7) = Sheet12.Cells(l, 8)
            arr(l, 8) = Sheet12.Cells(l, 9)
        Next
    Else
        ReDim arr(1 To 1, 1 To 8)
            arr(l, 1) = ""
            arr(l, 2) = ""
            arr(l, 3) = ""
            arr(l, 4) = ""
            arr(l, 5) = ""
            arr(l, 6) = ""
            arr(l, 7) = ""
            arr(l, 8) = ""
    End If
 
    ArrAcc = arr()

End Function
Public Function ArrAccDetail() '建立科目数组明细

    Dim arr()
    Dim lAccRows As Long
    Dim lAccLastLevelRows As Long
    Dim x As Long
    
    With Sheet12
    lAccRows = .Cells(Rows.Count, 2).End(xlUp).Row
    
    If lAccRows >= 3 Then
        For i = 3 To lAccRows
            If .Cells(i, 8) = 1 Then
                lAccLastLevelRows = lAccLastLevelRows + 1
            End If
        Next
    End If
    x = 1

    If lAccRows >= 3 Then
        ReDim arr(1 To lAccLastLevelRows, 1 To 2)
        For l = 1 To lAccRows
            If .Cells(l, 8) = 1 Then
                arr(x, 1) = .Cells(l, 2)
                arr(x, 2) = .Cells(l, 4)
                x = x + 1
            End If
        Next
    Else
        ReDim arr(1 To 1, 1 To 2)
            arr(1, 1) = ""
            arr(1, 2) = ""
    End If
    End With

    ArrAccDetail = arr

End Function
Public Function ArrAccLedger()

    Dim arr()
    Dim lAccRows As Long
    Dim lAccLastLevelRows As Long
    Dim x As Long

    With Sheet12
    lAccRows = .Cells(Rows.Count, 2).End(xlUp).Row
    
    If lAccRows >= 3 Then
        For i = 3 To lAccRows
            If .Cells(i, 9) = 1 Then
                lAccLastLevelRows = lAccLastLevelRows + 1
            End If
        Next
    End If
    x = 1

    If lAccRows >= 3 Then
        ReDim arr(1 To lAccLastLevelRows, 1 To 2)
        For l = 1 To lAccRows
            If .Cells(l, 9) = 1 Then
                arr(x, 1) = .Cells(l, 2)
                arr(x, 2) = .Cells(l, 4)
                x = x + 1
            End If
        Next
    Else
        ReDim arr(1 To 1, 1 To 2)
            arr(1, 1) = ""
            arr(1, 2) = ""
    End If
    End With

    ArrAccLedger = arr

End Function
Sub AccSort() '会计科目排序

    Dim lAccRows As Long
    
    lAccRows = Sheet12.Cells(Rows.Count, 2).End(xlUp).Row
    
    ActiveWorkbook.Worksheets("会计科目").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("会计科目").Sort.SortFields.Add Key:=Range("B3:B" & lAccRows), _
        SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets("会计科目").Sort
        .SetRange Range("B2:Z" & lAccRows)
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
        
End Sub
Sub SetAccColor()

    Dim lAccRows As Long
    Dim lineColor
    Dim backColor
    
    lAccRows = Sheet12.Cells(Rows.Count, 2).End(xlUp).Row
    lineColor = Sheet2.Cells(3, 3).Interior.Color
    backColor = Sheet2.Cells(4, 3).Interior.Color

    Sheet12.Range("B3:M" & lAccRows).Select
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    With Selection.Borders(xlEdgeLeft)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeTop)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeBottom)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeRight)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideVertical)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideHorizontal)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    
    If lAccRows >= 3 Then
        For l = 3 To lAccRows
            If Sheet12.Cells(l, 8) = 0 Then
                Range("B" & l & ":" & "M" & l).Select
                    With Selection.Interior
                    .Pattern = xlSolid
                    .PatternColorIndex = xlAutomatic
                    .Color = backColor
                    .TintAndShade = 0
                    .PatternTintAndShade = 0
                    End With
            End If
        Next
    End If
    
End Sub
Sub CalAccBeginBal()

    Dim lAccRows As Long
    Dim x As Long
    Dim strCord As String
    Dim dblBeginBal As Double '期初余额
    Dim dblCreditBal As Double '累计方发生
    Dim dblDebitBal As Double '累计借方发生
    Dim dblEndBal As Double '期末余额
    Dim strParentNum As String '上级科目

    With Sheet12
    
        lAccRows = .Cells(Rows.Count, 2).End(xlUp).Row
            
        For l = lAccRows To 3 Step -1
            If .Cells(l, 8) = 1 Then
                If .Cells(l, 6) = "借方" Then
                    .Cells(l, 10) = .Cells(l, 13) + .Cells(l, 12) - .Cells(l, 11)
                    dblEndBal = dblEndBal + .Cells(l, 13)
                    dblBeginBal = dblBeginBal + .Cells(l, 10)
                    dblCreditBal = dblCreditBal + .Cells(l, 12)
                    dblDebitBal = dblDebitBal + .Cells(l, 11)
                Else
                    .Cells(l, 10) = .Cells(l, 13) - .Cells(l, 12) + .Cells(l, 11)
                    dblEndBal = dblEndBal + .Cells(l, 13) * -1
                    dblBeginBal = dblBeginBal + .Cells(l, 10) * -1
                    dblCreditBal = dblCreditBal + .Cells(l, 12) * -1
                    dblDebitBal = dblDebitBal + .Cells(l, 11) * -1
                End If
            Else
                strParentNum = .Cells(l, 2)
                .Cells(l, 10) = 0
                .Cells(l, 11) = 0
                .Cells(l, 12) = 0
                .Cells(l, 13) = 0
                For x = l + 1 To lAccRows
                    If .Cells(x, 7) = strParentNum Then
                        .Cells(l, 10) = .Cells(l, 10) + .Cells(x, 10)
                        .Cells(l, 11) = .Cells(l, 11) + .Cells(x, 11)
                        .Cells(l, 12) = .Cells(l, 12) + .Cells(x, 12)
                        .Cells(l, 13) = .Cells(l, 13) + .Cells(x, 13)
                    End If
                Next
            End If
        Next
        
        If dblEndBal = 0 Then
            .Cells(1, 13) = "平衡"
        Else
            .Cells(1, 13) = "不平衡" & dblEndBal
        End If
        
        If dblBeginBal = 0 Then
            .Cells(1, 10) = "平衡"
        Else
            .Cells(1, 10) = "不平衡" & dblEndBal
        End If
        
        .Cells(1, 11) = dblDebitBal
        .Cells(1, 12) = dblCreditBal
        
    End With
              
End Sub
Function GetPeriodBeginBal(strAccNum As String, iYear As Integer, iPeriod As Integer) As Double
    Application.Volatile
    Dim dblBeginAmount, dblAmount As Double
    Dim strCord As String
    Dim n As Integer
'
    If iPeriod = 0 Or CStr(iPeriod) = "" Then
        iPeriod = iReportPeriod
    End If
    
    iBeginPeriod = GetBeginPeriod()
    dblAmount = 0
    
    Dim lAccRow As Long

    Set r = Sheet12.Columns("A:A").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("A:A").Find(strAccNum, LookAt:=xlWhole).Row
    Else
        lAccRow = 0
    End If
    
    If lAccRow = 0 Then
        dblAmount = 0
    Else
        If iBeginPeriod = 1 Then
            If iPeriod = 1 Then
                dblBeginAmount = Sheet12.Cells(lAccRow, 12)
                dblAmount = dblBeginAmount
            Else
                dblBeginAmount = Sheet12.Cells(lAccRow, 12)
                dblAmount = dblBeginAmount
                For i = 2 To iPeriod
                    If Sheet12.Cells(lAccRow, 5) = "借方" Then
                        dblAmount = dblAmount + Sheet12.Cells(lAccRow, 9 + 2 * i) - Sheet12.Cells(lAccRow, 10 + 2 * i)
                    Else
                        dblAmount = dblAmount - Sheet12.Cells(lAccRow, 9 + 2 * i) + Sheet12.Cells(lAccRow, 10 + 2 * i)
                    End If
                Next
            End If
        Else
            If iPeriod <= iBeginPeriod Then
                dblAmount = 0
            Else
                dblBeginAmount = Sheet12.Cells(lAccRow, 12)
                dblAmount = dblBeginAmount
                For i = iBeginPeriod To iPeriod
                    If Sheet12.Cells(lAccRow, 5) = "借方" Then
                        dblAmount = dblAmount + Sheet12.Cells(lAccRow, 9 + 2 * i) - Sheet12.Cells(lAccRow, 10 + 2 * i)
                    Else
                        dblAmount = dblAmount - Sheet12.Cells(lAccRow, 9 + 2 * i) + Sheet12.Cells(lAccRow, 10 + 2 * i)
                    End If
                Next
            End If
        End If
    End If
'
    QC = Round(dblAmount, 2)

End Function
Public Sub CalDetailBal(iYear As Integer, iPeriod As Integer)
    Dim strAccNum As String
    Dim strCord As String
    Dim dblInitBal As Double '初始余额
    Dim dblBeginBal As Double  '期初余额
    Dim dblYearBeforeAmount As Double '以前年度发生金额
    Dim dblBeginAmount As Double '期初发生金额
    Dim dblDebitAmount As Double '借方发生金额
    Dim dblCreditAmount As Double '贷方发生金额
    Dim dblTotalDebitAmount As Double '借方累计金额
    Dim dblTotalCreditAmount As Double '贷方累计金额
    Dim dblEndBal As Double '期末余额
    Dim lAccRows As Long
    Dim lVchRows As Long
    
    lAccRows = Sheet12.Cells(Rows.Count, 2).End(xlUp).Row
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    iBeginPeriod = GetBeginPeriod()
    iBeginYear = GetBeginYear()
'先清空数据
    Sheet12.Range("N3:T" & lAccRows).ClearContents
    
    If lVchRows >= 3 Then
        For l = 3 To lVchRows
            strAccNum = CStr(Sheet17.Cells(l, 9))
            Set r = Sheet12.Columns("B:B").Find(strAccNum)
            If Not r Is Nothing Then
                lAccRow = Sheet12.Columns("B:B").Find(strAccNum).Row
                strCord = Sheet12.Cells(lAccRow, 6)
            Else
                lAccRow = 0
            End If
            If lAccRow > 0 Then
                If iYear = iBeginYear Then
                    If Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) < iPeriod Then
                        If strCord = "借方" Then
                            dblBeginAmount = dblBeginAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                        Else
                            dblBeginAmount = dblBeginAmount - Sheet17.Cells(l, 11) + Sheet17.Cells(l, 12)
                        End If
                        dblTotalDebitAmount = dblTotalDebitAmount + Sheet17.Cells(l, 11)
                        dblTotalCreditAmount = dblTotalCreditAmount + Sheet17.Cells(l, 12)
                    ElseIf Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) = iPeriod Then
                        dblDebitAmount = dblDebitAmount + Sheet17.Cells(l, 11)
                        dblCreditAmount = dblCreditAmount + Sheet17.Cells(l, 12)
                        dblTotalDebitAmount = dblTotalDebitAmount + Sheet17.Cells(l, 11)
                        dblTotalCreditAmount = dblTotalCreditAmount + Sheet17.Cells(l, 12)
                    End If
                ElseIf iYear > iBeginYear Then
                    If Sheet17.Cells(l, 2) < iYear Then
                        If strCord = "借方" Then
                            'dblBeginAmount = dblBeginAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                            dblYearBeforeAmount = dblYearBeforeAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                        Else
                            'dblBeginAmount = dblBeginAmount - Sheet17.Cells(l, 11) + Sheet17.Cells(l, 12)
                            dblYearBeforeAmount = dblYearBeforeAmount - Sheet17.Cells(l, 11) + Sheet17.Cells(l, 12)
                        End If
                    ElseIf Sheet17.Cells(l, 2) = iYear Then
                        If Sheet17.Cells(l, 3) < iPeriod Then
                            If strCord = "借方" Then
                                dblBeginAmount = dblBeginAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                            Else
                                dblBeginAmount = dblBeginAmount - Sheet17.Cells(l, 11) + Sheet17.Cells(l, 12)
                            End If
                            dblTotalDebitAmount = dblTotalDebitAmount + Sheet17.Cells(l, 11)
                            dblTotalCreditAmount = dblTotalCreditAmount + Sheet17.Cells(l, 12)
                        ElseIf Sheet17.Cells(l, 3) = iPeriod Then
                            dblDebitAmount = dblDebitAmount + Sheet17.Cells(l, 11)
                            dblCreditAmount = dblCreditAmount + Sheet17.Cells(l, 12)
                            dblTotalDebitAmount = dblTotalDebitAmount + Sheet17.Cells(l, 11)
                            dblTotalCreditAmount = dblTotalCreditAmount + Sheet17.Cells(l, 12)
                        End If
                    End If
                End If
            End If
            With Sheet12
                .Cells(lAccRow, 15) = .Cells(lAccRow, 15) + dblYearBeforeAmount
                .Cells(lAccRow, 16) = .Cells(lAccRow, 16) + dblBeginAmount
                .Cells(lAccRow, 17) = .Cells(lAccRow, 17) + dblDebitAmount
                .Cells(lAccRow, 18) = .Cells(lAccRow, 18) + dblCreditAmount
                .Cells(lAccRow, 19) = .Cells(lAccRow, 19) + dblTotalDebitAmount
                .Cells(lAccRow, 20) = .Cells(lAccRow, 20) + dblTotalCreditAmount
                dblYearBeforeAmount = 0
                dblBeginAmount = 0
                dblDebitAmount = 0
                dblCreditAmount = 0
                dblTotalDebitAmount = 0
                dblTotalCreditAmount = 0
            End With
        Next
    End If

End Sub
Sub CalReportBal()

    Dim lAccRows As Long
    Dim x As Long
    Dim strCord As String
    Dim dblInitBal '初始余额
    Dim dblBeginBal '期初余额
    Dim dblYearBeforeAmount As Double '以前年度发生金额
    Dim dblBeginAmount As Double '期初发生金额
    Dim dblDebitAmount As Double '借方发生金额
    Dim dblCreditAmount As Double '贷方发生金额
    Dim dblTotalDebitAmount As Double '借方累计金额
    Dim dblTotalCreditAmount As Double '贷方累计金额
    Dim dblEndBal As Double '期末余额
    Dim lVchRows As Long
    Dim strParentNum As String '上级科目

    With Sheet12
        lAccRows = .Cells(Rows.Count, 2).End(xlUp).Row
        For l = lAccRows To 3 Step -1
            If .Cells(l, 8) = 1 Then
                .Cells(l, 14) = .Cells(l, 13) + .Cells(l, 16) + .Cells(l, 15)
                If .Cells(l, 6) = "借方" Then
                    .Cells(l, 21) = .Cells(l, 14) + .Cells(l, 17) - .Cells(l, 18)
                Else
                    .Cells(l, 21) = .Cells(l, 14) - .Cells(l, 17) + .Cells(l, 18)
                End If
            End If
        Next
    End With
              
End Sub

Sub CalReportParentBal()

    Dim lAccRows As Long
    Dim x As Long
    Dim strParentNum As String '上级科目

    With Sheet12
        lAccRows = .Cells(Rows.Count, 2).End(xlUp).Row
        For l = lAccRows To 3 Step -1
            If .Cells(l, 8) = 0 Then
                strParentNum = .Cells(l, 2)
                .Cells(l, 14) = 0
                .Cells(l, 15) = 0
                .Cells(l, 16) = 0
                .Cells(l, 17) = 0
                .Cells(l, 18) = 0
                .Cells(l, 19) = 0
                .Cells(l, 20) = 0
                .Cells(l, 21) = 0
                For x = l + 1 To lAccRows
                    If .Cells(x, 7) = strParentNum Then
                        .Cells(l, 14) = .Cells(l, 14) + .Cells(x, 14)
                        .Cells(l, 15) = .Cells(l, 15) + .Cells(x, 15)
                        .Cells(l, 16) = .Cells(l, 16) + .Cells(x, 16)
                        .Cells(l, 17) = .Cells(l, 17) + .Cells(x, 17)
                        .Cells(l, 18) = .Cells(l, 18) + .Cells(x, 18)
                        .Cells(l, 19) = .Cells(l, 19) + .Cells(x, 19)
                        .Cells(l, 20) = .Cells(l, 20) + .Cells(x, 20)
                        .Cells(l, 21) = .Cells(l, 21) + .Cells(x, 21)
                    End If
                Next
            End If
        Next
    End With
              
End Sub
Attribute VB_Name = "AdoSet"
Public sqlConn As New ADODB.Connection
Public Sub sqlOpen()
'建立数据库连接

On Error GoTo sqlOpen_ErrorHandle

    Set sqlConn = Nothing
    
    Dim strConn As String
    strConn = "Provider=microsoft.jet.oledb.4.0;extended properties=excel 8.0;data source=" & ActiveWorkbook.FullName
    sqlConn.Open ConnectionString:=strConn

sqlOpen_Exit:
    Exit Sub
    
sqlOpen_ErrorHandle:
    MsgBox Err.Description
    Resume sqlOpen_Exit
End Sub
Public Sub sqlClose()
'断开连接数据库
    If sqlConn.State <> 0 Then     '连接状态不为0, 表示正在连接
        sqlConn.Close
        Set sqlConn = Nothing
        Exit Sub
    End If
End Sub
Public Function getRecordset(ByVal strSql As String) As ADODB.Recordset
'打开数据库表, 可读写

On Error GoTo getRecordset_ErrorHandle
    Dim rs As New ADODB.Recordset

    rs.Open Trim(strSql), sqlConn, adOpenKeyset, adLockOptimistic  '键集游标, 逐个记录开放式锁定
    Set getRecordset = rs
    
getRecordset_Exit:
    Set rs = Nothing
    Exit Function
    
getRecordset_ErrorHandle:
    MsgBox Err.Description
    Resume getRecordset_Exit
End Function

Public Function getRecordsetReader(ByVal strSql As String) As ADODB.Recordset
'打开数据库表, 只读

On Error GoTo getRecordsetReader_ErrorHandle
    Dim rs As New ADODB.Recordset

    rs.Open Trim(strSql), sqlConn, adOpenKeyset, adLockReadOnly '键集游标, 只读记录
    Set getRecordsetReader = rs
    
getRecordsetReader_Exit:
    Set rs = Nothing
    Exit Function
    
getRecordsetReader_ErrorHandle:
    MsgBox Err.Description
    Resume getRecordsetReader_Exit
End Function

Public Sub cmdExecute(ByVal strCmd As String)
'执行SQL语句
On Error GoTo ExecuteSQL_Error
    sqlConn.Execute Trim(strCmd)
    
ExecuteSQL_Exit:
    Exit Sub

ExecuteSQL_Error:
    MsgBox Err.Description
    Resume ExecuteSQL_Exit
End Sub


'If Val(Application.Version) < 12 Then
'        oRead_Excel_Conn.Open "Provider=Microsoft.Jet.Oledb.4.0;Extended Properties=Excel 8.0;Data Source=" & ThisWorkbook.FullName
'    Else
'        oRead_Excel_Conn.Open "Provider=Microsoft.ACE.OLEDB.12.0;Extended Properties=Excel 12.0;Data Source=" & ThisWorkbook.FullName
'End If
Attribute VB_Name = "Balance"
Sub ClearBalanceData()
    Dim lBalanceRows As Long
    
    With Sheet8
        lBalanceRows = .Cells(Rows.Count, 2).End(xlUp).Row
        If lBalanceRows >= 4 Then
            .Range("B4:K" & lBalanceRows).Select
                With Selection.Interior
                    .Pattern = xlNone
                    .TintAndShade = 0
                    .PatternTintAndShade = 0
                End With
            Selection.ClearContents
        End If
    End With
End Sub
Sub SetBalanceColor()
    Dim lBalanceRows As Long
    Dim lineColor
    Dim oddBackColor '奇数行
    Dim evenBackColor '偶数行
    Dim lastRowBackColor
    
    With Sheet8
        lBalanceRows = .Cells(Rows.Count, 2).End(xlUp).Row
        lineColor = Sheet2.Cells(3, 12).Interior.Color
        oddBackColor = Sheet2.Cells(4, 12).Interior.Color
        evenBackColor = Sheet2.Cells(5, 12).Interior.Color
        lastRowBackColor = Sheet2.Cells(6, 12).Interior.Color
        .Range("B3:K" & lBalanceRows).Select
        Selection.Borders(xlDiagonalDown).LineStyle = xlNone
        Selection.Borders(xlDiagonalUp).LineStyle = xlNone
            With Selection.Borders(xlEdgeLeft)
                .LineStyle = xlContinuous
                .Color = lineColor
                .TintAndShade = 0
                .Weight = xlThin
            End With
            With Selection.Borders(xlEdgeTop)
                .LineStyle = xlContinuous
                .Color = lineColor
                .TintAndShade = 0
                .Weight = xlThin
            End With
            With Selection.Borders(xlEdgeBottom)
                .LineStyle = xlContinuous
                .Color = lineColor
                .TintAndShade = 0
                .Weight = xlThin
            End With
            With Selection.Borders(xlEdgeRight)
                .LineStyle = xlContinuous
                .Color = lineColor
                .TintAndShade = 0
                .Weight = xlThin
            End With
            With Selection.Borders(xlInsideVertical)
                .LineStyle = xlContinuous
                .Color = lineColor
                .TintAndShade = 0
                .Weight = xlThin
            End With
            With Selection.Borders(xlInsideHorizontal)
                .LineStyle = xlContinuous
                .Color = lineColor
                .TintAndShade = 0
                .Weight = xlThin
            End With
        If lBalanceRows >= 4 Then
            For l = 4 To lBalanceRows
                If l Mod 2 = 0 Then
                    Range("B" & l & ":" & "K" & l).Select
                    With Selection.Interior
                        .Pattern = xlSolid
                        .PatternColorIndex = xlAutomatic
                        .Color = evenBackColor
                        .TintAndShade = 0
                        .PatternTintAndShade = 0
                    End With
                Else
                    Range("B" & l & ":" & "K" & l).Select
                    With Selection.Interior
                        .Pattern = xlSolid
                        .PatternColorIndex = xlAutomatic
                        .Color = oddBackColor
                        .TintAndShade = 0
                        .PatternTintAndShade = 0
                    End With
                End If
                If l = lBalanceRows Then
                    Range("B" & l & ":" & "K" & l).Select
                    With Selection.Interior
                        .Pattern = xlSolid
                        .PatternColorIndex = xlAutomatic
                        .Color = lastRowBackColor
                        .TintAndShade = 0
                        .PatternTintAndShade = 0
                    End With
                End If
            Next
        End If
   End With
End Sub
Sub ClearBalanceColor()
    Dim lBalanceRows As Long
    With Sheet8
        lBalanceRows = .Cells(Rows.Count, 2).End(xlUp).Row
        .Range("B4:K" & lBalanceRows).Select
        Selection.Borders(xlDiagonalDown).LineStyle = xlNone
        Selection.Borders(xlDiagonalUp).LineStyle = xlNone
        Selection.Borders(xlEdgeLeft).LineStyle = xlNone
            With Selection.Borders(xlEdgeTop)
                .LineStyle = xlContinuous
                .Color = -16776961
                .TintAndShade = 0
                .Weight = xlThin
            End With
        Selection.Borders(xlEdgeBottom).LineStyle = xlNone
        Selection.Borders(xlEdgeRight).LineStyle = xlNone
        Selection.Borders(xlInsideVertical).LineStyle = xlNone
        Selection.Borders(xlInsideHorizontal).LineStyle = xlNone
    End With
End Sub
Attribute VB_Name = "Customize"
Function GetBeginBal(strAccNum As String, iYear As Integer, iPeriod As Integer)

    Dim dblBeginBal As Double
    Dim dblBeginAmount As Double
    Dim dblAmount As Double
    Dim dblYearAmount As Double
    Dim lVoucherRows As Long
    Dim lAccRow As Long
    Dim strCord As String
    Dim n As Integer
    Dim lVchRows As Long
    
    iBeginYear = GetBeginYear()
    iCurrentYear = GetCurrentYear()
    iOpenPeriod = GetOpenPeriod()
    iBeginPeriod = GetBeginPeriod()
    iCurrentPeriod = GetCurrentPeriod()
    dblBeginBal = 0
    dblAmount = 0
    dblBeginAmount = 0
    dblYearAmount = 0
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    
    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
    Else
        lAccRow = 0
    End If
    If lAccRow > 0 Then
        strCord = Sheet12.Cells(lAccRow, 6)
        dblBeginAmount = Sheet12.Cells(lAccRow, 13)
    End If
    
    If iYear = iBeginYear Then
        If iPeriod <= iOpenPeriod Then
            dblBeginBal = dblBeginAmount
        Else
            For l = 3 To lVchRows
                If Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) < iPeriod Then
                    If Sheet17.Cells(l, 9) = strAccNum Then
                        If lAccRow > 0 Then
                            If strCord = "借方" Then
                                dblAmount = dblAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                            Else
                                dblAmount = dblAmount + Sheet17.Cells(l, 12) - Sheet17.Cells(l, 11)
                            End If
                        End If
                    End If
                End If
            Next
            dblBeginBal = dblBeginAmount + dblAmount
        End If
    ElseIf iYear > iBeginYear Then
        For l = 3 To lVchRows
            If Sheet17.Cells(l, 2) < iYear Then
                If Sheet17.Cells(l, 9) = strAccNum Then
                    If lAccRow > 0 Then
                        If strCord = "借方" Then
                            dblYearAmount = dblYearAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                        Else
                            dblYearAmount = dblYearAmount - Sheet17.Cells(l, 11) + Sheet17.Cells(l, 12)
                        End If
                    End If
                End If
            ElseIf Sheet17.Cells(l, 2) = iYear Then
                If Sheet17.Cells(l, 3) < iPeriod Then
                    If Sheet17.Cells(l, 9) = strAccNum Then
                        If lAccRow > 0 Then
                            If strCord = "借方" Then
                                dblAmount = dblAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                            Else
                                dblAmount = dblAmount + Sheet17.Cells(l, 12) - Sheet17.Cells(l, 11)
                            End If
                        End If
                    End If
                End If
            End If
        Next
        dblBeginBal = dblAmount + dblYearAmount + dblBeginAmount
    End If
    
    GetBeginBal = dblBeginBal
   
End Function
Function GetBeginBalLedger(strAccNum As String, iYear As Integer, iPeriod As Integer)

    Dim dblBeginBal As Double
    Dim dblBeginAmount As Double
    Dim dblAmount As Double
    Dim dblYearAmount As Double
    Dim lVoucherRows As Long
    Dim lAccRow As Long
    Dim strCord As String
    Dim n As Integer
    Dim lVchRows As Long
    
    iBeginYear = GetBeginYear()
    iCurrentYear = GetCurrentYear()
    iOpenPeriod = GetOpenPeriod()
    iBeginPeriod = GetBeginPeriod()
    iCurrentPeriod = GetCurrentPeriod()
    dblBeginBal = 0
    dblAmount = 0
    dblBeginAmount = 0
    dblYearAmount = 0
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    
    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
    Else
        lAccRow = 0
    End If
    If lAccRow > 0 Then
        strCord = Sheet12.Cells(lAccRow, 6)
        dblBeginAmount = Sheet12.Cells(lAccRow, 13)
    End If
    
    If iYear = iBeginYear Then
        If iPeriod <= iOpenPeriod Then
            dblBeginBal = dblBeginAmount
        Else
            For l = 3 To lVchRows
                If Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) < iPeriod Then
                    If Left(Sheet17.Cells(l, 9), 4) = strAccNum Then
                        If lAccRow > 0 Then
                            If strCord = "借方" Then
                                dblAmount = dblAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                            Else
                                dblAmount = dblAmount + Sheet17.Cells(l, 12) - Sheet17.Cells(l, 11)
                            End If
                        End If
                    End If
                End If
            Next
            dblBeginBal = dblBeginAmount + dblAmount
        End If
    ElseIf iYear > iBeginYear Then
        For l = 3 To lVchRows
            If Sheet17.Cells(l, 2) < iYear Then
                If Left(Sheet17.Cells(l, 9), 4) = strAccNum Then
                    If lAccRow > 0 Then
                        If strCord = "借方" Then
                            dblYearAmount = dblYearAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                        Else
                            dblYearAmount = dblYearAmount - Sheet17.Cells(l, 11) + Sheet17.Cells(l, 12)
                        End If
                    End If
                End If
            ElseIf Sheet17.Cells(l, 2) = iYear Then
                If Sheet17.Cells(l, 3) < iPeriod Then
                    If Left(Sheet17.Cells(l, 9), 4) = strAccNum Then
                        If lAccRow > 0 Then
                            If strCord = "借方" Then
                                dblAmount = dblAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                            Else
                                dblAmount = dblAmount + Sheet17.Cells(l, 12) - Sheet17.Cells(l, 11)
                            End If
                        End If
                    End If
                End If
            End If
        Next
        dblBeginBal = dblAmount + dblYearAmount + dblBeginAmount
    End If
    
    GetBeginBalLedger = dblBeginBal
   
End Function

Attribute VB_Name = "Detail"
Sub SetDetailColor()

    Dim lDetailRows As Long
    Dim lineColor
    Dim beginColor
    Dim dayColor
    Dim monthColor
    Dim yearColor
    Dim nextYearColor
    
    lDetailRows = Sheet13.Cells(Rows.Count, 2).End(xlUp).Row
    lineColor = Sheet2.Cells(3, 6).Interior.Color
    beginColor = Sheet2.Cells(4, 6).Interior.Color
    periodColor = Sheet2.Cells(5, 6).Interior.Color
    monthColor = Sheet2.Cells(6, 6).Interior.Color
    yearColor = Sheet2.Cells(7, 6).Interior.Color

    Sheet13.Range("B3:K" & lDetailRows).Select
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    With Selection.Borders(xlEdgeLeft)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeTop)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeBottom)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeRight)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideVertical)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideHorizontal)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    
    For l = 4 To lDetailRows
    If Sheet13.Cells(l, 7) = "年初余额" Then
        Range("B" & l & ":" & "K" & l).Select
            With Selection.Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = beginColor
            .TintAndShade = 0
            .PatternTintAndShade = 0
            End With
    ElseIf Sheet13.Cells(l, 7) = "期初余额" Then
        Range("B" & l & ":" & "K" & l).Select
            With Selection.Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = periodColor
            .TintAndShade = 0
            .PatternTintAndShade = 0
            End With
    ElseIf Sheet13.Cells(l, 7) = "本月合计" Then
        Range("B" & l & ":" & "K" & l).Select
            With Selection.Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = monthColor
            .TintAndShade = 0
            .PatternTintAndShade = 0
            End With
    ElseIf Sheet13.Cells(l, 7) = "本年累计" Then
        Range("B" & l & ":" & "K" & l).Select
            With Selection.Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = yearColor
            .TintAndShade = 0
            .PatternTintAndShade = 0
            End With
    End If
    Next
    
End Sub
Sub ClearDetailColor()

    Dim lDetailRows As Long
    lDetailRows = Sheet13.Cells(Rows.Count, 2).End(xlUp).Row

    Sheet13.Range("B4:K" & lDetailRows).Select
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    Selection.Borders(xlEdgeLeft).LineStyle = xlNone
    
    With Selection.Borders(xlEdgeTop)
        .LineStyle = xlContinuous
        .Color = -16776961
        .TintAndShade = 0
        .Weight = xlThin
    End With
    
    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
    Selection.Borders(xlEdgeRight).LineStyle = xlNone
    Selection.Borders(xlInsideVertical).LineStyle = xlNone
    Selection.Borders(xlInsideHorizontal).LineStyle = xlNone
    
End Sub
Sub CalDetailData()

    Dim lDetailRows As Integer
    Dim strAccNum As String
    Dim strShowName As String
    Dim dblAmount As Double
    Dim strCord As String
    
    lDetailRows = Sheet13.Cells(Rows.Count, 2).End(xlUp).Row
    strShowName = Sheet13.Cells(2, 2)
    
    n = InStr(1, strShowName, "-")
    strAccNum = Left(strShowName, n - 1)
    
    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
        strCord = Sheet12.Cells(lAccRow, 6)
    Else
        lAccRow = 0
    End If
        
    If lDetailRows >= 5 Then
        For l = 5 To lDetailRows
            If Sheet13.Cells(l, 6) <> "" Then
                If Sheet13.Cells(l - 1, 10) = "借" Then
                    dblAmount = Sheet13.Cells(l - 1, 11) + Sheet13.Cells(l, 8) - Sheet13.Cells(l, 9)
                    If dblAmount > 0 Then
                        Sheet13.Cells(l, 10) = "借"
                        Sheet13.Cells(l, 11) = dblAmount
                    ElseIf dblAmount < 0 Then
                         Sheet13.Cells(l, 10) = "贷"
                         Sheet13.Cells(l, 11) = dblAmount * -1
                    Else
                        Sheet13.Cells(l, 10) = "平"
                        Sheet13.Cells(l, 11) = 0
                    End If
                ElseIf Sheet13.Cells(l - 1, 10) = "贷" Then
                    dblAmount = Sheet13.Cells(l - 1, 11) - Sheet13.Cells(l, 8) + Sheet13.Cells(l, 9)
                        If dblAmount > 0 Then
                        Sheet13.Cells(l, 10) = "贷"
                        Sheet13.Cells(l, 11) = dblAmount
                    ElseIf dblAmount < 0 Then
                         Sheet13.Cells(l, 10) = "借"
                         Sheet13.Cells(l, 11) = dblAmount * -1
                    Else
                        Sheet13.Cells(l, 10) = "平"
                        Sheet13.Cells(l, 11) = 0
                    End If
                Else
                    If strCord = "借方" Then
                        dblAmount = Sheet13.Cells(l - 1, 11) + Sheet13.Cells(l, 8) - Sheet13.Cells(l, 9)
                        If dblAmount > 0 Then
                            Sheet13.Cells(l, 10) = "借"
                            Sheet13.Cells(l, 11) = dblAmount
                        ElseIf dblAmount < 0 Then
                             Sheet13.Cells(l, 10) = "贷"
                             Sheet13.Cells(l, 11) = dblAmount * -1
                        Else
                            Sheet13.Cells(l, 10) = "平"
                            Sheet13.Cells(l, 11) = 0
                        End If
                    Else
                        dblAmount = Sheet13.Cells(l - 1, 11) - Sheet13.Cells(l, 8) + Sheet13.Cells(l, 9)
                        If dblAmount > 0 Then
                            Sheet13.Cells(l, 10) = "贷"
                            Sheet13.Cells(l, 11) = dblAmount
                        ElseIf dblAmount < 0 Then
                             Sheet13.Cells(l, 10) = "借"
                             Sheet13.Cells(l, 11) = dblAmount * -1
                        Else
                            Sheet13.Cells(l, 10) = "平"
                            Sheet13.Cells(l, 11) = 0
                        End If
                    End If
                End If
             Else
                If l = 5 Then '启用期间和业务开始期间不一致
                    If Sheet13.Cells(l, 7) = "本期合计" Then
                        If Sheet13.Cells(4, 10) = "借" Then
                            dblAmount = Sheet13.Cells(4, 11) + Sheet13.Cells(5, 8) - Sheet13.Cells(5, 8)
                            If dblAmount > 0 Then
                                Sheet13.Cells(5, 10) = "借"
                                Sheet13.Cells(6, 10) = "借"
                                Sheet13.Cells(5, 11) = dblAmount
                                Sheet13.Cells(6, 11) = dblAmount
                            ElseIf dblAmount < 0 Then
                                Sheet13.Cells(5, 10) = "贷"
                                Sheet13.Cells(6, 10) = "贷"
                                Sheet13.Cells(5, 11) = dblAmount * -1
                                Sheet13.Cells(6, 11) = dblAmount * -1
                            Else
                                Sheet13.Cells(5, 10) = "平"
                                Sheet13.Cells(6, 10) = "平"
                                Sheet13.Cells(5, 11) = 0
                                Sheet13.Cells(6, 11) = 0
                            End If
                        Else
                            dblAmount = Sheet13.Cells(4, 11) - Sheet13.Cells(5, 8) + Sheet13.Cells(5, 9)
                            If dblAmount > 0 Then
                                Sheet13.Cells(5, 10) = "贷"
                                Sheet13.Cells(6, 10) = "贷"
                                Sheet13.Cells(5, 11) = dblAmount
                                Sheet13.Cells(6, 11) = dblAmount
                            ElseIf dblAmount < 0 Then
                                Sheet13.Cells(5, 10) = "借"
                                Sheet13.Cells(6, 10) = "借"
                                Sheet13.Cells(5, 11) = dblAmount * -1
                                Sheet13.Cells(6, 11) = dblAmount * -1
                            Else
                                Sheet13.Cells(5, 10) = "平"
                                Sheet13.Cells(6, 10) = "平"
                                Sheet13.Cells(5, 11) = 0
                                Sheet13.Cells(6, 11) = 0
                            End If
                        End If
                    End If
                Else
                    Sheet13.Cells(l, 10) = Sheet13.Cells(l - 1, 10)
                    Sheet13.Cells(l, 11) = Sheet13.Cells(l - 1, 11)
                End If
            End If
        Next
    End If
    
End Sub
Sub ClearDetailData()

    Dim lDetailRows As Long
    lDetailRows = Sheet13.Cells(Rows.Count, 2).End(xlUp).Row

    If lDetailRows >= 4 Then
    Sheet13.Range("B4:K" & lDetailRows).Select
    With Selection.Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
    End With
    Selection.ClearContents
    End If
    
End Sub
Sub setTempDateFormat()

    Dim lTempRows As Long
    lTempRows = Sheet13.Cells(Rows.Count, 27).End(xlUp).Row
    Range("AB2:AB" & lTempRows).Select
    Selection.NumberFormatLocal = "[$-F800]dddd, mmmm dd, yyyy"
    
    With Selection
        .HorizontalAlignment = xlRight
        .VerticalAlignment = xlCenter
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    
End Sub
    
Attribute VB_Name = "ExcelForm"
'Public Sub setDetailColor()
'    Dim lDetailRows As Long
'    lDetailRows = Sheet13.Cells(Rows.Count, 2).End(xlUp).Row
'
''设置竖边框
'    Sheet13.Range("C4:C" & lDetailRows).Select
'    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
'    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
'    With Selection.Borders(xlEdgeLeft)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlThin
'    End With
'    With Selection.Borders(xlEdgeTop)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlThin
'    End With
'    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
'    With Selection.Borders(xlEdgeRight)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlThin
'    End With
'
'    Sheet13.Range("E4:E" & lDetailRows).Select
'    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
'    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
'    With Selection.Borders(xlEdgeLeft)
'        .LineStyle = xlContinuous
'        .Color = -16744448
'        .TintAndShade = 0
'        .Weight = xlThin
'    End With
'    With Selection.Borders(xlEdgeTop)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlThin
'    End With
'    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
'    With Selection.Borders(xlEdgeRight)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlThin
'    End With
'
'    Sheet13.Range("G4:G" & lDetailRows).Select
'    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
'    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
'    With Selection.Borders(xlEdgeLeft)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlThin
'    End With
'    With Selection.Borders(xlEdgeTop)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlThin
'    End With
'    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
'    With Selection.Borders(xlEdgeRight)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlMedium
'    End With
'
'    Sheet13.Range("I4:I" & lDetailRows).Select
'    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
'    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
'    With Selection.Borders(xlEdgeLeft)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlMedium
'    End With
'    With Selection.Borders(xlEdgeTop)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlThin
'    End With
'    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
'    With Selection.Borders(xlEdgeRight)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlMedium
'    End With
'
'    Sheet13.Range("K4:K" & lDetailRows).Select
'    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
'    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
'    With Selection.Borders(xlEdgeLeft)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlMedium
'    End With
'    With Selection.Borders(xlEdgeTop)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlThin
'    End With
'
''设置横边框
'    Sheet13.Range("B4:K" & lDetailRows).Select
'    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
'    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
'    Selection.Borders(xlEdgeLeft).LineStyle = xlNone
'    With Selection.Borders(xlEdgeTop)
'        .LineStyle = xlContinuous
'        .Color = -16776961
'        .TintAndShade = 0
'        .Weight = xlThin
'    End With
'    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
'    Selection.Borders(xlEdgeRight).LineStyle = xlNone
'    With Selection.Borders(xlInsideHorizontal)
'        .LineStyle = xlContinuous
'        .Color = -16744448
'        .TintAndShade = 0
'        .Weight = xlHairline
'    End With
'
'    For i = 4 To lDetailRows
'        If Sheet13.Cells(i, 6) = "期初余额" Or Sheet13.Cells(i, 6) = "本日合计" Or Sheet13.Cells(i, 6) = "本期合计" Or Sheet13.Cells(i, 6) = "本年累计" Or Sheet13.Cells(i, 6) = "结转下年" Then
'            Sheet13.Cells(i, 6).Select
'            With Selection
'                .HorizontalAlignment = xlCenter
'                .VerticalAlignment = xlCenter
'                .WrapText = False
'                .Orientation = 0
'                .AddIndent = False
'                .IndentLevel = 0
'                .ShrinkToFit = False
'                .ReadingOrder = xlContext
'                .MergeCells = False
'            End With
'            With Selection.Font
'            .Color = -16776961
'            .TintAndShade = 0
'            End With
'        End If
'
'        If Sheet13.Cells(i, 6) = "本年累计" Then
'        Sheet13.Range("B" & i & ":" & "K" & i).Select
'        Selection.Borders(xlDiagonalDown).LineStyle = xlNone
'        Selection.Borders(xlDiagonalUp).LineStyle = xlNone
'        Selection.Borders(xlEdgeLeft).LineStyle = xlNone
'        With Selection.Borders(xlEdgeTop)
'            .LineStyle = xlContinuous
'            .Color = -16776961
'            .TintAndShade = 0
'            .Weight = xlThin
'        End With
'        With Selection.Borders(xlEdgeBottom)
'            .LineStyle = xlContinuous
'            .Color = -16776961
'            .TintAndShade = 0
'            .Weight = xlThin
'        End With
'        End If
'    Next
'
'End Sub

'Public Sub clearDetailColor()
'
''    Dim lCurrentRows As Long
''    lCurrentRows = Sheet13.Cells(Rows.Count, 2).End(xlUp).Row
''
''    Sheet13.Range("F4:F" & lCurrentRows).Select
''    With Selection.Font
''        .ColorIndex = xlAutomatic
''        .TintAndShade = 0
''    End With
''    With Selection
''        .HorizontalAlignment = xlLeft
''        .VerticalAlignment = xlCenter
''        .WrapText = False
''        .Orientation = 0
''        .AddIndent = False
''        .IndentLevel = 0
''        .ShrinkToFit = False
''        .ReadingOrder = xlContext
''        .MergeCells = False
''    End With
''
''    Sheet13.Range("B4:K" & lCurrentRows).Select
''    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
''    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
''    Selection.Borders(xlEdgeLeft).LineStyle = xlNone
''    With Selection.Borders(xlEdgeTop)
''        .LineStyle = xlContinuous
''        .Color = -16776961
''        .TintAndShade = 0
''        .Weight = xlThin
''    End With
''    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
''    Selection.Borders(xlEdgeRight).LineStyle = xlNone
''    Selection.Borders(xlInsideVertical).LineStyle = xlNone
''    Selection.Borders(xlInsideHorizontal).LineStyle = xlNone
'
'End Sub

'Public Sub clearDetailData()
'
'    Dim lCurrentRows As Long
'    lcurrentrow = Sheet13.Cells(Rows.Count, 2).End(xlUp).Row
'
'    If lDetailRows > 3 Then
'    Sheet13.Range("B4:K" & lCurrentRows).Select
'    With Selection.Interior
'            .Pattern = xlNone
'            .TintAndShade = 0
'            .PatternTintAndShade = 0
'    End With
'    Selection.ClearContents
'    End If
'
'    Sheet13.Cells(2, 3) = ""
'
'End Sub

'Public Sub calDetailData()
'
'    Dim iCurrentRows As Integer
'    iCurrentRows = Sheet13.Cells(Rows.Count, 2).End(xlUp).Row
''先计算余额
'    If iCurrentRows > 4 Then
'        For i = 5 To iCurrentRows
'
'        If Sheet13.Cells(i, 5) <> "" Then
'            Sheet13.Cells(i, 11) = Sheet13.Cells(i - 1, 11) + Sheet13.Cells(i, 8) - Sheet13.Cells(i, 9)
'        Else
'            Sheet13.Cells(i, 11) = Sheet13.Cells(i - 1, 11)
'        End If
'        Next
'    End If
''计算借贷方向，让负数变正数
'    If iCurrentRows > 4 Then
'        For i = 5 To iCurrentRows
'
'        If Sheet13.Cells(i, 11) > 0 Then
'            Sheet13.Cells(i, 10) = "借"
'        ElseIf Sheet13.Cells(i, 11) = 0 Then
'            Sheet13.Cells(i, 10) = "平"
'        Else
'            Sheet13.Cells(i, 10) = "贷"
'            Sheet13.Cells(i, 11) = Sheet13.Cells(i, 11) * -1
'        End If
'        Next
'    End If
'
'End Sub

Attribute VB_Name = "Ledger"
Sub ClearLedgerColor()

    Dim lLedgerRows As Long
    lLedgerRows = Sheet14.Cells(Rows.Count, 2).End(xlUp).Row

    Sheet14.Range("B4:H" & lLedgerRows).Select
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    Selection.Borders(xlEdgeLeft).LineStyle = xlNone
    
    With Selection.Borders(xlEdgeTop)
        .LineStyle = xlContinuous
        .Color = -16776961
        .TintAndShade = 0
        .Weight = xlThin
    End With
    
    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
    Selection.Borders(xlEdgeRight).LineStyle = xlNone
    Selection.Borders(xlInsideVertical).LineStyle = xlNone
    Selection.Borders(xlInsideHorizontal).LineStyle = xlNone
    
End Sub
Sub ClearLedgerData()

    Dim lLedgerRows As Long
    lLedgerRows = Sheet14.Cells(Rows.Count, 2).End(xlUp).Row

    If lLedgerRows >= 4 Then
    Sheet14.Activate
    Sheet14.Range("B4:H" & lLedgerRows).Select
    With Selection.Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
    End With
    Selection.ClearContents
    End If

End Sub
Sub SetLedgerColor()

    Dim lLedgerRows As Long
    Dim lineColor
    Dim beginColor
    Dim monthColor
    Dim yearColor
    
    lLedgerRows = Sheet14.Cells(Rows.Count, 2).End(xlUp).Row
    lineColor = Sheet2.Cells(3, 9).Interior.Color
    beginColor = Sheet2.Cells(4, 9).Interior.Color
    periodColor = Sheet2.Cells(5, 9).Interior.Color
    monthColor = Sheet2.Cells(6, 9).Interior.Color
    yearColor = Sheet2.Cells(7, 9).Interior.Color
    

    Sheet14.Range("B3:H" & lLedgerRows).Select
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    With Selection.Borders(xlEdgeLeft)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeTop)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeBottom)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeRight)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideVertical)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideHorizontal)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    
    For l = 4 To lLedgerRows
    If Sheet14.Cells(l, 4) = "年初余额" Then
        Range("B" & l & ":" & "H" & l).Select
            With Selection.Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = beginColor
            .TintAndShade = 0
            .PatternTintAndShade = 0
            End With
    ElseIf Sheet14.Cells(l, 4) = "期初余额" Then
        Range("B" & l & ":" & "H" & l).Select
            With Selection.Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = periodColor
            .TintAndShade = 0
            .PatternTintAndShade = 0
            End With
    ElseIf Sheet14.Cells(l, 4) = "本期合计" Then
        Range("B" & l & ":" & "H" & l).Select
            With Selection.Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = monthColor
            .TintAndShade = 0
            .PatternTintAndShade = 0
            End With
    ElseIf Sheet14.Cells(l, 4) = "本年累计" Then
        Range("B" & l & ":" & "H" & l).Select
            With Selection.Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = yearColor
            .TintAndShade = 0
            .PatternTintAndShade = 0
            End With
    End If
    Next
    
End Sub
Sub CalLedgerData()

    Dim lLedgerRows As Integer
    Dim strAccNum As String
    Dim strShowName As String
    Dim dblAmount As Double
    Dim strCord As String
    
    lLedgerRows = Sheet14.Cells(Rows.Count, 2).End(xlUp).Row
    strAccNum = Left(Sheet14.Cells(2, 2), 4)
    
    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
        strCord = Sheet12.Cells(lAccRow, 6)
    Else
        lAccRow = 0
    End If
        
    If lLedgerRows >= 5 Then
        For l = 5 To lLedgerRows
            If Sheet14.Cells(l, 4) = "本月合计" Then
                If Sheet14.Cells(l - 1, 7) = "借" Then
                    dblAmount = Sheet14.Cells(l - 1, 8) + Sheet14.Cells(l, 5) - Sheet14.Cells(l, 6)
                    If dblAmount > 0 Then
                        Sheet14.Cells(l, 7) = "借"
                        Sheet14.Cells(l, 8) = dblAmount
                    ElseIf dblAmount < 0 Then
                         Sheet14.Cells(l, 7) = "贷"
                         Sheet14.Cells(l, 8) = dblAmount * -1
                    Else
                        Sheet14.Cells(l, 7) = "平"
                        Sheet14.Cells(l, 8) = 0
                    End If
                ElseIf Sheet14.Cells(l - 1, 7) = "贷" Then
                    dblAmount = Sheet14.Cells(l - 1, 8) - Sheet14.Cells(l, 5) + Sheet14.Cells(l, 6)
                    If dblAmount > 0 Then
                        Sheet14.Cells(l, 7) = "贷"
                        Sheet14.Cells(l, 8) = dblAmount
                    ElseIf dblAmount < 0 Then
                         Sheet14.Cells(l, 7) = "借"
                         Sheet14.Cells(l, 8) = dblAmount * -1
                    Else
                        Sheet14.Cells(l, 7) = "平"
                        Sheet14.Cells(l, 8) = 0
                    End If
                Else
                    If strCord = "借方" Then
                        dblAmount = Sheet14.Cells(l - 1, 8) + Sheet14.Cells(l, 5) - Sheet14.Cells(l, 6)
                        If dblAmount > 0 Then
                            Sheet14.Cells(l, 7) = "借"
                            Sheet14.Cells(l, 8) = dblAmount
                        ElseIf dblAmount < 0 Then
                             Sheet14.Cells(l, 7) = "贷"
                             Sheet14.Cells(l, 8) = dblAmount * -1
                        Else
                            Sheet14.Cells(l, 7) = "平"
                            Sheet14.Cells(l, 9) = 0
                        End If
                    Else
                        dblAmount = Sheet14.Cells(l - 1, 8) - Sheet14.Cells(l, 5) + Sheet14.Cells(l, 6)
                        If dblAmount > 0 Then
                            Sheet14.Cells(l, 7) = "贷"
                            Sheet14.Cells(l, 8) = dblAmount
                        ElseIf dblAmount < 0 Then
                             Sheet14.Cells(l, 7) = "借"
                             Sheet14.Cells(l, 8) = dblAmount * -1
                        Else
                            Sheet14.Cells(l, 7) = "平"
                            Sheet14.Cells(l, 8) = 0
                        End If
                    End If
                End If
            Else
                Sheet14.Cells(l, 7) = Sheet14.Cells(l - 1, 7)
                Sheet14.Cells(l, 8) = Sheet14.Cells(l - 1, 8)
            End If
        Next
    End If
    
End Sub
Attribute VB_Name = "Main"
Sub MainVchInput()
    Sheet5.Visible = xlSheetVisible
    Sheet5.Activate
End Sub
Sub MainAccount()
    Sheet12.Visible = xlSheetVisible
    Sheet12.Activate
End Sub
Sub MainVchManager()
    Sheet17.Visible = xlSheetVisible
    Sheet17.Activate
End Sub
Sub MainDetail()
    Sheet13.Visible = xlSheetVisible
    Sheet13.Activate
End Sub
Sub MainReg()
    frm_Reg.Show
End Sub
Sub MainSetting()
    Sheet15.Visible = xlSheetVisible
    Sheet15.Activate
End Sub
Sub MainBalance()
    Sheet10.Visible = xlSheetVisible
    Sheet10.Activate
End Sub
Sub MainProfit()
    Sheet11.Visible = xlSheetVisible
    Sheet11.Activate
End Sub
Sub MainLedger()
    Sheet14.Visible = xlSheetVisible
    Sheet14.Activate
End Sub
Sub MainSubject()
    Sheet8.Visible = xlSheetVisible
    Sheet8.Activate
End Sub
Sub MainColorSetting()
    Sheet2.Visible = xlSheetVisible
    Sheet2.Activate
End Sub
Sub MainPrintSetting()
    Sheet16.Visible = xlSheetVisible
    Sheet16.Activate
End Sub
Sub MainSettle()
    frm_Settle.Show
End Sub
Sub MainEndVch()
    frm_EndVch.Show
End Sub
Sub MainWait()
    MsgBox "快狗提示：该功能将在以后版本推出！"
End Sub
Public Sub Hide()
 ActiveSheet.Visible = xlSheetHidden
 Sheet1.Activate
End Sub

Attribute VB_Name = "PublicSet"
Option Explicit

Public iBeginYear As Integer    '启用会计年度
Public iBeginPeriod As Integer     '业务开始期间
Public iOpenPeriod As Integer      '启用会计期间
Public iCurrentYear As Integer      '当期会计年度
Public iCurrentPeriod As Integer    '当前会计期间
Public iInitStatus As Integer      '初始化状态
Public iVoucherError As Integer    '凭证错误原因
Public iAccountEdit As Integer       '科目编辑状态
Public iVoucherEdit As Integer       '凭证编辑状态
Public iReportYear As Integer '报表取数年份
Public iReportPeriod As Integer '报表取数期间

Attribute VB_Name = "Report"
''期初取数
'Function QC(strAccNum As String, iPeriod As Integer) As Double
'    Application.Volatile
'    Dim dblAmount As Double
'    Dim lAccRow As Long
'
'    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
'    If Not r Is Nothing Then
'        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
'    Else
'        lAccRow = 0
'    End If
'
'    iBeginYear = GetBeginYear()
'    iBeginPeriod = GetBeginPeriod()
'
'    If iReportYear = iBeginYear Then
'        If iPeriod = 1 Then
'            If iBeginPeriod = 1 Then
'                dblAmount = Sheet12.Cells(lAccRow, 10)
'            Else
'                dblAmount = 0
'            End If
'        Else
'            dblAmount = Sheet12.Cells(lAccRow, 14)
'        End If
'    Else
'        If iPeriod = 1 Then
'            dblAmount = Sheet12.Cells(lAccRow, 13) + Sheet12.Cells(lAccRow, 15)
'        Else
'            dblAmount = Sheet12.Cells(lAccRow, 14)
'        End If
'    End If
'
'    QC = Round(dblAmount, 2)
'
'End Function
''期末取数
'Function QM(strAccNum As String, iPeriod As Integer) As Currency
'    Application.Volatile
'    Dim dblEndAmount As Double
'    Dim dblAmount As Double
'    Dim strCord As String
'    Dim n As Integer
'    Dim lAccRow As Long
'
'    If iPeriod = 0 Or str(iPeriod) = "" Then
'        iPeriod = iReportPeriod
'    End If
'
'    iBeginPeriod = GetBeginPeriod()
'    dblAmount = 0
'
'
'
'    Set r = Sheet12.Columns("A:A").Find(strAccNum, LookAt:=xlWhole)
'    If Not r Is Nothing Then
'        lAccRow = Sheet12.Columns("A:A").Find(strAccNum, LookAt:=xlWhole).Row
'    Else
'        lAccRow = 0
'    End If
'
'    If lAccRow = 0 Then
'        dblAmount = 0
'    Else
'        If iBeginPeriod = 1 Then
'            If iPeriod = 1 Then
'                dblEndAmount = Sheet12.Cells(lAccRow, 12)
'                dblAmount = dblEndAmount
'            Else
'                dblEndAmount = Sheet12.Cells(lAccRow, 12)
'                dblAmount = dblEndAmount
'                For i = 2 To iPeriod
'                    If Sheet12.Cells(lAccRow, 5) = "借方" Then
'                        dblAmount = dblAmount + Sheet12.Cells(lAccRow, 11 + 2 * i) - Sheet12.Cells(lAccRow, 12 + 2 * i)
'                    Else
'                        dblAmount = dblAmount - Sheet12.Cells(lAccRow, 11 + 2 * i) + Sheet12.Cells(lAccRow, 12 + 2 * i)
'                    End If
'                Next
'            End If
'        Else
'            If iPeriod < iBeginPeriod Then
'                dblAmount = 0
'            Else
'                dblEndAmount = Sheet12.Cells(lAccRow, 12)
'                dblAmount = dblEndAmount
'                For i = iBeginPeriod To iPeriod
'                    If Sheet12.Cells(lAccRow, 5) = "借方" Then
'                        dblAmount = dblAmount + Sheet12.Cells(lAccRow, 11 + 2 * i) - Sheet12.Cells(lAccRow, 12 + 2 * i)
'                    Else
'                        dblAmount = dblAmount - Sheet12.Cells(lAccRow, 11 + 2 * i) + Sheet12.Cells(lAccRow, 12 + 2 * i)
'                    End If
'                Next
'            End If
'        End If
'    End If
'
'    QM = Round(dblAmount, 2)
'
'End Function
''借方发生取数
'Function JF(strAccNum As String, iPeriod As Integer) As Currency
'    Application.Volatile
'    Dim dblAmount As Double
'
'    If iPeriod = 0 Or str(iPeriod) = "" Then
'        iPeriod = iReportPeriod
'    End If
'
'    dblAmount = 0
'
'    Dim lAccRow As Long
'
'    Set r = Sheet12.Columns("A:A").Find(strAccNum, LookAt:=xlWhole)
'    If Not r Is Nothing Then
'        lAccRow = Sheet12.Columns("A:A").Find(strAccNum, LookAt:=xlWhole).Row
'    Else
'        lAccRow = 0
'    End If
'
'    If lAccRow = 0 Then
'        dblAmount = 0
'    Else
'        dblAmount = Sheet12.Cells(lAccRow, 11 + iPeriod * 2)
'    End If
'
'    JF = Round(dblAmount, 2)
'
'End Function
'贷方发生取数
'Function DF(strAccNum As String, iPeriod As Integer) As Currency
'
'    Application.Volatile
'    Dim dblAmount As Currency
'
'    If iPeriod = 0 Or str(iPeriod) = "" Then
'        iPeriod = iReportPeriod
'    End If
'
'    dblAmount = 0
'
'    Dim lAccRow As Long
'
'    Set r = Sheet12.Columns("A:A").Find(strAccNum, LookAt:=xlWhole)
'    If Not r Is Nothing Then
'        lAccRow = Sheet12.Columns("A:A").Find(strAccNum, LookAt:=xlWhole).Row
'    Else
'        lAccRow = 0
'    End If
'
'    If lAccRow = 0 Then
'        dblAmount = 0
'    Else
'        dblAmount = Sheet12.Cells(lAccRow, 12 + iPeriod * 2)
'    End If
'
'    DF = Round(dblAmount, 2)
'
'End Function
'借方累计取数
Function QC(strAccNum As String, iYear As Integer, iPeriod As Integer)

    Application.Volatile
    Dim dblInitBeginBal As Double
    Dim dblInitEndBal As Double
    Dim dblAmount As Double
    Dim dblYearAmount As Double
    Dim dblVchAmount As Double
    Dim lVchRows As Long
    Dim lAccRow As Long
    Dim iIsLastLevel As Integer
    Dim strCord As String
    Dim n As Integer
    
    iBeginYear = GetBeginYear()
    iOpenPeriod = GetOpenPeriod()
    iBeginPeriod = GetBeginPeriod()
    dblInitBeginBal = 0
    dblInitEndBal = 0
    dblAmount = 0
    dblYearAmount = 0
    dblVchAmount = 0
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    
    If iPeriod = 0 Or str(iPeriod) = "" Then
        iPeriod = iReportPeriod
    End If
    
    If iYear = 0 Or str(iYear) = "" Then
        iYear = iReportYear
    End If
    
    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
    Else
        lAccRow = 0
    End If
    
    If lAccRow > 0 Then
        strCord = Sheet12.Cells(lAccRow, 6)
        iIsLastLevel = Sheet12.Cells(lAccRow, 8)
        dblInitEndBal = Sheet12.Cells(lAccRow, 13)
        dblInitBeginBal = Sheet12.Cells(lAccRow, 10)
    End If
    
    If iYear = iBeginYear Then
        If iPeriod = 1 Then
            If iBeginPeriod = 1 Then
                dblAmount = dblInitBeginBal
            Else
                dblAmount = 0
            End If
        Else
            For l = 3 To lVchRows
                If Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) < iPeriod Then
                    If iIsLastLevel = 1 Then
                        If Sheet17.Cells(l, 9) = strAccNum Then
                            If lAccRow > 0 Then
                                If strCord = "借方" Then
                                    dblVchAmount = dblVchAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                                Else
                                    dblVchAmount = dblVchAmount + Sheet17.Cells(l, 12) - Sheet17.Cells(l, 11)
                                End If
                            End If
                        End If
                    Else
                        n = VBA.Len(strAccNum)
                        If Left(Sheet17.Cells(l, 9), n) = strAccNum Then
                            If lAccRow > 0 Then
                                If strCord = "借方" Then
                                    dblVchAmount = dblVchAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                                Else
                                    dblVchAmount = dblVchAmount + Sheet17.Cells(l, 12) - Sheet17.Cells(l, 11)
                                End If
                            End If
                        End If
                    End If
                End If
            Next
            dblAmount = dblInitEndBal + dblVchAmount
        End If
    ElseIf iYear > iBeginYear Then
        For l = 3 To lVchRows
            If Sheet17.Cells(l, 2) < iYear Then
                If iIsLastLevel = 1 Then
                    If Sheet17.Cells(l, 9) = strAccNum Then
                        If lAccRow > 0 Then
                            If strCord = "借方" Then
                                dblYearAmount = dblYearAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                            Else
                                dblYearAmount = dblYearAmount - Sheet17.Cells(l, 11) + Sheet17.Cells(l, 12)
                            End If
                        End If
                    End If
                Else
                    n = VBA.Len(strAccNum)
                    If Left(Sheet17.Cells(l, 9), n) = strAccNum Then
                        If lAccRow > 0 Then
                            If strCord = "借方" Then
                                dblYearAmount = dblYearAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                            Else
                                dblYearAmount = dblYearAmount - Sheet17.Cells(l, 11) + Sheet17.Cells(l, 12)
                            End If
                        End If
                    End If
                End If
            ElseIf Sheet17.Cells(l, 2) = iYear Then
                If Sheet17.Cells(l, 3) < iPeriod Then
                    If iIsLastLevel = 1 Then
                        If Sheet17.Cells(l, 9) = strAccNum Then
                            If lAccRow > 0 Then
                                If strCord = "借方" Then
                                    dblVchAmount = dblVchAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                                Else
                                    dblVchAmount = dblVchAmount + Sheet17.Cells(l, 12) - Sheet17.Cells(l, 11)
                                End If
                            End If
                        End If
                    Else
                        n = VBA.Len(strAccNum)
                        If Left(Sheet17.Cells(l, 9), 4) = strAccNum Then
                            If lAccRow > 0 Then
                                If strCord = "借方" Then
                                    dblVchAmount = dblVchAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                                Else
                                    dblVchAmount = dblVchAmount + Sheet17.Cells(l, 12) - Sheet17.Cells(l, 11)
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        Next
        dblAmount = dblInitEndBal + dblYearAmount + dblVchAmount
    End If
    
    QC = Round(dblAmount, 2)
   
End Function
Function QM(strAccNum As String, iYear As Integer, iPeriod As Integer)

    Application.Volatile
    Dim dblInitBeginBal As Double
    Dim dblInitEndBal As Double
    Dim dblAmount As Double
    Dim dblYearAmount As Double
    Dim dblVchAmount As Double
    Dim lVchRows As Long
    Dim lAccRow As Long
    Dim iIsLastLevel As Integer
    Dim strCord As String
    Dim n As Integer
    
    iBeginYear = GetBeginYear()
    iOpenPeriod = GetOpenPeriod()
    iBeginPeriod = GetBeginPeriod()
    dblInitBeginBal = 0
    dblInitEndBal = 0
    dblAmount = 0
    dblYearAmount = 0
    dblVchAmount = 0
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    
    If iPeriod = 0 Or str(iPeriod) = "" Then
        iPeriod = iReportPeriod
    End If
    
    If iYear = 0 Or str(iYear) = "" Then
        iYear = iReportYear
    End If
    
    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
    Else
        lAccRow = 0
    End If
    
    If lAccRow > 0 Then
        strCord = Sheet12.Cells(lAccRow, 6)
        iIsLastLevel = Sheet12.Cells(lAccRow, 8)
        dblInitEndBal = Sheet12.Cells(lAccRow, 13)
        dblInitBeginBal = Sheet12.Cells(lAccRow, 10)
    End If
    
    If iYear = iBeginYear Then
        For l = 3 To lVchRows
            If Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) <= iPeriod Then
                If iIsLastLevel = 1 Then
                    If Sheet17.Cells(l, 9) = strAccNum Then
                        If lAccRow > 0 Then
                            If strCord = "借方" Then
                                dblVchAmount = dblVchAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                            Else
                                dblVchAmount = dblVchAmount + Sheet17.Cells(l, 12) - Sheet17.Cells(l, 11)
                            End If
                        End If
                    End If
                Else
                    n = VBA.Len(strAccNum)
                    If Left(Sheet17.Cells(l, 9), n) = strAccNum Then
                        If lAccRow > 0 Then
                            If strCord = "借方" Then
                                dblVchAmount = dblVchAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                            Else
                                dblVchAmount = dblVchAmount + Sheet17.Cells(l, 12) - Sheet17.Cells(l, 11)
                            End If
                        End If
                    End If
                End If
            End If
        Next
        dblAmount = dblInitEndBal + dblVchAmount
    ElseIf iYear > iBeginYear Then
        For l = 3 To lVchRows
            If Sheet17.Cells(l, 2) < iYear Then
                If iIsLastLevel = 1 Then
                    If Sheet17.Cells(l, 9) = strAccNum Then
                        If lAccRow > 0 Then
                            If strCord = "借方" Then
                                dblYearAmount = dblYearAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                            Else
                                dblYearAmount = dblYearAmount - Sheet17.Cells(l, 11) + Sheet17.Cells(l, 12)
                            End If
                        End If
                    End If
                Else
                    n = VBA.Len(strAccNum)
                    If Left(Sheet17.Cells(l, 9), n) = strAccNum Then
                        If lAccRow > 0 Then
                            If strCord = "借方" Then
                                dblYearAmount = dblYearAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                            Else
                                dblYearAmount = dblYearAmount - Sheet17.Cells(l, 11) + Sheet17.Cells(l, 12)
                            End If
                        End If
                    End If
                End If
            ElseIf Sheet17.Cells(l, 2) = iYear Then
                If Sheet17.Cells(l, 3) <= iPeriod Then
                    If iIsLastLevel = 1 Then
                        If Sheet17.Cells(l, 9) = strAccNum Then
                            If lAccRow > 0 Then
                                If strCord = "借方" Then
                                    dblVchAmount = dblVchAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                                Else
                                    dblVchAmount = dblVchAmount + Sheet17.Cells(l, 12) - Sheet17.Cells(l, 11)
                                End If
                            End If
                        End If
                    Else
                        n = VBA.Len(strAccNum)
                        If Left(Sheet17.Cells(l, 9), 4) = strAccNum Then
                            If lAccRow > 0 Then
                                If strCord = "借方" Then
                                    dblVchAmount = dblVchAmount + Sheet17.Cells(l, 11) - Sheet17.Cells(l, 12)
                                Else
                                    dblVchAmount = dblVchAmount + Sheet17.Cells(l, 12) - Sheet17.Cells(l, 11)
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        Next
        dblAmount = dblInitEndBal + dblYearAmount + dblVchAmount
    End If
    
    QM = Round(dblAmount, 2)
   
End Function
Function JF(strAccNum As String, iYear As Integer, iPeriod As Integer)

    Application.Volatile
    Dim dblAmount As Double
    Dim dblVchAmount As Double
    Dim lVchRows As Long
    Dim lAccRow As Long
    Dim iIsLastLevel As Integer
    Dim strCord As String
    Dim n As Integer

    If iPeriod = 0 Or str(iPeriod) = "" Then
        iPeriod = iReportPeriod
    End If
    
    If iYear = 0 Or str(iYear) = "" Then
        iYear = iReportYear
    End If

    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
    Else
        lAccRow = 0
    End If
    
    If lAccRow > 0 Then
        iIsLastLevel = Sheet12.Cells(lAccRow, 8)
    End If
    
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row

    For l = 3 To lVchRows
        If Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) = iPeriod Then
            If iIsLastLevel = 1 Then
                If Sheet17.Cells(l, 9) = strAccNum Then
                    If lAccRow > 0 Then
                        dblVchAmount = dblVchAmount + Sheet17.Cells(l, 11)
                    End If
                End If
            Else
                n = VBA.Len(strAccNum)
                If Left(Sheet17.Cells(l, 9), n) = strAccNum Then
                    If lAccRow > 0 Then
                        dblVchAmount = dblVchAmount + Sheet17.Cells(l, 11)
                    End If
                End If
            End If
        End If
    Next

    dblAmount = dblVchAmount
    JF = Round(dblAmount, 2)

End Function
Function DF(strAccNum As String, iYear As Integer, iPeriod As Integer)

    Application.Volatile
    Dim dblAmount As Double
    Dim dblVchAmount As Double
    Dim lVchRows As Long
    Dim lAccRow As Long
    Dim iIsLastLevel As Integer
    Dim strCord As String
    Dim n As Integer

    If iPeriod = 0 Or str(iPeriod) = "" Then
        iPeriod = iReportPeriod
    End If
    
    If iYear = 0 Or str(iYear) = "" Then
        iYear = iReportYear
    End If

    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
    Else
        lAccRow = 0
    End If
    
    If lAccRow > 0 Then
        iIsLastLevel = Sheet12.Cells(lAccRow, 8)
    End If
    
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row

    For l = 3 To lVchRows
        If Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) = iPeriod Then
            If iIsLastLevel = 1 Then
                If Sheet17.Cells(l, 9) = strAccNum Then
                    If lAccRow > 0 Then
                        dblVchAmount = dblVchAmount + Sheet17.Cells(l, 12)
                    End If
                End If
            Else
                n = VBA.Len(strAccNum)
                If Left(Sheet17.Cells(l, 9), n) = strAccNum Then
                    If lAccRow > 0 Then
                        dblVchAmount = dblVchAmount + Sheet17.Cells(l, 12)
                    End If
                End If
            End If
        End If
    Next

    dblAmount = dblVchAmount
    DF = Round(dblAmount, 2)

End Function
Function JL(strAccNum As String, iYear As Integer, iPeriod As Integer)

    Application.Volatile
    Dim dblAmount As Double
    Dim dblVchAmount As Double
    Dim dblInitDebitAmount As Double
    Dim lVchRows As Long
    Dim lAccRow As Long
    Dim iIsLastLevel As Integer
    Dim strCord As String
    Dim n As Integer
    Dim iBeginYear As Integer
    Dim iBeginPeriod As Integer

    If iPeriod = 0 Or str(iPeriod) = "" Then
        iPeriod = iReportPeriod
    End If
    
    If iYear = 0 Or str(iYear) = "" Then
        iYear = iReportYear
    End If
    
    iBeginYear = GetBeginYear()
    iBeginPeriod = GetBeginPeriod()

    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
    Else
        lAccRow = 0
    End If
    
    If lAccRow > 0 Then
        iIsLastLevel = Sheet12.Cells(lAccRow, 8)
        dblInitDebitAmount = CDbl(Sheet12.Cells(lAccRow, 11))
    End If
    
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row

    For l = 3 To lVchRows
        If Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) <= iPeriod Then
            If iIsLastLevel = 1 Then
                If Sheet17.Cells(l, 9) = strAccNum Then
                    If lAccRow > 0 Then
                        dblVchAmount = dblVchAmount + Sheet17.Cells(l, 11)
                    End If
                End If
            Else
                n = VBA.Len(strAccNum)
                If Left(Sheet17.Cells(l, 9), n) = strAccNum Then
                    If lAccRow > 0 Then
                        dblVchAmount = dblVchAmount + Sheet17.Cells(l, 11)
                    End If
                End If
            End If
        End If
    Next
    
    If iYear = iBeginYear Then
        If iPeriod < iBeginPeriod Then
            dblAmount = 0
        Else
            dblAmount = dblVchAmount + dblInitDebitAmount
        End If
    Else
        dblAmount = dblVchAmount
    End If
    
    JL = Round(dblAmount, 2)

End Function
Function DL(strAccNum As String, iYear As Integer, iPeriod As Integer)

    Application.Volatile
    Dim dblAmount As Double
    Dim dblVchAmount As Double
    Dim dblInitCreditAmount As Double
    Dim lVchRows As Long
    Dim lAccRow As Long
    Dim iIsLastLevel As Integer
    Dim strCord As String
    Dim n As Integer
    Dim iBeginYear As Integer
    Dim iBeginPeriod As Integer

    If iPeriod = 0 Or str(iPeriod) = "" Then
        iPeriod = iReportPeriod
    End If
    
    If iYear = 0 Or str(iYear) = "" Then
        iYear = iReportYear
    End If
    
    iBeginYear = GetBeginYear()
    iBeginPeriod = GetBeginPeriod()

    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
    Else
        lAccRow = 0
    End If
    
    If lAccRow > 0 Then
        iIsLastLevel = Sheet12.Cells(lAccRow, 8)
        dblInitCreditAmount = CDbl(Sheet12.Cells(lAccRow, 12))
    End If
    
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row

    For l = 3 To lVchRows
        If Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) <= iPeriod Then
            If iIsLastLevel = 1 Then
                If Sheet17.Cells(l, 9) = strAccNum Then
                    If lAccRow > 0 Then
                        dblVchAmount = dblVchAmount + Sheet17.Cells(l, 12)
                    End If
                End If
            Else
                n = VBA.Len(strAccNum)
                If Left(Sheet17.Cells(l, 9), n) = strAccNum Then
                    If lAccRow > 0 Then
                        dblVchAmount = dblVchAmount + Sheet17.Cells(l, 12)
                    End If
                End If
            End If
        End If
    Next
    
    If iYear = iBeginYear Then
        If iPeriod < iBeginPeriod Then
            dblAmount = 0
        Else
            dblAmount = dblVchAmount + dblInitCreditAmount
        End If
    Else
        dblAmount = dblVchAmount
    End If
    
    DL = Round(dblAmount, 2)

End Function

Attribute VB_Name = "Setting"
Public Function GetInitStatus()

  iInitStatus = CInt(Sheet15.Cells(8, 3))
  GetInitStatus = iInitStatus
  
End Function
Public Function GetCurrentYear()

    iCurrentYear = CInt(Sheet15.Cells(5, 3))
    GetCurrentYear = iCurrentYear

End Function
Public Function GetCurrentPeriod()

    iCurrentPeriod = CInt(Sheet15.Cells(6, 3))
    GetCurrentPeriod = iCurrentPeriod

End Function
Public Function GetOpenPeriod()

    iOpenPeriod = CInt(Sheet15.Cells(4, 3))
    GetOpenPeriod = iOpenPeriod

End Function
Public Function GetBeginYear()

    iBeginYear = CInt(Sheet15.Cells(2, 3))
    GetBeginYear = iBeginYear

End Function
Public Function GetBeginPeriod()

    iBeginPeriod = CInt(Sheet15.Cells(3, 3))
    GetBeginPeriod = iBeginPeriod

End Function
Public Function GetMaxDate(iYear As Integer, iPeriod As Integer)
    Dim dteNow, dteMaxDate As Date

    If iPeriod < 12 Then
        dteNow = (CDate(iYear & "-" & iPeriod + 1))
        dteMaxDate = DateAdd("d", -1, dteNow)
    Else
        dteMaxDate = (CDate(iYear & "-" & iPeriod & "-" & 31))
    End If

    GetMaxDate = dteMaxDate

End Function
Public Function GetMinDate(iYear As Integer, iPeriod As Integer)
    Dim dteMinDate As Date

        dteMinDate = (CDate(iYear & "-" & iPeriod))

    GetMinDate = dteMinDate

End Function
Function cellcolor(back As Object) As String
'取RGB颜色值
Dim r As Long, g As Long, b As Long, cl As Long
cl = back.Interior.Color
r = cl Mod 256
g = (cl - r) / 256 Mod 256
b = (cl - r - g * 256) / 65536
cellcolor = "RGB(" & r & "," & g & "," & b & ")"
End Function
Attribute VB_Name = "Sheet1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub CommandButton1_Click()
Sheet11.Visible = xlSheetVisible
Sheet11.Activate
End Sub
Attribute VB_Name = "Sheet10"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "btn_SetReportPeriod, 3, 0, MSForms, CommandButton"
Attribute VB_Control = "btn_Back, 4, 1, MSForms, CommandButton"
Private Sub btn_Calculate_Click()
    Calculate
End Sub
Private Sub btn_Back_Click()

    Call Hide

End Sub

Private Sub btn_SetReportPeriod_Click()

    frm_CalBal.Show
    
End Sub

Attribute VB_Name = "Sheet11"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "btn_SetReportPeriod, 2, 0, MSForms, CommandButton"
Attribute VB_Control = "btn_Back, 3, 1, MSForms, CommandButton"
Private Sub btn_Back_Click()

    Call Hide
    
End Sub

Private Sub btn_SetReportPeriod_Click()

    frm_CalBal.Show

End Sub
Attribute VB_Name = "Sheet12"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "cmd_setColor, 41, 1, MSForms, CommandButton"
Attribute VB_Control = "cmd_addAccount, 40, 2, MSForms, CommandButton"
Attribute VB_Control = "cmd_checkBalance, 39, 3, MSForms, CommandButton"
Attribute VB_Control = "cmd_Back, 47, 4, MSForms, CommandButton"
Private Sub btn_CalBal_Click()

    frm_CalBal.Show
    
End Sub

Private Sub cmd_addAccount_Click()

    frm_AccAdd.Show
    
End Sub
Private Sub cmd_Back_Click()

    Call Hide
    
End Sub

Private Sub cmd_balReCal_Click()

    frm_balReCal.Show

End Sub
Private Sub cmd_checkBalance_Click()
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    Call CalAccBeginBal
    
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
End Sub
Private Sub cmd_setColor_Click()
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    Call SetAccColor
    
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
End Sub

Attribute VB_Name = "Sheet13"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "btn_QUery, 1, 1, MSForms, CommandButton"
Attribute VB_Control = "cmd_Back, 2, 2, MSForms, CommandButton"
Private Sub btn_Query_Click()

    frm_Detail.Show
    
End Sub
Private Sub cmd_Back_Click()

    Call Hide
    
End Sub
Attribute VB_Name = "Sheet14"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "cmd_Query, 2, 0, MSForms, CommandButton"
Attribute VB_Control = "btn_Back, 3, 1, MSForms, CommandButton"
Private Sub btn_Back_Click()

    Call Hide
    
End Sub
Private Sub cmd_Query_Click()

    frm_Ledger.Show

End Sub

Attribute VB_Name = "Sheet15"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "cmd_Back, 5, 0, MSForms, CommandButton"
Private Sub cmd_Back_Click()

    Call Hide
    
End Sub
Attribute VB_Name = "Sheet16"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "cmd_Back, 4, 0, MSForms, CommandButton"
Private Sub cmd_Back_Click()

    Call Hide
    
End Sub
Attribute VB_Name = "Sheet17"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "cmd_Back, 6, 0, MSForms, CommandButton"
Attribute VB_Control = "cmd_Post, 1, 1, MSForms, CommandButton"
Attribute VB_Control = "cmd_Check, 3, 2, MSForms, CommandButton"
Attribute VB_Control = "cmd_setColor, 7, 3, MSForms, CommandButton"
Attribute VB_Control = "btn_Sort, 10, 4, MSForms, CommandButton"
Private Sub btn_Sort_Click()

    Call SortVchListData
    
End Sub

Private Sub cmd_Back_Click()

    Call Hide

End Sub
Private Sub cmd_Check_Click()

    frm_Check.Show
    
End Sub
Private Sub cmd_Post_Click()

    frm_Post.Show
    
End Sub
Private Sub cmd_setColor_Click()
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    Call SetVchListColor
    
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
End Sub
Attribute VB_Name = "Sheet18"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "CommandButton1, 1, 0, MSForms, CommandButton"
Private Sub CommandButton1_Click()
    Sheet18.Cells(2, 2) = JFLJ("1001", 2019, 5)

End Sub
Sub test2()
  Dim r%, i%
  Dim arr, brr
  Dim d As Object
  Set d = CreateObject("scripting.dictionary")
  With Worksheets("Temp")
    r = .Cells(.Rows.Count, 1).End(xlUp).Row '行数
    arr = .Range("b2:k" & r) '范围
    For i = 1 To UBound(arr)
        If Not d.exists(arr(i, 1)) Then 'KEY值不存在
          ReDim brr(1 To 3) '重新定义brr
          brr(1) = arr(i, 1) 'brr第一个数字为 arr(i,1)
        Else

          d(arr(i, 1)) = brr
        End If
        
        If arr(i, 10) = 0 Then
          brr(2) = brr(2) + arr(i, 6)
          brr(3) = brr(3) + arr(i, 7)
        End If
        d(arr(i, 1)) = brr
    Next

    Sheets("Temp").Range("M1").Resize(d.Count, UBound(brr)) = Application.Transpose(Application.Transpose(d.items))
    Dim lTempMonthRows As Long
    Dim lTempDayRows As Long
    lTempMonthRows = .Cells(.Rows.Count, 14).End(xlUp).Row
    lTempDayRows = .Cells(.Rows.Count, 1).End(xlUp).Row
    If lTempMonthRows > 0 Then
        For x = 1 To lTempMonthRows
        MsgBox .Cells(x, 15)
        MsgBox .Cells(x, 16)
                .Cells(lTempDayRows + 1, 1) = ""
                .Cells(lTempDayRows + 1, 2) = .Cells(x, 13)
                .Cells(lTempDayRows + 1, 3) = ""
                .Cells(lTempDayRows + 1, 4) = ""
                .Cells(lTempDayRows + 1, 5) = ""
                .Cells(lTempDayRows + 1, 6) = "本月合计"
                .Cells(lTempDayRows + 1, 7) = .Cells(x, 14)
                .Cells(lTempDayRows + 1, 8) = .Cells(x, 15)
                .Cells(lTempDayRows + 1, 9) = ""
                .Cells(lTempDayRows + 1, 10) = ""
                .Cells(lTempDayRows + 1, 11) = 1
                lTempDayRows = lTempDayRows + 1
        Next
    End If
  End With
End Sub











Attribute VB_Name = "Sheet2"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "cmd_Back, 1, 1, MSForms, CommandButton"
Private Sub cmd_Back_Click()

    Call Hide
    
End Sub
Attribute VB_Name = "Sheet5"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "btn_Back, 46, 2, MSForms, CommandButton"
Attribute VB_Control = "btn_Add, 15, 3, MSForms, CommandButton"
Attribute VB_Control = "btn_Clear, 14, 4, MSForms, CommandButton"
Attribute VB_Control = "cmd_Save, 4, 5, MSForms, CommandButton"
Attribute VB_Control = "cmd_print, 47, 6, MSForms, CommandButton"
Private Sub btn_Add_Click()

    Call UnprotectVchData
    Call ClearVchData
    
    Dim iMaxVchNum As Integer
    iMaxVchNum = GetVchMaxNum
    dteVchMaxDate = GetVchMaxDate
    
    Sheet5.Cells(2, 12) = iMaxVchNum + 1
    Sheet5.Cells(2, 6) = dteVchMaxDate
    Sheet5.Cells(6, 3).Select
    
    Application.Calculation = xlCalculationAutomatic

End Sub
Private Sub btn_HideRow_Click()
Application.ScreenUpdating = False '关闭屏幕更新
Application.DisplayAlerts = False

    Rows("14:505").Select
    Selection.EntireRow.Hidden = True
    Rows("6:13").Select
    Selection.EntireRow.Hidden = False
    
Application.ScreenUpdating = True '关闭屏幕更新
Application.DisplayAlerts = True
End Sub
Private Sub btn_Back_Click()

    Call Hide
    
End Sub
Private Sub btn_Clear_Click()

    Call UnprotectVchData
    Call ClearVchData
    
End Sub

Private Sub cmd_Print_Click()

    Sheet9.Visible = xlSheetVisible
    Sheet9.Activate
    
End Sub

Private Sub cmd_Query_Click()

    frm_VchQuery.Show
    
End Sub
Private Sub cmd_Save_Click()
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual
   
    Dim dteDate As Date
    Dim iYear As Integer
    Dim iPeriod As Integer
    Dim strGroup As String
    Dim iNum As Integer
    Dim iAttachment As Integer
    Dim strExplanation As String
    Dim dblTotalDebit As Double
    Dim dblTotalCredit As Double
    Dim strMaker As String
    Dim iMaxRowNum As Integer
    
'变量赋值
    dteDate = Sheet5.Cells(2, 6)
    iYear = Year(dteDate)
    iPeriod = Month(dteDate)
    strGroup = Sheet5.Cells(2, 11)
    iNum = Sheet5.Cells(2, 12)
    iAttachment = Sheet5.Cells(3, 12)
    dblTotalDebit = Sheet5.Cells(506, 9)
    dblTotalCredit = Sheet5.Cells(506, 11)
    strMaker = Sheet5.Cells(507, 12)
    strExplanation = (Sheet5.Cells(6, 3))
    iMaxRowNum = GetMaxRowNum()
    
    Dim iRowNum As Integer
    Dim strAccNum As String
    Dim strAccName As String
    Dim strCord As String
    Dim dblDebitAmount As Double
    Dim dblCreditAmount As Double
    Dim dblAmount As Double
    
'不能保存当前期间以前的凭证
    iCurrentYear = GetCurrentYear()
    iCurrentPeriod = GetCurrentPeriod()
    
    If iYear < CInt(iCurrentYear) Then
        MsgBox ("不能保存以前期间的凭证！"): Exit Sub
    ElseIf iYear = CInt(iCurrentYear) And iPeriod < CInt(iCurrentPeriod) Then
        MsgBox ("不能保存以前期间的凭证！"): Exit Sub
    End If
    
'表头条件判断
    If Sheet5.Cells(2, 6) = "" Then
        MsgBox ("凭证日期为空，请重新输入！"): Exit Sub
    ElseIf Sheet5.Cells(2, 11) = "" Then
        MsgBox ("凭证字为空，请重新选择！"): Exit Sub
    ElseIf Sheet5.Cells(2, 12) = "" Then
        MsgBox ("凭证号为空，请重新输入！"): Exit Sub
    ElseIf Sheet5.Cells(507, 12) = "" Then
        MsgBox ("制单人为空，请重新输入！"): Exit Sub
    End If
    
'表体条件判断
    If Sheet5.Cells(6, 3) = "" Then
        MsgBox ("第一条分录的摘要不能为空，请输入"): Exit Sub
        Sheet5.Cells(6, 3).Select
    End If
'判断借贷方是否平
    If Sheet5.Cells(506, 9) <> Sheet5.Cells(506, 11) Then
       MsgBox ("凭证借贷不平，不能保存，请检查凭证！"): Exit Sub
    End If
'判断分录是否准确
    For i = 6 To iMaxRowNum + 5
        If Sheet5.Cells(i, 5) = "" And Sheet5.Cells(i, 2) <= iMaxRowNum + 5 Then
            MsgBox ("第" & Sheet5.Cells(i, 2) & "条分录科目为空，请检查！"): Exit Sub
        End If
        If Sheet5.Cells(i, 9) = "" And Sheet5.Cells(i, 11) = "" And Sheet5.Cells(i, 2) <= iMaxRowNum + 5 Then
            MsgBox ("第" & Sheet5.Cells(i, 2) & "条分录金额为空，请重新输入！"): Exit Sub
        End If
        If Sheet5.Cells(i, 9) <> 0 And Sheet5.Cells(i, 11) <> 0 Then
           MsgBox ("借贷方不能都有数据，请检查！"): Exit Sub
        End If
    Next
    
'保存数据
    
'判断凭证号是否重复
    Dim rstVoucherSet As New ADODB.Recordset
    Dim strGetNumSql As String
    strGetNumSql = "select * from [凭证管理$A2:R] where 会计年度=" & iYear & " and 会计期间 =" & iPeriod & " and 凭证字 =" & "'" & strGroup & "'" & " and  凭证号 =" & iNum & ""

        sqlOpen
        Set rstVoucherSet = getRecordset(strGetNumSql)

        If Not rstVoucherSet.EOF Then
                MsgBox ("凭证号已经存在，请重新输入凭证号!"): Exit Sub
        End If
        Set rstVoucherSet = Nothing
        sqlClose
    
 '保存凭证
    If Sheet17.FilterMode = True Then
        Sheet17.ShowAllData
    End If
    
    Sheet17.AutoFilterMode = False
    
    Dim lBillRows As Long
    lBillRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    With Sheet17
        For i = 6 To 6 + iMaxRowNum - 1
        iRowNum = Sheet5.Cells(i, 2)
        strExplanation = Sheet5.Cells(i, 3)
        strAccNum = Sheet5.Cells(i, 5)
        strAccName = Sheet5.Cells(i, 6)
        dblDebitAmount = IIf(Sheet5.Cells(i, 9) = "", 0, Sheet5.Cells(i, 9))
        dblCreditAmount = IIf(Sheet5.Cells(i, 11) = "", 0, Sheet5.Cells(i, 11))
    
       .Cells(lBillRows + 1, 2) = iYear
       .Cells(lBillRows + 1, 3) = iPeriod
       .Cells(lBillRows + 1, 4) = dteDate
       .Cells(lBillRows + 1, 5) = strGroup
       .Cells(lBillRows + 1, 6) = iNum
       .Cells(lBillRows + 1, 7) = iRowNum
       .Cells(lBillRows + 1, 8) = strExplanation
       .Cells(lBillRows + 1, 9) = strAccNum
       .Cells(lBillRows + 1, 10) = strAccName
       .Cells(lBillRows + 1, 11) = dblDebitAmount
       .Cells(lBillRows + 1, 12) = dblCreditAmount
       .Cells(lBillRows + 1, 13) = iAttachment
       .Cells(lBillRows + 1, 14) = strMaker
       .Cells(lBillRows + 1, 15) = ""
       .Cells(lBillRows + 1, 16) = ""
       .Cells(lBillRows + 1, 17) = 0
       .Cells(lBillRows + 1, 18) = 0
       
        lBillRows = lBillRows + 1
    Next
    End With
    
    Call SortVchListData
    MsgBox "快狗提示：凭证添加成功！"

Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
End Sub
Private Sub Worksheet_BeforeDoubleClick(ByVal Target As Range, Cancel As Boolean)
Application.EditDirectlyInCell = True
    If Target.Column = 5 And Target.Row >= 6 And Target.Row <= 505 Then
        Application.EditDirectlyInCell = False
        If iVoucherEdit = 1 Then
        MsgBox ("凭证在查询状态，不能增加分录！"): Exit Sub
        End If
        frm_AccList.Show
    End If
End Sub
Private Sub Worksheet_Change(ByVal Target As Range)
'输入金额一方，另一方有金额清零
    If Not Application.Intersect(Target, Range("I6:I505")) Is Nothing And Target.Count = 1 Then
        If Target.Value <> "" And Target.Value <> 0 Then Target.Offset(0, 1) = ""
        If Round(Target.Value, 2) <> Target.Value Then
            MsgBox ("数据输入有误，小数位只能保留2位！")
            Target.Value = ""
            Target.Select
        End If
    End If
    
    If Not Application.Intersect(Target, Range("K6:K505")) Is Nothing And Target.Count = 1 Then
        If Target.Value <> "" And Target.Value <> 0 Then Target.Offset(0, -2) = ""
        If Round(Target.Value, 2) <> Target.Value Then
            MsgBox ("数据输入有误，小数位只能保留2位！")
            Target.Value = ""
            Target.Select
    End If
    End If

   Dim c
    If Not Application.Intersect(Target, Range("E6:E505")) Is Nothing And Target.Count = 1 Then
        With Sheet12
            If Target.Value <> "" Then
                Set c = .Range("B:B").Find(Target.Value, LookAt:=xlWhole)
                If Not c Is Nothing Then
                    If c.Offset(0, 6) = 1 Then
                        Target.Offset(0, 1) = c.Offset(0, 2)
                    Else
                        MsgBox "该科目代码为非明细科目，请重新输入或选择！"
                        Target.Value = ""
                        Target.Activate
                    End If
                Else
                    MsgBox "该科目代码不存在，请重新输入或选择！"
                    Target.Value = ""
                    Target.Activate
                End If
            End If
        End With
    End If
    
End Sub

Attribute VB_Name = "Sheet6"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "CommandButton1, 1, 0, MSForms, CommandButton"
Private Sub CommandButton1_Click()
 Call 生成日期
    
End Sub


Sub 生成日期()
    Cells(1, 1) = DateValue("2008,2,8")
    Cells(1, 2) = DateSerial(2008, 2, 8)
End Sub


Attribute VB_Name = "Sheet7"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "cmd_Query, 1, 0, MSForms, CommandButton"
Attribute VB_Control = "CommandButton1, 2, 1, MSForms, CommandButton"
Private Sub cmd_Query_Click()

    frm_Multi.Show
    
End Sub

Private Sub CommandButton1_Click()
    Dim iMultiRows As Integer
    Dim lAccRows As Long
    
    lAccRows = Sheet12.Cells(Rows.Count, 1).End(xlUp).Row
    iMultiRows = 0
    
    If lAccRows >= 3 Then
        For i = 3 To lAccRows
            If Sheet12.Cells(i, 7) = 0 Then
                iMultiRows = iMultiRows + 1
            End If
        Next
    End If

    If lAccRows >= 3 Then
        ReDim arr(1 To iMultiRows, 1 To 2)
        n = 0
        For l = 3 To lAccRows
             If Sheet12.Cells(l, 7) = 0 Then
                n = n + 1
                arr(n, 1) = Sheet12.Cells(l, 1)
                arr(n, 2) = Sheet12.Cells(l, 3)
            End If
        Next
    Else
        ReDim arr(1 To 1, 1 To 2)
            arr(1, 1) = ""
            arr(1, 2) = ""
    End If
    MsgBox n
    Sheet7.Cells(5, 5) = arr
End Sub
Attribute VB_Name = "Sheet8"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "cmd_SetFilter, 14, 0, MSForms, CommandButton"
Attribute VB_Control = "cmd_Back, 15, 1, MSForms, CommandButton"
Private Sub cmd_Back_Click()

    Call Hide
    
End Sub
Private Sub cmd_SetFilter_Click()

    frm_Balance.Show
    
End Sub

Attribute VB_Name = "Sheet9"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "cmd_Back, 3, 1, MSForms, CommandButton"
Attribute VB_Control = "cmd_SetPrint, 5, 2, MSForms, CommandButton"
Attribute VB_Control = "cmd_Query, 7, 3, MSForms, CommandButton"
Private Sub cmd_Back_Click()

    Call Hide
    
End Sub
Private Sub cmd_Query_Click()

    frm_VchQueryPrint.Show
    
End Sub
Private Sub cmd_setPrint_Click()
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual
'清理凭证打印
    Sheet9.Activate
    'Call UnprotectVchPrintData
    Call SetVchPrintFormat
    Call ClearVchPrintData
    'Call ProtectVchPrintData
        
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
End Sub

Private Sub CommandButton1_Click()
 Call ClearVchPrintData
End Sub
Attribute VB_Name = "Voucher"
 Sub VoucherRoll()
 
    Application.ScreenUpdating = False
    m = [m1]
    Rows("6:505").EntireRow.Hidden = True
    Rows("" + CStr(m + 5) + ":" + CStr(m + 12) + "").EntireRow.Hidden = False
    Application.ScreenUpdating = True
    
 End Sub
Sub ClearVchData()

    Sheet5.Range("C6:L505").ClearContents
    Sheet5.Cells(507, 5).ClearContents
    Sheet5.Cells(507, 8).ClearContents
    
End Sub
Sub ProtectVchData()

    Sheet5.Range("B1:l507").Select
    Sheet5.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFormattingCells:=True, AllowFormattingColumns:=True, _
    AllowFormattingRows:=True

End Sub
Public Sub UnprotectVchData()

    Sheet5.Range("B1:l507").Select
    Sheet5.Unprotect

End Sub
Function GetVchMaxNum()

    Dim iYear As Integer
    Dim iPeriod As Integer
    Dim iMaxVchNum As Integer
    Dim lVchRows As Long

    iYear = GetCurrentYear()
    iPeriod = GetCurrentPeriod()
    iMaxVchNum = 0

    With Sheet17
        lVchRows = .Cells(Rows.Count, 2).End(xlUp).Row
        If lVchRows >= 3 Then
            For l = 3 To lVchRows
                If .Cells(l, 2) = iYear And .Cells(l, 3) = iPeriod Then
                    If .Cells(l, 6) > iMaxVchNum Then
                        iMaxVchNum = .Cells(l, 6)
                    End If
                End If
            Next
        End If
    End With
    
    GetVchMaxNum = iMaxVchNum

End Function
Function GetVchMaxDate()

    Dim iYear As Integer
    Dim iPeriod As Integer
    Dim dteVchMaxDate As Date
    Dim lVchRows As Long

    iYear = GetCurrentYear()
    iPeriod = GetCurrentPeriod()
    dteVchMaxDate = GetMinDate(iYear, iPeriod)

    With Sheet17
        lVchRows = .Cells(Rows.Count, 2).End(xlUp).Row
        If lVchRows >= 3 Then
            For l = 3 To lVchRows
                If .Cells(l, 2) = iYear And .Cells(l, 3) = iPeriod Then
                    If .Cells(l, 4) > dteVchMaxDate Then
                        dteMaxDate = .Cells(l, 4)
                    End If
                End If
            Next
        End If
    End With
    
    GetVchMaxDate = dteVchMaxDate

End Function
Function GetMaxRowNum()

    Dim iMaxRowNum As Integer
    
    For i = 6 To 505
        If Sheet5.Cells(i, 5) <> "" Or Sheet5.Cells(i, 5) <> "" Or Sheet5.Cells(i, 9) <> 0 Or Sheet5.Cells(i, 11) <> 0 Then
            iMaxRowNum = Sheet5.Cells(i, 2)
        End If
    Next
    
    GetMaxRowNum = iMaxRowNum

End Function
Public Sub SetCheckStatus(ByVal iYear As Integer, iPeriod As Integer, strChecker As String)

    Dim lVchRows As Long
    
    With Sheet17
        lVchRows = .Cells(Rows.Count, 2).End(xlUp).Row
        For l = 3 To lVchRows
            If .Cells(l, 2) = iYear And .Cells(l, 3) = iPeriod Then
                .Cells(l, 15) = strChecker
                .Cells(l, 17) = 1
            End If
        Next
    End With
    
End Sub
Public Sub SetUncheckStatus(ByVal iYear As Integer, iPeriod As Integer)

    Dim lVchRows As Long
    
    With Sheet17
        lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
        For l = 3 To lVchRows
            If .Cells(l, 2) = iYear And .Cells(l, 3) = iPeriod Then
                .Cells(l, 15) = ""
                .Cells(l, 17) = 0
            End If
        Next
    End With
    
End Sub
Public Sub SetPostStatus(ByVal iYear As Integer, iPeriod As Integer, strPoster As String)

    Dim lVchRows As Long
    
    With Sheet17
        lVchRows = .Cells(Rows.Count, 2).End(xlUp).Row
        For l = 3 To lVchRows
            If .Cells(l, 2) = iYear And .Cells(l, 3) = iPeriod Then
                .Cells(l, 16) = strPoster
                .Cells(l, 18) = 1
            End If
        Next
    End With
    
End Sub
Public Sub SetUnpostStatus(ByVal iYear As Integer, iPeriod As Integer)

    Dim lVchRows As Long
    
    With Sheet17
        lVchRows = .Cells(Rows.Count, 2).End(xlUp).Row
        For l = 3 To lVchRows
            If .Cells(l, 2) = iYear And .Cells(l, 3) = iPeriod Then
                .Cells(l, 16) = ""
                .Cells(l, 18) = 0
            End If
        Next
    End With
    
End Sub
Public Sub GetEndVch(strGroup As String, strMaker As String) '结转损益

    Dim iYear As Integer
    Dim iPeriod As Integer
    Dim strProfitandLossNum As String
    Dim strProfitandLossFullName As String
    Dim iMaxVchNum As Integer
    Dim iRowNum As Integer
    Dim dblAmount As Double
    Dim strCord As String
    Dim dteDate As Date
    Dim strAccType As String
    Dim strAccNum As String
    Dim strAccFullName As String
    Dim i As Integer
    Dim m As Integer
    Dim n As Integer
    Dim dblTotalAmount As Double
    
    strProfitandLossNum = Sheet15.Cells(9, 3)
    
    Dim lAccRow As Long
    Set r = Sheet12.Columns("B:B").Find(strProfitandLossNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strProfitandLossNum, LookAt:=xlWhole).Row
        strProfitandLossFullName = Sheet12.Cells(lAccRow, 3)
    Else
        lAccRow = 0
        MsgBox "本年利润科目没有设置或设置错误！"
        Exit Sub
    End If
    
    iCurrentYear = GetCurrentYear()
    iCurrentPeriod = GetCurrentPeriod()
    dteDate = GetMaxDate(iCurrentYear, iCurrentPeriod)
    iMaxVchNum = GetVchMaxNum
    m = 0
    
'判断损益类科目是否有余额
    Dim lAccRows As Long
    Dim lVchRows As Long
    Dim d
    lAccRows = Sheet12.Cells(Rows.Count, 2).End(xlUp).Row
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    Set d = CreateObject("Scripting.Dictionary")
    For l = 3 To lVchRows
        strAccNum = Sheet17.Cells(l, 9)
        iYear = CInt(Sheet17.Cells(l, 2))
        iPeriod = CInt(Sheet17.Cells(l, 3))
        If iPeriod = iCurrentPeriod And iYear = iCurrentYear Then
            Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
            If Not r Is Nothing Then
                lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
                strAccType = Sheet12.Cells(lAccRow, 5)
                strCord = Sheet12.Cells(lAccRow, 6)
                If strAccType = "损益" Then
                    If strCord = "借方" Then
                        dblAmount = Sheet17.Cells(l, 11)
                    Else
                        dblAmount = Sheet17.Cells(l, 12)
                    End If
                    d(strAccNum) = d(strAccNum) + dblAmount
                End If
             End If
        End If
    Next
    Set r = Nothing
    k = d.Keys
    t = d.items
    n = d.Count
    iRowNum = 1
    dblTotalAmount = 0
    If n = 0 Then
        MsgBox ("本期损益类科目发生额为零，无需结转")
        Exit Sub
    Else
        With Sheet17
            For i = 1 To n
                strAccNum = k(i - 1)
                dblAmount = t(i - 1)
                Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
                If Not r Is Nothing Then
                    lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
                    strAccFullName = Sheet12.Cells(lAccRow, 4)
                    strAccType = Sheet12.Cells(lAccRow, 5)
                    strCord = Sheet12.Cells(lAccRow, 6)
                    '写入记录
                    .Cells(lVchRows + 1, 2) = iCurrentYear
                    .Cells(lVchRows + 1, 3) = iCurrentPeriod
                    .Cells(lVchRows + 1, 4) = dteDate
                    .Cells(lVchRows + 1, 5) = strGroup
                    .Cells(lVchRows + 1, 6) = iMaxVchNum + 1
                    .Cells(lVchRows + 1, 7) = iRowNum
                    .Cells(lVchRows + 1, 8) = "结转损益"
                    .Cells(lVchRows + 1, 9) = strAccNum
                    .Cells(lVchRows + 1, 10) = strAccFullName
                    .Cells(lVchRows + 1, 11) = IIf(strCord = "借方", 0, dblAmount)
                    .Cells(lVchRows + 1, 12) = IIf(strCord = "贷方", 0, dblAmount)
                    .Cells(lVchRows + 1, 13) = 0
                    .Cells(lVchRows + 1, 14) = strMaker
                    .Cells(lVchRows + 1, 15) = ""
                    .Cells(lVchRows + 1, 16) = ""
                    .Cells(lVchRows + 1, 17) = 0
                    .Cells(lVchRows + 1, 18) = 0
                End If
                lVchRows = lVchRows + 1
                iRowNum = iRowNum + 1
                If strCord = "借方" Then
                    dblTotalAmount = dblTotalAmount - dblAmount
                Else
                    dblTotalAmount = dblTotalAmount + dblAmount
                End If
            Next
            
            If dblTotalAmount <> 0 Then
                .Cells(lVchRows + 1, 2) = iCurrentYear
                .Cells(lVchRows + 1, 3) = iCurrentPeriod
                .Cells(lVchRows + 1, 4) = dteDate
                .Cells(lVchRows + 1, 5) = strGroup
                .Cells(lVchRows + 1, 6) = iMaxVchNum + 1
                .Cells(lVchRows + 1, 7) = iRowNum
                .Cells(lVchRows + 1, 8) = "结转损益"
                .Cells(lVchRows + 1, 9) = strProfitandLossNum
                .Cells(lVchRows + 1, 10) = strProfitandLossFullName
                .Cells(lVchRows + 1, 11) = 0
                .Cells(lVchRows + 1, 12) = dblTotalAmount
                .Cells(lVchRows + 1, 13) = 0
                .Cells(lVchRows + 1, 14) = strMaker
                .Cells(lVchRows + 1, 15) = ""
                .Cells(lVchRows + 1, 16) = ""
                .Cells(lVchRows + 1, 17) = 0
                .Cells(lVchRows + 1, 18) = 0
                
                lVchRows = lVchRows + 1
                iRowNum = iRowNum + 1
            End If
        MsgBox ("结转损益成功，凭证号为：" & strGroup & iMaxVchNum + 1)
        End With
    End If

End Sub
Attribute VB_Name = "VoucherList"
Sub SetVchListColor()

    Dim lVchListRows As Long
    Dim lineColor
    Dim oddBackColor '奇数行
    Dim evenBackColor '偶数行

    lVchListRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    lineColor = Sheet2.Cells(13, 3).Interior.Color
    oddBackColor = Sheet2.Cells(14, 3).Interior.Color
    evenBackColor = Sheet2.Cells(15, 3).Interior.Color

    Sheet17.Range("B2:R" & lVchListRows).Select
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    With Selection.Borders(xlEdgeLeft)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeTop)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeBottom)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeRight)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideVertical)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideHorizontal)
        .LineStyle = xlContinuous
        .Color = lineColor
        .TintAndShade = 0
        .Weight = xlThin
    End With
    
    If lVchListRows >= 3 Then
        For l = 3 To lVchListRows
            If l Mod 2 = 0 Then
                Range("B" & l & ":" & "R" & l).Select
                With Selection.Interior
                .Pattern = xlSolid
                .PatternColorIndex = xlAutomatic
                .Color = evenBackColor
                .TintAndShade = 0
                .PatternTintAndShade = 0
                End With
            Else
                Range("B" & l & ":" & "R" & l).Select
                With Selection.Interior
                .Pattern = xlSolid
                .PatternColorIndex = xlAutomatic
                .Color = oddBackColor
                .TintAndShade = 0
                .PatternTintAndShade = 0
                End With
            End If
        Next
    End If

End Sub
Sub clearVchLisTColor()

    Dim lVchListRows As Long
    lVchListRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    
    Sheet13.Range("B2:R" & lVchListRows).Select
    
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    Selection.Borders(xlEdgeLeft).LineStyle = xlNone
    Selection.Borders(xlEdgeTop).LineStyle = xlNone
    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
    Selection.Borders(xlEdgeRight).LineStyle = xlNone
    Selection.Borders(xlInsideVertical).LineStyle = xlNone
    Selection.Borders(xlInsideHorizontal).LineStyle = xlNone
    
    If lVchListRows >= 3 Then
        Sheet17.Range("B3:R" & lVchListRows).Select
        With Selection.Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
    End If
    
End Sub
Sub SortVchListData()

    Dim lVchRows As Long
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    
    If lVchRows >= 2 Then
        Sheet17.Range("B2:R" & lVchRows).Sort _
        Key1:=Sheet17.Range("B2"), _
        Key2:=Sheet17.Range("C2"), _
        Key3:=Sheet17.Range("F2"), _
        Header:=xlGuess
    End If
    
End Sub

Attribute VB_Name = "VoucherPrint"
Sub ClearVchPrintData()

    Dim iPagePrintRows As Integer
    Dim iClearRows As Integer
    Dim iPageRows As Integer
    iPagePrintRows = CInt(Sheet16.Cells(3, 3))
    iClearRows = iPagePrintRows + 4
    iPageRows = iPagePrintRows + 7
    
    With Sheet9
        .Cells(1, 10) = ""
        .Cells(2, 5) = ""
        .Cells(2, 10) = ""
        .Cells(2, 11) = ""
        .Cells(3, 11) = ""
        .Cells(iPagePrintRows + 6, 11) = ""
        .Cells(iPagePrintRows + 6, 4) = ""
        .Cells(iPagePrintRows + 6, 7) = ""
        .Cells(iClearRows + 1, 8) = ""
        .Cells(iClearRows + 1, 10) = ""
        .Range("A5:K" & iClearRows).ClearContents
    End With
    
    Rows(iPageRows + 1 & ":2000").Select
    Selection.Delete Shift:=xlUp
    
End Sub
Sub ProtectVchPrintData()

    Sheet9.Range("A1:K2000").Select
    Sheet9.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFormattingCells:=True, AllowFormattingColumns:=True, _
    AllowFormattingRows:=True

End Sub
Sub UnprotectVchPrintData()

    Sheet9.Range("A1:K2000").Select
    Sheet9.Unprotect

End Sub
Sub SetVchPrintFormat()

    Dim iPagePrintRows As Integer
    Dim iCurrentRows As Integer
    Dim iRowHeight As Integer
    Dim iLastRowHeight As Integer
    iPagePrintRows = CInt(Sheet16.Cells(3, 3))
    iRowHeight = CInt(Sheet16.Cells(4, 3))
    iLastRowHeight = CInt(Sheet16.Cells(5, 3))

'先判断现有行数
    For i = 10 To 15
        If CStr(Sheet9.Cells(i, 1)) = "合计" Then
            iCurrentRows = i - 5
            Exit For
        End If
    Next

'根据现有行数增加行或删除行
    With Sheet9
        If iPagePrintRows > iCurrentRows Then
            For i = iCurrentRows To iPagePrintRows - 1
                .Rows("5:5").Copy
                .Rows("5:5").Insert Shift:=xlDown
                Application.CutCopyMode = False
            Next
        ElseIf iPagePrintRows < iCurrentRows Then
            For i = iCurrentRows - 1 To iPagePrintRows Step -1
                .Rows("5:5").Delete Shift:=xlUp
                Application.CutCopyMode = False
            Next
        End If
    End With

'设置行高
    With Sheet9
    For i = 1 To iPagePrintRows
        .Rows(i + 4).RowHeight = iRowHeight
    Next
        .Rows(iPagePrintRows + 5).RowHeight = iRowHeight
        .Rows(iPagePrintRows + 6).RowHeight = iRowHeight
        .Rows(iPagePrintRows + 7).RowHeight = iLastRowHeight
    End With
    
End Sub
Attribute VB_Name = "frm_AccAdd"
Attribute VB_Base = "0{1B62020C-D97C-400F-B1CE-DBAA88577C3F}{B36663EB-AEE6-4A21-9916-BD6A8FE6E98B}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
'关闭按钮
Private Sub btn_Close_Click()
    Unload Me
End Sub
Private Sub btn_Save_Click()

    Dim strAccNum As String
    Dim strAccName As String
    Dim strAccFullName As String
    Dim strCord As String
    Dim strAccGroup As String
    Dim iAccLenth As Integer
    Dim iAccLevel As Integer
    Dim strParentNum As String
    Dim iParentIsDetail As Integer
    Dim n As Integer
    Dim x As Integer
    Dim strParentFullName As String
    Dim lAccRows As Long
    Dim lAccRow As Long

    strAccNum = Trim(txt_AccNum.Text)
    strAccName = Trim(txt_AccName.Text)
    iAccLenth = Len(strAccNum)
    strAccGroup = Trim(cbo_AccGroup)
    strCord = Trim(cbo_CorD)
    lAccRows = Sheet12.Cells(Rows.Count, 2).End(xlUp).Row
    
'判断输入内容是否准确
    If strAccName = "" Then
        MsgBox ("科目名称为空，请重新输入！")
        Exit Sub
        txt_AccName.SetFocus
    ElseIf strAccGroup = "" Then
        MsgBox ("科目类别为空，请重新选择！")
        Exit Sub
        cbo_AccGroup.SetFocus
    ElseIf strCord = "" Then
        MsgBox ("借贷方向为空，请重新选择！")
        Exit Sub
        cbo_CorD.SetFocus
    End If
    
    n = CheckAccInput(strAccNum)
    
    If n = 1 Then
        MsgBox ("科目代码为空，请重新输入！")
        txt_AccNum.SetFocus
        Exit Sub
    ElseIf n = 2 Then
        MsgBox ("科目代码长度超过20位，请重新输入！")
        txt_AccNum.SetFocus
        Exit Sub
    ElseIf n = 3 Or n = 4 Then
        MsgBox ("科目代码不合法，请重新输入！")
        txt_AccNum.SetFocus
        Exit Sub
    End If
    
'科目级别分析
    iAccLevel = GetAccLevel(strAccNum)
    
    If iAccLevel > 6 Then
        MsgBox ("科目级别不能超过6级，请重新输入！")
        Exit Sub
    End If

    If iAccLevel = 1 Then
        If iAccLenth <> 4 Then
            MsgBox ("一级科目代码必须为四位数，请重新输入！")
            txt_AccNum.SetFocus
            Exit Sub
        End If
    ElseIf iAccLevel >= 2 Then
        strParentNum = GetParentNum(strAccNum)
        Dim b
        Set b = Sheet12.Range("B:B").Find(strParentNum)
        If b Is Nothing Then
            MsgBox ("上级科目不存在，请重新输入！")
            Exit Sub
        Else
            lAccRow = Sheet12.Columns("B:B").Find(strParentNum).Row
            strParentName = Sheet12.Cells(lAccRow, 4)
            iParentIsDetail = Sheet12.Cells(lAccRow, 8)
        End If
    End If
    
'判断科目是否存在
    Dim a
    Set a = Sheet12.Range("B:B").Find(strAccNum)
    If Not a Is Nothing Then
        MsgBox ("此科目已存在，请重新输入！")
        Exit Sub
    End If

    If iAccLevel = 1 Then
        strAccFullName = strAccName
    Else
        strAccFullName = strParentName & "_" & strAccName
    End If

'写入数据
    If iAccLevel = 1 Then
        Sheet12.Cells(lAccRows + 1, 2) = strAccNum
        Sheet12.Cells(lAccRows + 1, 3) = strAccName
        Sheet12.Cells(lAccRows + 1, 4) = strAccFullName
        Sheet12.Cells(lAccRows + 1, 5) = strAccGroup
        Sheet12.Cells(lAccRows + 1, 6) = strCord
        Sheet12.Cells(lAccRows + 1, 7) = ""
        Sheet12.Cells(lAccRows + 1, 8) = 1
        Sheet12.Cells(lAccRows + 1, 9) = 1
    ElseIf iAccLevel >= 2 Then
        Sheet12.Cells(lAccRows + 1, 2) = strAccNum
        Sheet12.Cells(lAccRows + 1, 3) = strAccName
        Sheet12.Cells(lAccRows + 1, 4) = strAccFullName
        Sheet12.Cells(lAccRows + 1, 5) = strAccGroup
        Sheet12.Cells(lAccRows + 1, 6) = strCord
        Sheet12.Cells(lAccRows + 1, 7) = strParentNum
        Sheet12.Cells(lAccRows + 1, 8) = 1
        Sheet12.Cells(lAccRows + 1, 9) = iAccLevel
    End If
        
'如果上级科目是明细科目
    If iParentIsDetail = 1 Then
        Sheet12.Cells(lAccRow, 8) = 0
    End If
    
'排序和设置颜色
    Call AccSort
    Call SetAccColor
    
'提示添加成功
    MsgBox "科目添加成功！"
    
End Sub
Private Sub UserForm_Initialize()

    txt_AccNum.SetFocus
    
    cbo_CorD.AddItem "借方"
    cbo_CorD.AddItem "贷方"
    
    cbo_AccGroup.AddItem "资产"
    cbo_AccGroup.AddItem "负债"
    cbo_AccGroup.AddItem "共同"
    cbo_AccGroup.AddItem "权益"
    cbo_AccGroup.AddItem "成本"
    cbo_AccGroup.AddItem "损益"
    
End Sub
Attribute VB_Name = "frm_AccList"
Attribute VB_Base = "0{36AA8959-6804-4D44-B2D6-DD2064774BEA}{99E927F7-4AE8-49D6-BB24-A508472315B6}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btn_Close_Click()

    Unload Me
    
End Sub

Private Sub cmd_Cancel_Click()
    
    Unload Me
    
End Sub
Private Sub lst_Account_DblClick(ByVal Cancel As MSForms.ReturnBoolean)

    If lst_Account.ListIndex > 0 Then
        Dim temStr As String
        temStr = Trim(CStr(lst_Account.List(lst_Account.ListIndex, 0)))
        If (temStr = "") Or (temStr = "科目代码") Then
            Exit Sub
        End If
        Dim temp As Range
        Set temp = ActiveWindow.ActiveCell
        temp.Value = temStr
        Set temp = Nothing
            Unload Me
    End If
    
End Sub
Private Sub txt_Query_Change()
Application.DisplayAlerts = False

    If Sheet12.AutoFilterMode = True Then
        Sheet12.AutoFilterMode = False
    End If
    
    Dim arr()
    Dim lAccRows As Long
    Dim lAccLastLevelRows As Long
    Dim strInput As String
    Dim m As Integer
        
    lAccRows = Sheet12.Cells(Rows.Count, 2).End(xlUp).Row
    strInput = Trim(txt_Query.Text)
    lAccLastLevelRows = 0
    
    If lAccRows >= 3 Then
        For i = 3 To lAccRows
            If Sheet12.Cells(i, 8) = 1 Then
                lAccLastLevelRows = lAccLastLevelRows + 1
            End If
        Next
    End If
    
    If lAccRows >= 3 Then
        ReDim arr(1 To lAccLastLevelRows + 1, 1 To 2)
        Dim x As Long
        Dim y As Long
        x = 1
        y = 1
        arr(x, 1) = "科目代码"
        arr(x, 2) = "科目全称"
        
        For l = 3 To lAccRows
            If Sheet12.Cells(l, 8) = 1 Then
            m = InStr(Sheet12.Cells(l, 2), txt_Query.Text) + InStr(Sheet12.Cells(l, 4), txt_Query.Text)
                If m > 0 Then
                    x = x + 1
                    arr(x, 1) = Sheet12.Cells(l, 2)
                    arr(x, 2) = Sheet12.Cells(l, 4)
                End If
            End If
        Next
    End If

    lst_Account.List = arr
    Erase arr
    
Application.DisplayAlerts = True
End Sub

Private Sub UserForm_Initialize()

    Call GetAccList
    
End Sub
Private Sub GetAccList()
Application.DisplayAlerts = False

    If Sheet12.AutoFilterMode = True Then
        Sheet12.AutoFilterMode = False
    End If

    Dim arr()
    Dim lAccRows As Long
    Dim lAccLastLevelRows As Long
    
    lAccRows = Sheet12.Cells(Rows.Count, 2).End(xlUp).Row
    lAccLastLevelRows = 0
    
    If lAccRows >= 3 Then
        For l = 3 To lAccRows
            If Sheet12.Cells(l, 8) = 1 Then
                lAccLastLevelRows = lAccLastLevelRows + 1
            End If
        Next
    End If

    If lAccRows >= 3 Then
        ReDim arr(1 To lAccLastLevelRows + 1, 1 To 2)
        Dim x As Long
        Dim y As Long
        x = 1
        y = 1
        arr(x, 1) = "科目代码"
        arr(x, 2) = "科目全称"
        For l = 3 To lAccRows
            If Sheet12.Cells(l, 8) = 1 Then
                x = x + 1
                arr(x, 1) = Sheet12.Cells(l, 2)
                arr(x, 2) = Sheet12.Cells(l, 4)
            End If
        Next
    Else
        ReDim arr(1 To 1, 1 To 2)
            arr(1, 1) = ""
            arr(1, 2) = ""
    End If

    lst_Account.List = arr
    Erase arr
    
Application.DisplayAlerts = True
End Sub





Attribute VB_Name = "frm_AccTree"
Attribute VB_Base = "0{0950C73D-64BB-4D81-BA1A-2AF959C405BC}{83AC4939-40EB-4ED1-9CA2-E0A8B8FE5551}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btn_Add_Click()
    iAccEdit = 0
    frm_AccAdd.Show
End Sub

Private Sub btn_Exit_Click()
    Unload Me
End Sub
Private Sub btn_Refresh_Click()
    tv_Acc.Nodes.Clear
    Call getAccTree
End Sub
Private Sub tv_Acc_DblClick()
    Dim strAccNum As String
    Dim strAccFullName As String
    Dim iAccRows As Integer
    iAccRows = Sheet12.Cells(Rows.Count, 1).End(xlUp).Row

        For i = 1 To tv_Acc.Nodes.Count
            If tv_Acc.Nodes(i).Selected Then
                If tv_Acc.Nodes(i).Children = 0 And tv_Acc.Nodes(i).Index > 6 Then
                     a = tv_Acc.Nodes(i)
                     n = InStr(1, a, "-")
                     strAccNum = Left(a, n - 2)
                     For m = 1 To iAccRows
                        If strAccNum = Sheet12.Cells(m, 1) Then
                           strAccFullName = Sheet12.Cells(m, 3)
                        End If
                        Next m
                     ActiveCell.Value = strAccNum
                     ActiveCell.Offset(0, 1).Value = strAccFullName
                     frm_AccTree.Hide
                End If
            End If
       Next i
       
End Sub
Public Sub getAccTree()
    Dim Nodx As Node
    tv_Acc.ImageList = imlst_Acc
    Dim iAccRows As Integer
    iAccRows = Sheet12.Cells(Rows.Count, 1).End(xlUp).Row

        Set Nodx = tv_Acc.Nodes.Add(, , "资产", "资产", 1)
        Set Nodx = tv_Acc.Nodes.Add(, , "负债", "负债", 1)
        Set Nodx = tv_Acc.Nodes.Add(, , "共同", "共同", 1)
        Set Nodx = tv_Acc.Nodes.Add(, , "权益", "权益", 1)
        Set Nodx = tv_Acc.Nodes.Add(, , "成本", "成本", 1)
        Set Nodx = tv_Acc.Nodes.Add(, , "损益", "损益", 1)

    

    Dim strAccNum As String
    Dim strAccName As String
    Dim strAccGroup As String
    Dim iLevel As Integer
    Dim iIsDetail As Integer
    Dim strParentNum As String

            
    For n = 3 To iAccRows
        
    strAccNum = Sheet12.Cells(n, 1)
    strAccName = Sheet12.Cells(n, 2)
    strAccGroup = Sheet12.Cells(n, 4)
    iLevel = Sheet12.Cells(n, 8)
    iIsDetail = Sheet12.Cells(n, 7)
    strParentNum = Sheet12.Cells(n, 6)
            
'资产类
    If strAccGroup = "资产" Then
        If iLevel = 1 Then
            If iIsDetail = 1 Then
                Set Nodx = tv_Acc.Nodes.Add("资产", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
                Set Nodx = tv_Acc.Nodes.Add("资产", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 2 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 3 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 4 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 5 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 6 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        End If
    End If
    '负债类
    If strAccGroup = "负债" Then
         If iLevel = 1 Then
            If iIsDetail = 1 Then
                Set Nodx = tv_Acc.Nodes.Add("负债", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
                Set Nodx = tv_Acc.Nodes.Add("负债", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 2 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 3 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 4 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 5 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 6 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        End If
    End If
    '共同类
    If strAccGroup = "共同" Then
         If iLevel = 1 Then
            If iIsDetail = 1 Then
                Set Nodx = tv_Acc.Nodes.Add("共同", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
                Set Nodx = tv_Acc.Nodes.Add("共同", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 2 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 3 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 4 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 5 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 6 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        End If
    End If
    '权益类
    If strAccGroup = "权益" Then
         If iLevel = 1 Then
            If iIsDetail = 1 Then
                Set Nodx = tv_Acc.Nodes.Add("权益", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
                Set Nodx = tv_Acc.Nodes.Add("权益", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 2 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 3 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 4 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 5 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 6 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        End If
    End If
    '成本类
    If strAccGroup = "成本" Then
         If iLevel = 1 Then
            If iIsDetail = 1 Then
                Set Nodx = tv_Acc.Nodes.Add("成本", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
                Set Nodx = tv_Acc.Nodes.Add("成本", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 2 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 3 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 4 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 5 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 6 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        End If
    End If
    '损益类
    If strAccGroup = "损益" Then
         If iLevel = 1 Then
            If iIsDetail = 1 Then
                Set Nodx = tv_Acc.Nodes.Add("损益", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
                Set Nodx = tv_Acc.Nodes.Add("损益", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 2 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 3 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 4 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 5 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 6 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        End If
    End If
            
    Next


End Sub

Private Sub UserForm_Initialize()

 Call getAccTree

End Sub

Public Sub getNewAccTree()
    Dim Nodx As Node
    tv_Acc.ImageList = imlst_Acc
    
    Dim strSql As String
    Dim strQuery As String
    Dim strAccSet As New ADODB.Recordset
    
    
    Dim lAccRows As Integer
    lAccRows = Sheet12.Cells(Rows.Count, 1).End(xlUp).Row

        Set Nodx = tv_Acc.Nodes.Add(, , "资产", "资产", 1)
        Set Nodx = tv_Acc.Nodes.Add(, , "负债", "负债", 1)
        Set Nodx = tv_Acc.Nodes.Add(, , "共同", "共同", 1)
        Set Nodx = tv_Acc.Nodes.Add(, , "权益", "权益", 1)
        Set Nodx = tv_Acc.Nodes.Add(, , "成本", "成本", 1)
        Set Nodx = tv_Acc.Nodes.Add(, , "损益", "损益", 1)

    

    Dim strAccNum As String
    Dim strAccName As String
    Dim strAccGroup As String
    Dim iLevel As Integer
    Dim iIsDetail As Integer
    Dim strParentNum As String

    strSql = "select acc_num,acc_name,acc_group,acc_level,acc_parentnum,acc_isdetail from [Accs$] where acc_fullname like '%" + strQuery + "%'"
            
    For n = 2 To lAccRows
        
    strAccNum = Sheet12.Cells(n, 1)
    strAccName = Sheet12.Cells(n, 2)
    strAccGroup = Sheet12.Cells(n, 4)
    iLevel = Sheet12.Cells(n, 8)
    iIsDetail = Sheet12.Cells(n, 7)
    strParentNum = Sheet12.Cells(n, 6)
            
'资产类
    If strAccGroup = "资产" Then
        If iLevel = 1 Then
            If iIsDetail = 1 Then
                Set Nodx = tv_Acc.Nodes.Add("资产", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
                Set Nodx = tv_Acc.Nodes.Add("资产", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 2 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 3 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 4 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 5 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 6 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        End If
    End If
    '负债类
    If strAccGroup = "负债" Then
         If iLevel = 1 Then
            If iIsDetail = 1 Then
                Set Nodx = tv_Acc.Nodes.Add("负债", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
                Set Nodx = tv_Acc.Nodes.Add("负债", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 2 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 3 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 4 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 5 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 6 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        End If
    End If
    '共同类
    If strAccGroup = "共同" Then
         If iLevel = 1 Then
            If iIsDetail = 1 Then
                Set Nodx = tv_Acc.Nodes.Add("共同", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
                Set Nodx = tv_Acc.Nodes.Add("共同", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 2 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 3 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 4 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 5 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 6 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        End If
    End If
    '权益类
    If strAccGroup = "权益" Then
         If iLevel = 1 Then
            If iIsDetail = 1 Then
                Set Nodx = tv_Acc.Nodes.Add("权益", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
                Set Nodx = tv_Acc.Nodes.Add("权益", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 2 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 3 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 4 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 5 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 6 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        End If
    End If
    '成本类
    If strAccGroup = "成本" Then
         If iLevel = 1 Then
            If iIsDetail = 1 Then
                Set Nodx = tv_Acc.Nodes.Add("成本", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
                Set Nodx = tv_Acc.Nodes.Add("成本", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 2 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 3 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 4 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 5 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 6 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        End If
    End If
    '损益类
    If strAccGroup = "损益" Then
         If iLevel = 1 Then
            If iIsDetail = 1 Then
                Set Nodx = tv_Acc.Nodes.Add("损益", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
                Set Nodx = tv_Acc.Nodes.Add("损益", tvwChild, "A" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 2 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("A" & strParentNum, tvwChild, "B" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 3 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("B" & strParentNum, tvwChild, "C" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 4 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("C" & strParentNum, tvwChild, "D" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 5 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("D" & strParentNum, tvwChild, "E" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        ElseIf iLevel = 6 Then
            If iIsDetail = 1 Then
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 3)
            Else
            Set Nodx = tv_Acc.Nodes.Add("E" & strParentNum, tvwChild, "F" & strAccNum, strAccNum + " - " + strAccName, 1, 2)
            End If
        End If
    End If
            
    Next


End Sub


Attribute VB_Name = "frm_Balance"
Attribute VB_Base = "0{5FEB4530-ECF0-415D-9248-3C1779B3B8EE}{52FF3763-BACF-46D8-B40C-01199288FA88}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btn_Back_Click()
    Unload Me
    Sheet8.Visible = xlSheetHidden
    Sheet1.Activate
End Sub
Private Sub btn_Cancel_Click()
    Unload Me
End Sub
Private Sub btn_OK_Click()
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual
'清理数据
    Call ClearBalanceColor
    Call ClearBalanceData
    Call AddSheetTemp
    Call SetTempBalanceTitle
    Sheet8.Activate
    
    Dim iYear As Integer
    Dim iPeriodFrom, iPeriodTo As Integer
    Dim iAccLevel As Integer
    Dim strAccNum As String
    Dim strAccFullName As String
    Dim strCord As String
    Dim dblDebit As Double
    Dim dblCredit As Double
    Dim strTitle As String
    Dim lAccRows As Long
    Dim lVchRows As Long

    iYear = CInt(cbo_Year.Value)
    iPeriodFrom = CInt(cbo_PeriodFrom.Value)
    iPeriodTo = CInt(cbo_PeriodTo.Value)
    iAccLevel = CInt(cbo_AccLevel.Value)
    iBeginPeriod = CInt(GetBeginPeriod())
    iOpenPeriod = CInt(GetOpenPeriod())
    iBeginYear = GetBeginYear()
    iCurrentYear = GetCurrentYear()

    If iPeriodFrom > iPeriodTo Then
        MsgBox "会计区间选择有误，请重新选择！"
        Exit Sub
    End If
    
    lAccRows = Sheet12.Cells(Rows.Count, 2).End(xlUp).Row
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    
'把科目写入临时表temp
    If lAccRows >= 3 Then
        For l = 3 To lAccRows
            With Sheets("Temp")
                .Cells(l - 1, 1) = Sheet12.Cells(l, 2)
                .Cells(l - 1, 2) = Sheet12.Cells(l, 4)
                .Cells(l - 1, 3) = Sheet12.Cells(l, 6)
                .Cells(l - 1, 4) = Sheet12.Cells(l, 7)
                .Cells(l - 1, 5) = Sheet12.Cells(l, 8)
                .Cells(l - 1, 6) = Sheet12.Cells(l, 9)
                .Cells(l - 1, 7) = Sheet12.Cells(l, 10)
                .Cells(l - 1, 8) = Sheet12.Cells(l, 11)
                .Cells(l - 1, 9) = Sheet12.Cells(l, 12)
                .Cells(l - 1, 10) = Sheet12.Cells(l, 13)
            End With
        Next
    End If
    
'如果当前年度等于系统启用年度
    If iYear = iBeginYear Then
        If iPeriodFrom < iOpenPeriod Then
            iPeriodFrom = iBeginPeriod
        End If
        If iPeriodTo < iOpenPeriod Then
            iPeriodTo = iBeginPeriod
        End If

        With Sheet17
        For la = 3 To lVchRows
            strAccNum = CStr(.Cells(la, 9))
            dblDebit = CDbl(.Cells(la, 11))
            dblCredit = CDbl(.Cells(la, 12))
            Set r = Sheets("Temp").Columns("A:A").Find(strAccNum)
            If Not r Is Nothing Then
                lAccRow = Sheets("Temp").Columns("A:A").Find(strAccNum).Row
                strCord = Sheets("Temp").Cells(lAccRow, 3)
            Else
                lAccRow = 0
            End If
            If lAccRow > 0 Then
                If .Cells(la, 2) = iYear Then
                    If .Cells(la, 3) < iPeriodFrom Then
                        If strCord = "借方" Then
                            Sheets("Temp").Cells(lAccRow, 12) = Sheets("temp").Cells(lAccRow, 12) + dblDebit - dblCredit
                        Else
                            Sheets("Temp").Cells(lAccRow, 12) = Sheets("temp").Cells(lAccRow, 12) + dblCredit - dblDebit
                        End If
                        Sheets("temp").Cells(lAccRow, 17) = Sheets("temp").Cells(lAccRow, 17) + dblDebit
                        Sheets("temp").Cells(lAccRow, 18) = Sheets("temp").Cells(lAccRow, 18) + dblCredit
                    ElseIf .Cells(la, 3) >= iPeriodFrom And .Cells(la, 3) <= iPeriodTo Then
                        Sheets("temp").Cells(lAccRow, 15) = Sheets("temp").Cells(lAccRow, 15) + dblDebit
                        Sheets("temp").Cells(lAccRow, 16) = Sheets("temp").Cells(lAccRow, 16) + dblCredit
                        Sheets("temp").Cells(lAccRow, 17) = Sheets("temp").Cells(lAccRow, 17) + dblDebit
                        Sheets("temp").Cells(lAccRow, 18) = Sheets("temp").Cells(lAccRow, 18) + dblCredit
                    End If
                End If
            End If
        Next
        End With
    ElseIf iYear > iBeginYear Then
        With Sheet17
        For lb = 3 To lVchRows
            strAccNum = CStr(.Cells(lb, 9))
            dblDebit = CDbl(.Cells(lb, 11))
            dblCredit = CDbl(.Cells(lb, 12))
            Set r = Sheets("Temp").Columns("A:A").Find(strAccNum)
            If Not r Is Nothing Then
                lAccRow = Sheets("Temp").Columns("A:A").Find(strAccNum).Row
                strCord = Sheets("Temp").Cells(lAccRow, 3)
            Else
                lAccRow = 0
            End If
            If lAccRow > 0 Then
                If .Cells(lb, 2) < iYear Then
                    If strCord = "借方" Then
                        Sheets("temp").Cells(lAccRow, 12) = Sheets("temp").Cells(lAccRow, 12) + dblDebit - dblCredit
                    Else
                        Sheets("temp").Cells(lAccRow, 12) = Sheets("temp").Cells(lAccRow, 12) + dblCredit - dblDebit
                    End If
                ElseIf .Cells(lb, 2) = iYear Then
                    If .Cells(lb, 3) < iPeriodFrom Then
                        If strCord = "借方" Then
                            Sheets("temp").Cells(lAccRow, 12) = Sheets("temp").Cells(lAccRow, 12) + dblDebit - dblCredit
                        Else
                            Sheets("temp").Cells(lAccRow, 12) = Sheets("temp").Cells(lAccRow, 12) + dblCredit - dblDebit
                        End If
                        Sheets("temp").Cells(lAccRow, 17) = Sheets("temp").Cells(lAccRow, 17) + dblDebit
                        Sheets("temp").Cells(lAccRow, 18) = Sheets("temp").Cells(lAccRow, 18) + dblCredit
                    ElseIf .Cells(lb, 3) >= iPeriodFrom And .Cells(lb, 3) <= iPeriodTo Then
                        Sheets("temp").Cells(lAccRow, 15) = Sheets("temp").Cells(lAccRow, 15) + dblDebit
                        Sheets("temp").Cells(lAccRow, 16) = Sheets("temp").Cells(lAccRow, 16) + dblCredit
                        Sheets("temp").Cells(lAccRow, 17) = Sheets("temp").Cells(lAccRow, 17) + dblDebit
                        Sheets("temp").Cells(lAccRow, 18) = Sheets("temp").Cells(lAccRow, 18) + dblCredit
                    End If
                End If
            End If
        Next
        End With
        
    End If
    strTitle = "期间：" & iYear & "年第" & iPeriodFrom & "期到第" & iPeriodTo & "期"
    
'逐级汇总科目余额
    Dim lTempRows As Long
    Dim strParentNum As String
    lTempRows = Sheets("Temp").Cells(Rows.Count, 1).End(xlUp).Row
    If lTempRows >= 2 Then
        With Sheets("Temp")
            For l = lTempRows To 2 Step -1
                If .Cells(l, 5) = 0 Then
                    strParentNum = .Cells(l, 1)
                    For i = l + 1 To lTempRows
                        If .Cells(i, 4) = strParentNum Then
                            .Cells(l, 11) = .Cells(l, 11) + .Cells(i, 11)
                            .Cells(l, 12) = .Cells(l, 12) + .Cells(i, 12)
                            .Cells(l, 14) = .Cells(l, 14) + .Cells(i, 14)
                            .Cells(l, 15) = .Cells(l, 15) + .Cells(i, 15)
                            .Cells(l, 16) = .Cells(l, 16) + .Cells(i, 16)
                            .Cells(l, 17) = .Cells(l, 17) + .Cells(i, 17)
                            .Cells(l, 18) = .Cells(l, 18) + .Cells(i, 18)
                            .Cells(l, 20) = .Cells(l, 20) + .Cells(i, 20)
                        End If
                    Next
                End If
            Next
        End With
    End If
'计算期初余额和期末余额
    If lTempRows >= 2 Then
        With Sheets("Temp")
            For l = 2 To lTempRows
                If .Cells(l, 3) = "借方" Then
                    .Cells(l, 14) = .Cells(l, 10) + .Cells(l, 11) + .Cells(l, 12)

                    .Cells(l, 22) = .Cells(l, 10) + .Cells(l, 11) + .Cells(l, 12) + .Cells(l, 15) - .Cells(l, 16)
                Else
                    .Cells(l, 14) = .Cells(l, 10) + .Cells(l, 11) + .Cells(l, 12)
                    .Cells(l, 22) = .Cells(l, 10) + .Cells(l, 11) + .Cells(l, 12) - .Cells(l, 15) + .Cells(l, 16)

                End If
                    If iYear = iBeginYear Then
                        If iPeriodFrom = iBeginPeriod Then
                            .Cells(l, 15) = .Cells(l, 8) + .Cells(l, 15)
                            .Cells(l, 16) = .Cells(l, 9) + .Cells(l, 16)
                        End If
                        .Cells(l, 19) = .Cells(l, 8) + .Cells(l, 17)
                        .Cells(l, 20) = .Cells(l, 9) + .Cells(l, 18)
                    Else
                        .Cells(l, 19) = .Cells(l, 17)
                        .Cells(l, 20) = .Cells(l, 18)
                    End If
                    .Cells(l, 23) = Abs(.Cells(l, 14)) + Abs(.Cells(l, 15)) + Abs(.Cells(l, 16)) + Abs(.Cells(l, 17)) + Abs(.Cells(l, 18)) + Abs(.Cells(l, 19)) + Abs(.Cells(l, 20)) + Abs(.Cells(l, 22))
            Next
        End With
    End If
    
'设置借贷方向
    If lTempRows >= 2 Then
        With Sheets("temp")
            For l = 2 To lTempRows
                If .Cells(l, 3) = "借方" Then
                    If .Cells(l, 14) > 0 Then
                        .Cells(l, 13) = "借"
                    ElseIf .Cells(l, 14) < 0 Then
                        .Cells(l, 14) = Abs(.Cells(l, 14))
                        .Cells(l, 13) = "贷"
                    Else
                        .Cells(l, 13) = "平"
                    End If
                    If .Cells(l, 22) > 0 Then
                        .Cells(l, 21) = "借"
                    ElseIf .Cells(l, 22) < 0 Then
                        .Cells(l, 22) = Abs(.Cells(l, 22))
                        .Cells(l, 21) = "贷"
                    Else
                        .Cells(l, 21) = "平"
                    End If
                Else
                    If .Cells(l, 14) > 0 Then
                        .Cells(l, 13) = "贷"
                    ElseIf .Cells(l, 14) < 0 Then
                        .Cells(l, 14) = Abs(.Cells(l, 14))
                        .Cells(l, 13) = "借"
                    Else
                        .Cells(l, 13) = "平"
                    End If
                    If .Cells(l, 22) > 0 Then
                        .Cells(l, 21) = "贷"
                    ElseIf .Cells(l, 22) < 0 Then
                        .Cells(l, 22) = Abs(.Cells(l, 22))
                        .Cells(l, 21) = "借"
                    Else
                        .Cells(l, 21) = "平"
                    End If
                End If
            Next
        End With
    End If

'从Temp取数到余额表
    Sheet8.Cells(2, 2) = strTitle
    Dim n As Long
    n = 4
    For lc = 2 To lTempRows
        If Sheets("Temp").Cells(lc, 6) <= iAccLevel Then
            If Sheets("Temp").Cells(lc, 23) > 0 Then
                Sheet8.Cells(n, 2) = Sheets("Temp").Cells(lc, 1)
                Sheet8.Cells(n, 3) = Sheets("Temp").Cells(lc, 2)
                Sheet8.Cells(n, 4) = Sheets("Temp").Cells(lc, 13)
                Sheet8.Cells(n, 5) = Sheets("Temp").Cells(lc, 14)
                Sheet8.Cells(n, 6) = Sheets("Temp").Cells(lc, 15)
                Sheet8.Cells(n, 7) = Sheets("Temp").Cells(lc, 16)
                Sheet8.Cells(n, 8) = Sheets("Temp").Cells(lc, 19)
                Sheet8.Cells(n, 9) = Sheets("Temp").Cells(lc, 20)
                Sheet8.Cells(n, 10) = Sheets("Temp").Cells(lc, 21)
                Sheet8.Cells(n, 11) = Sheets("Temp").Cells(lc, 22)
                n = n + 1
            Else
                If chk_ShowZero.Value = False Then
                    Sheet8.Cells(n, 2) = Sheets("Temp").Cells(lc, 1)
                    Sheet8.Cells(n, 3) = Sheets("Temp").Cells(lc, 2)
                    Sheet8.Cells(n, 4) = Sheets("Temp").Cells(lc, 13)
                    Sheet8.Cells(n, 5) = Sheets("Temp").Cells(lc, 14)
                    Sheet8.Cells(n, 6) = Sheets("Temp").Cells(lc, 15)
                    Sheet8.Cells(n, 7) = Sheets("Temp").Cells(lc, 16)
                    Sheet8.Cells(n, 8) = Sheets("Temp").Cells(lc, 19)
                    Sheet8.Cells(n, 9) = Sheets("Temp").Cells(lc, 20)
                    Sheet8.Cells(n, 10) = Sheets("Temp").Cells(lc, 21)
                    Sheet8.Cells(n, 11) = Sheets("Temp").Cells(lc, 22)
                    n = n + 1
                End If
            End If
        End If
    Next

'添加合计
    Dim lNewBalanceRows As Long
    Dim dblTotalDebit As Double
    Dim dblTotalCredit As Double
    Dim dblYearDebit As Double
    Dim dblYearCredit As Double
    dblTotalDebit = 0
    dblTotalCredit = 0
    dblYearDebit = 0
    dblYearCredit = 0
    With Sheet8
        lNewBalanceRows = .Cells(Rows.Count, 2).End(xlUp).Row
       .Cells(lNewBalanceRows + 1, 2) = "合计"
        For l = 4 To lNewBalanceRows
            If Len(.Cells(l, 2)) = 4 Then
                dblTotalDebit = dblTotalDebit + .Cells(l, 6)
                dblTotalCredit = dblTotalCredit + .Cells(l, 7)
                dblYearDebit = dblYearDebit + .Cells(l, 8)
                dblYearCredit = dblYearCredit + .Cells(l, 9)
            End If
        Next
        .Cells(lNewBalanceRows + 1, 6) = dblTotalDebit
        .Cells(lNewBalanceRows + 1, 7) = dblTotalCredit
        .Cells(lNewBalanceRows + 1, 8) = dblYearDebit
        .Cells(lNewBalanceRows + 1, 9) = dblYearCredit
    End With
    
'设置颜色
    Call SetBalanceColor
    Call DeleteSheetTemp
    Me.Hide
    
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
End Sub
Private Sub ClearZero()

    Dim lBalRows As Long
    lBalRows = Sheet8.Cells(Rows.Count, 4).End(xlUp).Row
    
    If lBalRows > 3 Then
        Sheet8.Range("F4:M" & lBalRows).Select
        Selection.NumberFormatLocal = "0.00;-0.00;;@"
    End If
    
End Sub
Private Sub UserForm_Initialize()

    iBeginYear = CInt(GetBeginYear)
    iBeginPeriod = CInt(GetBeginPeriod())
    iOpenPeriod = CInt(GetOpenPeriod())
    iCurrentYear = CInt(GetCurrentYear)
    iCurrentPeriod = CInt(GetCurrentPeriod)
    
'设置年份下列框
    If iBeginYear = iCurrentYear Then
        cbo_Year.AddItem iBeginYear
        cbo_Year.Value = iBeginYear
    ElseIf iCurrentYear > iBeginYear Then
        For i = iBeginYear To iCurrentYear
            cbo_Year.AddItem i
        Next
        cbo_Year.Value = iBeginYear
    End If
'设置月份下列框
    For i = 1 To 12
        cbo_PeriodFrom.AddItem i
        cbo_PeriodTo.AddItem i
    Next
    cbo_PeriodFrom.Value = 1
    cbo_PeriodTo.Value = 1
'设置科目级别下拉框
    For i = 1 To 6
        cbo_AccLevel.AddItem i
    Next
    
    cbo_AccLevel.Value = 1
    
End Sub
Attribute VB_Name = "frm_CalBal"
Attribute VB_Base = "0{ED7F757E-F48E-4A52-8ED9-D08BB0A9155F}{1573CAAB-F4D4-4FEE-B561-8256C069BEDD}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btn_Cancel_Click()

    Unload Me
    
End Sub
Private Sub btn_OK_Click()
Application.ScreenUpdating = False '关闭屏幕更新
Application.DisplayAlerts = False
    Dim iYear As Integer
    Dim iPeriod As Integer
    
    iYear = CInt(cbo_Year.Text)
    iPeriod = CInt(cbo_Period.Text)
    iOpenPeriod = CInt(GetOpenPeriod())
    
    If iYear = iBeginYear Then
        If iPeriod < iOpenPeriod Then
            MsgBox "会计期间小于会计启用期间，请重新选择！"
            cbo_Period.Text = iOpenPeriod
            Exit Sub
        End If
    End If
    
    dteMaxDate = GetMaxDate(iYear, iPeriod)
    Sheet10.Cells(3, 4) = dteMaxDate
    Sheet11.Cells(3, 2) = dteMaxDate
    iReportYear = iYear
    iReportPeriod = iPeriod
    
    Unload Me
    
Application.ScreenUpdating = True '关闭屏幕更新
Application.DisplayAlerts = True
End Sub
Private Sub UserForm_Initialize()

    iBeginYear = CInt(GetBeginYear)
    iBeginPeriod = CInt(GetBeginPeriod())
    iOpenPeriod = CInt(GetOpenPeriod())
    iCurrentYear = CInt(GetCurrentYear)
    iCurrentPeriod = CInt(GetCurrentPeriod)
    
'设置年份下列框
    If iBeginYear = iCurrentYear Then
        cbo_Year.AddItem iBeginYear
        cbo_Year.Value = iBeginYear
    ElseIf iCurrentYear > iBeginYear Then
        For i = iBeginYear To iCurrentYear
            cbo_Year.AddItem i
        Next
        cbo_Year.Value = iBeginYear
    End If
'设置月份下列框
    For i = 1 To 12
        cbo_Period.AddItem i
    Next
    cbo_Period.Value = 1
    
End Sub
Attribute VB_Name = "frm_Check"
Attribute VB_Base = "0{83139839-048E-43FE-8A7C-525D6282071C}{9CC38ED2-43A3-4704-B246-FC7DA3022B65}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btn_Cancel_Click()

    Unload Me
    
End Sub
Private Sub btn_Check_Click()

Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    If cbo_Checker.Value = "" Then
        MsgBox ("审核人不能为空，请选择！"): Exit Sub
    End If

    Dim iYear As Integer
    Dim iPeriod As Integer
    Dim strChecker As String
    
    iYear = GetCurrentYear()
    iPeriod = GetCurrentPeriod()
    strChecker = CStr(cbo_Checker.Text)
    
    Call SetCheckStatus(iYear, iPeriod, strChecker)
      
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True

    MsgBox ("快狗提示：审核成功！")
    
    Unload Me
    
End Sub
Private Sub btn_UnCheck_Click()

Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    Dim iYear As Integer
    Dim iPeriod As Integer
    iYear = GetCurrentYear()
    iPeriod = GetCurrentPeriod()
    
    Call SetUncheckStatus(iYear, iPeriod)
      
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True

    MsgBox ("快狗提示：反审核成功！")
    
    Unload Me

End Sub


Private Sub txt_num_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    Select Case KeyAscii
        Case 45, 46, vbKey0 To vbKey9, vbKeyBack
        Case Else
            KeyAscii = 0
    End Select
End Sub

Private Sub txt_Year_Change()

End Sub

Private Sub UserForm_Initialize()
    iCurrentYear = GetCurrentYear()
    iCurrentPeriod = GetCurrentPeriod()
    txt_Period.Value = iCurrentPeriod
    txt_Year.Value = iCurrentYear
    
    Dim iUserRows As Integer
    iUserRows = Sheet15.Cells(Rows.Count, 7).End(xlUp).Row

    For i = 2 To iUserRows
        cbo_Checker.AddItem Sheet15.Cells(i, 7)
    Next
    
End Sub
Attribute VB_Name = "frm_Detail"
Attribute VB_Base = "0{11CCF083-1267-494A-8F3C-985CF2918A31}{37C26D4C-D755-4996-BC65-491C4F40B2BB}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btn_Back_Click()

    Unload Me
    Sheet13.Visible = xlSheetHidden
    Sheet1.Activate
    
End Sub
Private Sub btn_Close_Click()

    Unload Me
    
End Sub
Private Sub btn_OK_Click()
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    Dim strAccNum As String
    Dim strAccFullName As String
    Dim strShowName As String
    Dim iYear As Integer
    Dim iPeriodFrom As Integer
    Dim iPeriodTo As Integer
    Dim i As Integer
    Dim iIndex As Integer
    Dim dteMaxDate As Date
    Dim dteMinDate As Date
    Dim dblBeginBal As Double
    Dim dblBeginCredit As Double
    Dim dblBeginDebit As Double
    Dim strCord As String
    Dim strExp As String
    Dim lVchRows As Long
    Dim m As Integer
    Dim n As Long
    Dim x As Integer
    Dim lTempRows As Long
    Dim arr
    
    iYear = CInt(cbo_Year.Value)
    iCurrentYear = GetCurrentYear
    iBeginYear = GetBeginYear
    iBeginPeriod = GetBeginPeriod()
    iOpenPeriod = GetOpenPeriod()
    iPeriodFrom = CInt(cbo_PeriodFrom.Value)
    iPeriodTo = CInt(cbo_PeriodTo.Value)
    dteMaxDate = CDate(GetMaxDate(iYear, iPeriodFrom))
    iIndex = cbo_Account.ListIndex
    strAccNum = CStr(cbo_Account.Value)
    strAccFullName = cbo_Account.Column(1, iIndex)
    strShowName = strAccNum & "-" & strAccFullName
    n = 3
    x = 1
    
'条件判断
    If iPeriodFrom > iPeriodTo Then
        MsgBox "会计区间选择有误，请重新选择！"
        Exit Sub
    End If
'先删除数据
    Call ClearDetailColor
    Call ClearDetailData
    Call AddSheetTemp
    Call SetTempDetailTitle
    Sheet13.Activate
    If iYear = iBeginYear Then
        If iPeriodFrom <= iOpenPeriod Then
            iPeriodFrom = iOpenPeriod
        End If
        If iPeriodTo <= iOpenPeriod Then
            iPeriodTo = iOpenPeriod
        End If
    End If
  
'期初数或年初数
    dblBeginBal = GetBeginBal(strAccNum, iYear, iPeriodFrom)
    Dim lAccRow As Long
    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
    Else
        lAccRow = 0
    End If
    dblBeginDebit = Sheet12.Cells(lAccRow, 11)
    dblBeginCredit = Sheet12.Cells(lAccRow, 12)

    If lAccRow > 0 Then
        dteMinDate = CDate(GetMinDate(iYear, iPeriodFrom))
        If iPeriodFrom = 1 Then
            strExp = "年初余额"
        Else
            strExp = "期初余额"
        End If
        If Sheet12.Cells(lAccRow, 6) = "借方" Then
            If dblBeginBal > 0 Then
                strCord = "借"
            ElseIf dblBeginBal < 0 Then
                strCord = "贷"
            Else
                strCord = "平"
            End If
        Else
            If dblBeginBal > 0 Then
                strCord = "贷"
            ElseIf dblBeginBal < 0 Then
                strCord = "借"
            Else
                strCord = "平"
            End If
        End If
    End If
    
    
    With Sheets("Temp")
        .Cells(2, 1) = iYear
        .Cells(2, 2) = iPeriodFrom
        .Cells(2, 3) = dteMinDate
        .Cells(2, 4) = ""
        .Cells(2, 5) = ""
        .Cells(2, 6) = strExp
        .Cells(2, 7) = ""
        .Cells(2, 8) = ""
        .Cells(2, 9) = strCord
        .Cells(2, 10) = Abs(dblBeginBal)
        .Cells(2, 11) = -1
    End With
    
'建立数组
    ReDim arr(1 To 12, 1 To 5)
        arr(1, 1) = 1
        arr(2, 1) = 2
        arr(3, 1) = 3
        arr(4, 1) = 4
        arr(5, 1) = 5
        arr(6, 1) = 6
        arr(7, 1) = 7
        arr(8, 1) = 8
        arr(9, 1) = 9
        arr(10, 1) = 10
        arr(11, 1) = 11
        arr(12, 1) = 12
        
'添加累计数
    If iYear = iBeginYear Then
        For y = 1 To 12
            arr(y, 4) = dblBeginDebit
            arr(y, 5) = dblBeginCredit
        Next
    End If
    
'日数据
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    If lVchRows >= 3 Then
        For l = 3 To lVchRows
            If Sheet17.Cells(l, 9) = strAccNum And Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) < iPeriodFrom Then
                For j = 1 To UBound(arr)
                    If arr(j, 1) > Sheet17.Cells(l, 3) Then
                        arr(j, 4) = arr(j, 4) + Sheet17.Cells(l, 11)
                        arr(j, 5) = arr(j, 5) + Sheet17.Cells(l, 12)
                    End If
                Next
            ElseIf Sheet17.Cells(l, 9) = strAccNum And Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) >= iPeriodFrom And Sheet17.Cells(l, 3) <= iPeriodTo Then
                For k = 1 To UBound(arr)
                    If arr(k, 1) = Sheet17.Cells(l, 3) Then
                        arr(k, 2) = arr(k, 2) + Sheet17.Cells(l, 11)
                        arr(k, 3) = arr(k, 3) + Sheet17.Cells(l, 12)
                    End If
                    If arr(k, 1) >= Sheet17.Cells(l, 3) Then
                        arr(k, 4) = arr(k, 4) + Sheet17.Cells(l, 11)
                        arr(k, 5) = arr(k, 5) + Sheet17.Cells(l, 12)
                    End If
                Next
                With Sheets("Temp")
                    .Cells(n, 1) = Sheet17.Cells(l, 2)
                    .Cells(n, 2) = Sheet17.Cells(l, 3)
                    .Cells(n, 3) = CDate(Sheet17.Cells(l, 4))
                    .Cells(n, 4) = Sheet17.Cells(l, 5)
                    .Cells(n, 5) = Sheet17.Cells(l, 6)
                    .Cells(n, 6) = Sheet17.Cells(l, 8)
                    .Cells(n, 7) = Sheet17.Cells(l, 11)
                    .Cells(n, 8) = Sheet17.Cells(l, 12)
                    .Cells(n, 9) = ""
                    .Cells(n, 10) = 0
                    .Cells(n, 11) = 0
                   n = n + 1
                End With
            End If
        Next
    End If
    
'添加本月合计和本年累计
    Dim lTempDayRows As Long
    With Worksheets("Temp")
        lTempDayRows = .Cells(.Rows.Count, 1).End(xlUp).Row
        For x = 1 To 12
            If Abs(arr(x, 2)) + Abs(arr(x, 3)) > 0 Then
                .Cells(lTempDayRows + 1, 1) = iYear
                .Cells(lTempDayRows + 1, 2) = x
                .Cells(lTempDayRows + 1, 6) = "本月合计"
                .Cells(lTempDayRows + 1, 7) = arr(x, 2)
                .Cells(lTempDayRows + 1, 8) = arr(x, 3)
                .Cells(lTempDayRows + 1, 11) = 1
                lTempDayRows = lTempDayRows + 1
            End If
            If Abs(arr(x, 2)) + Abs(arr(x, 3)) > 0 And Abs(arr(x, 4)) + Abs(arr(x, 5)) > 0 And arr(x, 1) <= iPeriodTo Then
                .Cells(lTempDayRows + 1, 1) = iYear
                .Cells(lTempDayRows + 1, 2) = x
                .Cells(lTempDayRows + 1, 6) = "本年累计"
                .Cells(lTempDayRows + 1, 7) = arr(x, 4)
                .Cells(lTempDayRows + 1, 8) = arr(x, 5)
                .Cells(lTempDayRows + 1, 11) = 2
                lTempDayRows = lTempDayRows + 1
            End If
        Next
    End With
            
    Sheet13.Cells(2, 2) = strShowName

    Call SortTempDetailData
    Call CopyTempDetailData
    Call CalDetailData
    Call SetDetailColor
    Call DeleteSheetTemp
    Unload Me
    
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
End Sub
Private Sub UserForm_Initialize()

    iBeginYear = CInt(GetBeginYear)
    iBeginPeriod = CInt(GetBeginPeriod())
    iOpenPeriod = CInt(GetOpenPeriod())
    iCurrentYear = CInt(GetCurrentYear)
    iCurrentPeriod = CInt(GetCurrentPeriod)
'设置年份下列框
    If iBeginYear = iCurrentYear Then
        cbo_Year.AddItem iBeginYear
        cbo_Year.Value = iBeginYear
    ElseIf iCurrentYear > iBeginYear Then
        For i = iBeginYear To iCurrentYear
            cbo_Year.AddItem i
        Next
        cbo_Year.Value = iBeginYear
    End If
'设置月份下列框
    For i = 1 To 12
        cbo_PeriodFrom.AddItem i
        cbo_PeriodTo.AddItem i
    Next
    cbo_PeriodFrom.Value = 1
    cbo_PeriodTo.Value = 1
'科目选择
    With Me.cbo_Account
        .List = ArrAccDetail
        .ListIndex = 0
    End With
End Sub
Attribute VB_Name = "frm_EndVch"
Attribute VB_Base = "0{575D5A57-0028-426E-A62B-2A0A1C139F72}{F80C26AA-0A2C-40BC-81D8-D48DA824984E}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btn_Cancel_Click()
    Me.Hide
End Sub
Private Sub btn_OK_Click()
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    If cbo_Group.Value = "" Then
        MsgBox ("结转损益凭证字不能为空，请选择！"): Exit Sub
    End If
    
    If cbo_Maker.Value = "" Then
        MsgBox ("制单人不能为空，请选择！"): Exit Sub
    End If

    If MsgBox("是否结转本期损益？", vbOKCancel, "结转损益") = vbOK Then
    
        Dim strMaker As String
        Dim strGroup As String
        strMaker = CStr(cbo_Maker.Value)
        strGroup = CStr(cbo_Group.Value)
        
        Call GetEndVch(strGroup, strMaker)
        
    End If
    
    Unload Me
    
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
End Sub

Private Sub UserForm_Initialize()

    Dim strGroup As String
    Dim strUsers As String
    
    Dim iGroupRows As Integer
    Dim iUserRows As Integer
    iGroupRows = Sheet15.Cells(Rows.Count, 6).End(xlUp).Row
    
     For i = 2 To iGroupRows
        strGroup = Sheet15.Cells(i, 6)
        cbo_Group.AddItem strGroup
     Next
        cbo_Group.ListIndex = 0
    
    iUserRows = Sheet15.Cells(Rows.Count, 7).End(xlUp).Row
        For i = 2 To iUserRows
        strUser = Sheet15.Cells(i, 7)
        cbo_Maker.AddItem strUser
    Next


End Sub
Attribute VB_Name = "frm_Ledger"
Attribute VB_Base = "0{3F20A4C7-C130-4A60-9E28-09DC66E81BB6}{B3910A96-9D17-4708-ADE7-19FDB5048757}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub clearLedgerTempData()

    Dim lTempRows As Long
    lTempRows = Sheet14.Cells(Rows.Count, 27).End(xlUp).Row
    
    If lTempRows >= 2 Then
    
    Sheet14.Range("AA2:AK" & lTempRows).Select
    With Selection.Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
    End With
    Selection.ClearContents
    End If
    
End Sub
Private Sub sortLedgerTempData()

    Dim lTempRows As Long
    lTempRows = Sheet14.Cells(Rows.Count, 27).End(xlUp).Row
    
    If lTempRows >= 2 Then
    
    Range("AA1:AK" & lTempRows).Select
    ActiveWorkbook.Worksheets("总账").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("总账").Sort.SortFields.Add Key:=Range("AB2:AB" & lTempRows), _
        SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    ActiveWorkbook.Worksheets("总账").Sort.SortFields.Add Key:=Range("AK2:AK" & lTempRows), _
        SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    ActiveWorkbook.Worksheets("总账").Sort.SortFields.Add Key:=Range("AC2:AC" & lTempRows), _
        SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    ActiveWorkbook.Worksheets("总账").Sort.SortFields.Add Key:=Range("AD2:AD" & lTempRows), _
        SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal

    With ActiveWorkbook.Worksheets("总账").Sort
        .SetRange Range("AA1:AK" & lTempRows)
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    
    End If
    
End Sub
Private Sub btn_Back_Click()

    Unload Me
    Sheet14.Visible = xlSheetHidden
    Sheet1.Activate
 
End Sub

Private Sub btn_Cancel_Click()
    Unload Me
End Sub
Private Sub btn_OK_Click()
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    Dim strAccNum As String
    Dim strShowName As String
    Dim iAccLevel As Integer
    Dim iIsLastLevel As Integer
    Dim iYear As Integer
    Dim iPeriodFrom As Integer
    Dim iPeriodTo As Integer
    Dim i As Integer
    Dim iIndex As Integer
    Dim dblBeginBal As Double
    Dim dblBeginDebit As Double
    Dim dblBeginCredit As Double
    Dim dblTotalDebit As Double
    Dim dblTotalCredit As Double
    Dim iMinVchNum As Integer
    Dim iMaxVchNum As Integer
    Dim lVchRows As Long
    Dim strCord As String
    Dim strExp As String
    Dim lLedgerTempRows As Long
    
    iYear = CInt(cbo_Year.Value)
    iBeginPeriod = CInt(GetBeginPeriod())
    iOpenPeriod = CInt(GetOpenPeriod())
    iPeriodFrom = CInt(cbo_PeriodFrom.Value)
    iPeriodTo = CInt(cbo_PeriodTo.Value)
    iIndex = cbo_Account.ListIndex
    strAccNum = cbo_Account.Value
    strAccFullName = cbo_Account.Column(1, iIndex)
    strShowName = strAccNum & "-" & strAccFullName
    
'条件判断
    If iPeriodFrom > iPeriodTo Then
        MsgBox "会计区间选择有误，请重新选择！"
        Exit Sub
    End If
'
'先删除数据
    Call ClearLedgerColor
    Call ClearLedgerData
    Call AddSheetTemp
    Call SetTempLedgerTitle
    Sheet14.Activate
    
    If iYear = iBeginYear Then
        If iPeriodFrom <= iOpenPeriod Then
            iPeriodFrom = iOpenPeriod
        End If
        If iPeriodTo <= iOpenPeriod Then
            iPeriodTo = iOpenPeriod
        End If
    End If

'期初数或年初数
    dblBeginBal = GetBeginBalLedger(strAccNum, iYear, iPeriodFrom)
    Dim lAccRow As Long
    Set r = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("B:B").Find(strAccNum, LookAt:=xlWhole).Row
    Else
        lAccRow = 0
    End If
    dblBeginDebit = Sheet12.Cells(lAccRow, 11)
    dblBeginCredit = Sheet12.Cells(lAccRow, 12)

    If lAccRow > 0 Then
        If iPeriodFrom = 1 Then
            strExp = "年初余额"
        Else
            strExp = "期初余额"
        End If
        If Sheet12.Cells(lAccRow, 6) = "借方" Then
            If dblBeginBal > 0 Then
                strCord = "借"
            ElseIf dblBeginBal < 0 Then
                strCord = "贷"
            Else
                strCord = "平"
            End If
        Else
            If dblBeginBal > 0 Then
                strCord = "贷"
            ElseIf dblBeginBal < 0 Then
                strCord = "借"
            Else
                strCord = "平"
            End If
        End If
    End If
    
    With Sheets("Temp")
        .Cells(2, 1) = iYear
        .Cells(2, 2) = iPeriodFrom
        .Cells(2, 3) = strExp
        .Cells(2, 4) = ""
        .Cells(2, 5) = ""
        .Cells(2, 6) = strCord
        .Cells(2, 7) = Abs(dblBeginBal)
        .Cells(2, 8) = -1
    End With
    
'建立数组
    ReDim arr(1 To 12, 1 To 5)
        arr(1, 1) = 1
        arr(2, 1) = 2
        arr(3, 1) = 3
        arr(4, 1) = 4
        arr(5, 1) = 5
        arr(6, 1) = 6
        arr(7, 1) = 7
        arr(8, 1) = 8
        arr(9, 1) = 9
        arr(10, 1) = 10
        arr(11, 1) = 11
        arr(12, 1) = 12
        
'添加累计数
    If iYear = iBeginYear Then
        For y = 1 To 12
            arr(y, 4) = dblBeginDebit
            arr(y, 5) = dblBeginCredit
        Next
    End If
    
'日数据汇总
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    If lVchRows >= 3 Then
        For l = 3 To lVchRows
            If Left(Sheet17.Cells(l, 9), 4) = strAccNum And Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) < iPeriodFrom Then
                For j = 1 To UBound(arr)
                    If arr(j, 1) > Sheet17.Cells(l, 3) Then
                        arr(j, 4) = arr(j, 4) + Sheet17.Cells(l, 11)
                        arr(j, 5) = arr(j, 5) + Sheet17.Cells(l, 12)
                    End If
                Next
            ElseIf Left(Sheet17.Cells(l, 9), 4) = strAccNum And Sheet17.Cells(l, 2) = iYear And Sheet17.Cells(l, 3) >= iPeriodFrom And Sheet17.Cells(l, 3) <= iPeriodTo Then
                For k = 1 To UBound(arr)
                    If arr(k, 1) = Sheet17.Cells(l, 3) Then
                        arr(k, 2) = arr(k, 2) + Sheet17.Cells(l, 11)
                        arr(k, 3) = arr(k, 3) + Sheet17.Cells(l, 12)
                    End If
                    If arr(k, 1) >= Sheet17.Cells(l, 3) Then
                        arr(k, 4) = arr(k, 4) + Sheet17.Cells(l, 11)
                        arr(k, 5) = arr(k, 5) + Sheet17.Cells(l, 12)
                    End If
                Next
            End If
        Next
    End If
            
'添加本月合计和本年累计
    Dim lTempDayRows As Long
    With Worksheets("Temp")
        lTempDayRows = .Cells(.Rows.Count, 1).End(xlUp).Row
        For x = 1 To 12
            If Abs(arr(x, 2)) + Abs(arr(x, 3)) > 0 Then
                .Cells(lTempDayRows + 1, 1) = iYear
                .Cells(lTempDayRows + 1, 2) = x
                .Cells(lTempDayRows + 1, 3) = "本月合计"
                .Cells(lTempDayRows + 1, 4) = arr(x, 2)
                .Cells(lTempDayRows + 1, 5) = arr(x, 3)
                .Cells(lTempDayRows + 1, 8) = 1
                lTempDayRows = lTempDayRows + 1
            End If
            If Abs(arr(x, 2)) + Abs(arr(x, 3)) > 0 And Abs(arr(x, 4)) + Abs(arr(x, 5)) > 0 And arr(x, 1) <= iPeriodTo Then
                .Cells(lTempDayRows + 1, 1) = iYear
                .Cells(lTempDayRows + 1, 2) = x
                .Cells(lTempDayRows + 1, 3) = "本年累计"
                .Cells(lTempDayRows + 1, 4) = arr(x, 4)
                .Cells(lTempDayRows + 1, 5) = arr(x, 5)
                .Cells(lTempDayRows + 1, 8) = 2
                lTempDayRows = lTempDayRows + 1
            End If
        Next
    End With
    
    Sheet14.Cells(2, 2) = strShowName
    Call CopyTempLedgerData
    Call CalLedgerData
    Call SetLedgerColor
    Call DeleteSheetTemp
    Unload Me

Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
End Sub
Private Sub UserForm_Initialize()

    iBeginYear = CInt(GetBeginYear)
    iBeginPeriod = CInt(GetBeginPeriod())
    iOpenPeriod = CInt(GetOpenPeriod())
    iCurrentYear = CInt(GetCurrentYear)
    iCurrentPeriod = CInt(GetCurrentPeriod)
    
'设置年份下列框
    If iBeginYear = iCurrentYear Then
        cbo_Year.AddItem iBeginYear
        cbo_Year.Value = iBeginYear
    ElseIf iCurrentYear > iBeginYear Then
        For i = iBeginYear To iCurrentYear
            cbo_Year.AddItem i
        Next
        cbo_Year.Value = iBeginYear
    End If
'设置月份下列框
    For i = 1 To 12
        cbo_PeriodFrom.AddItem i
        cbo_PeriodTo.AddItem i
    Next
    cbo_PeriodFrom.Value = 1
    cbo_PeriodTo.Value = 1
'科目列表
    With Me.cbo_Account
        .List = ArrAccLedger
        .ListIndex = 0
    End With

End Sub
Attribute VB_Name = "frm_Multi"
Attribute VB_Base = "0{2736D1D6-8F1F-4A68-833E-80732507D9B9}{576DF749-3FA7-49E2-93AB-ABF7C9114E38}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub cmd_Cancel_Click()

    Me.Hide
    
End Sub
Private Sub cmd_OK_Click()
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    Dim strAccNum As String
    Dim strAccFullName As String
    Dim strShowName As String
    Dim iYear As Integer
    Dim iPeriodFrom As Integer
    Dim iPeriodTo As Integer
    Dim i As Integer
    Dim iIndex As Integer
    Dim dteMaxDate As Date
    Dim dteMinDate As Date
    Dim dblBeginBal As Double
    Dim strCord As String
    Dim strExp As String
    
    iBeginPeriod = CInt(GetBeginPeriod())
    iOpenPeriod = CInt(GetOpenPeriod())
    iPeriodFrom = CInt(cbo_PeriodFrom.Value)
    iPeriodTo = CInt(cbo_PeriodTo.Value)
    iYear = CInt(Sheet15.Cells(2, 2))
    dteMinDate = GetMinDate(iYear, iPeriodFrom)
    dteMaxDate = GetMaxDate(iYear, iPeriodFrom)
    iIndex = cbo_Account.ListIndex
    strAccNum = cbo_Account.Value
    strAccFullName = cbo_Account.Column(1, iIndex)
    strShowName = strAccNum & "-" & strAccFullName
    
'条件判断
    If iPeriodFrom < iBeginPeriod Then
       MsgBox ("开始期间不能大于业务开始期间，不能查询！"): Exit Sub
    End If
'
    If iPeriodFrom > iPeriodTo Then
        MsgBox ("开始期间不能小于结束期间，不能查询！"): Exit Sub
    End If

'
   '先删除数据
    'Call clearDetailColor
    'Call clearDetailData
    'Call clearDetailTemp
    'Call createDetailTemp

'先判断余额表期初有没有数据
    Dim lAccRow As Long

    Set r = Sheet12.Columns("A:A").Find(strAccNum)
    If Not r Is Nothing Then
        lAccRow = Sheet12.Columns("A:A").Find(strAccNum, LookAt:=xlWhole).Row
    Else
        lAccRow = 0
    End If

    If lAccRow > 0 Then
        If iPeriodFrom = 1 Then
            If iOpenPeriod = 1 Then
                dblBeginBal = Sheet12.Cells(lAccRow, 12)
            Else
                dblBeginBal = Sheet12.Cells(lAccRow, 9)
            End If
            strExp = "年初余额"
        ElseIf iPeriodFrom >= 2 Then
            If iOpenPeriod < iPeriodFrom Then
                dblBeginBal = Sheet12.Cells(lAccRow, 12)
                If Sheet12.Cells(lAccRow, 5) = "借方" Then
                    For i = iOpenPeriod To iPeriodFrom - 1
                        dblBeginBal = dblBeginBal + Sheet12.Cells(lAccRow, 11 + 2 * i) - Sheet12.Cells(lAccRow, 12 + 2 * i)
                    Next
                Else
                    For i = iOpenPeriod To iPeriodFrom - 1
                        dblBeginBal = dblBeginBal - Sheet12.Cells(lAccRow, 11 + 2 * i) + Sheet12.Cells(lAccRow, 12 + 2 * i)
                    Next
                End If
            ElseIf iOpenPeriod = iPeriodFrom Then
                dblBeginBal = Sheet12.Cells(lAccRow, 12)
            ElseIf iOpenPeriod > iPeriodFrom Then
                dblBeginBal = Sheet12.Cells(lAccRow, 9)
            End If
            strExp = "期初余额"
        End If

        If Sheet12.Cells(lAccRow, 5) = "借方" Then
            If dblBeginBal > 0 Then
                strCord = "借"
            ElseIf dblBeginBal < 0 Then
                strCord = "贷"
            Else
                strCord = "平"
            End If
        Else
            If dblBeginBal > 0 Then
                strCord = "贷"
            ElseIf dblBeginBal < 0 Then
                strCord = "借"
            Else
                strCord = "平"
            End If
        End If
        
    End If
    
    With Sheet7
        .Cells(2, 131) = iPeriodFrom
        .Cells(2, 132) = dteMinDate
        .Cells(2, 133) = ""
        .Cells(2, 134) = ""
        .Cells(2, 135) = strExp
        .Cells(2, 136) = ""
        .Cells(2, 137) = ""
        .Cells(2, 138) = strCord
        .Cells(2, 139) = Abs(dblBeginBal)
        .Cells(2, 140) = -1
    End With
    
    sqlOpen

    '1 明细数据
    Dim strDaySql As String
    Dim strDaySumSql As String
    Dim rstDaySet As New ADODB.Recordset
    Dim rstDaySumSet As New ADODB.Recordset
    Dim lDetailRows As Long
    
    strDaySql = " select 会计期间,凭证日期,凭证字,凭证号,摘要,借方金额,贷方金额,'',0,0 from [凭证薄$A2:P] where 科目代码=" & "'" & strAccNum & "'" & "  and 会计期间>=" & iPeriodFrom & " and 会计期间<=" & iPeriodTo & "  "
    Set rstDaySet = getRecordset(strDaySql)
    lDetailRows = Sheet13.Cells(Rows.Count, 27).End(xlUp).Row
    Sheet13.Cells(lDetailRows + 1, 27).CopyFromRecordset rstDaySet

    '2 日汇总
    If chk_Day.Value = True Then
        strDaySumSql = "select 期间, 日期,'','','本日合计',sum(借方金额),sum(贷方金额),'',0,1 from [明细账$AA1:AJ] where 排序=0 group by 日期,期间"
        Set rstDaySumSet = getRecordset(strDaySumSql)
        lDetailRows = Sheet13.Cells(Rows.Count, 27).End(xlUp).Row
        Sheet13.Cells(lDetailRows + 1, 27).CopyFromRecordset rstDaySumSet
    End If
    
    '3月汇总

    Dim strExistSql As String
    Dim strMonthSumSql As String
    Dim strYearSumSql As String
    Dim rstExistSet As New ADODB.Recordset
    Dim rstMonthSumSet As New ADODB.Recordset
    Dim rstYearSet As New ADODB.Recordset
    
    For i = iPeriodFrom To iPeriodTo
        If i = iBeginPeriod And iBeginPeriod < iOpenPeriod Then
            lDetailRows = Sheet13.Cells(Rows.Count, 27).End(xlUp).Row
                 With Sheet13
                    .Cells(lDetailRows + 1, 27) = iPeriodFrom
                    .Cells(lDetailRows + 1, 28) = dteMaxDate
                    .Cells(lDetailRows + 1, 29) = ""
                    .Cells(lDetailRows + 1, 30) = ""
                    .Cells(lDetailRows + 1, 31) = "本期合计"
                    .Cells(lDetailRows + 1, 32) = Sheet12.Cells(lAccRow, 10)
                    .Cells(lDetailRows + 1, 33) = Sheet12.Cells(lAccRow, 11)
                    .Cells(lDetailRows + 1, 34) = ""
                    .Cells(lDetailRows + 1, 35) = Sheet12.Cells(lAccRow, 12)
                    .Cells(lDetailRows + 1, 36) = 1
                    .Cells(lDetailRows + 2, 27) = iPeriodFrom
                    .Cells(lDetailRows + 2, 28) = dteMaxDate
                    .Cells(lDetailRows + 2, 29) = ""
                    .Cells(lDetailRows + 2, 30) = ""
                    .Cells(lDetailRows + 2, 31) = "本年累计"
                    .Cells(lDetailRows + 2, 32) = Sheet12.Cells(lAccRow, 10)
                    .Cells(lDetailRows + 2, 33) = Sheet12.Cells(lAccRow, 11)
                    .Cells(lDetailRows + 2, 34) = ""
                    .Cells(lDetailRows + 2, 35) = Sheet12.Cells(lAccRow, 12)
                    .Cells(lDetailRows + 2, 36) = 2
                End With
        Else
            dteMaxDate = GetMaxDate(iYear, i)
            strExistSql = "select 期间,日期,凭证字,凭证号,摘要,借方金额,贷方金额,方向,余额,排序 from [明细账$AA1:AJ] where 期间 = " & i
            Set rstExistSet = getRecordset(strExistSql)
         
            If Not rstExistSet.EOF Then
                strMonthSumSql = "select max(期间), " & "'" & dteMaxDate & "'" & " ,'','','本期合计',sum(借方金额),sum(贷方金额),'',0,1 from [明细账$AA1:AJ] where 排序 in (0,-1) and 期间 = " & i & " group by 期间"
                Set rstMonthSumSet = getRecordset(strMonthSumSql)
                lDetailRows = Sheet13.Cells(Rows.Count, 27).End(xlUp).Row
                Sheet13.Cells(lDetailRows + 1, 27).CopyFromRecordset rstMonthSumSet
                
                strYearSumSql = "select max(期间), " & "'" & dteMaxDate & "'" & " ,'','','本年累计',sum(借方金额),sum(贷方金额),'',0,2 from [明细账$AA1:AJ] where 排序 in( 1) and 期间>=" & iPeriodFrom & " and 期间 <=" & i & " "
                Set rstYearSumSet = getRecordset(strYearSumSql)
                lDetailRows = Sheet13.Cells(Rows.Count, 27).End(xlUp).Row
                Sheet13.Cells(lDetailRows + 1, 27).CopyFromRecordset rstYearSumSet
            Else
                If i = 12 Then
                    dteMaxDate = GetMaxDate(iYear, i)
                    lDetailRows = Sheet13.Cells(Rows.Count, 27).End(xlUp).Row
        
                    With Sheet13
                       .Cells(lDetailRows + 1, 27) = i
                       .Cells(lDetailRows + 1, 28) = dteMaxDate
                       .Cells(lDetailRows + 1, 29) = ""
                       .Cells(lDetailRows + 1, 30) = ""
                       .Cells(lDetailRows + 1, 31) = "本期合计"
                       .Cells(lDetailRows + 1, 32) = ""
                       .Cells(lDetailRows + 1, 33) = ""
                       .Cells(lDetailRows + 1, 34) = ""
                       .Cells(lDetailRows + 1, 35) = ""
                       .Cells(lDetailRows + 1, 36) = 2
                    End With
                    
                    strYearSumSql = "select " & i & ", " & "'" & dteMaxDate & "'" & " ,'','','本年累计',sum(借方金额),sum(贷方金额),'',0,2 from [明细账$AA1:AJ] where 排序=1 and 期间>=" & iPeriodFrom & " and 期间 <= 12 "
                    Set rstYearSumSet = getRecordset(strYearSumSql)
                    lDetailRows = Sheet13.Cells(Rows.Count, 27).End(xlUp).Row
                    Sheet13.Cells(lDetailRows + 1, 27).CopyFromRecordset rstYearSumSet
                End If
            End If
        End If
  Next i

'如果是12月

    If iPeriodTo = 12 Then
        dteMaxDate = GetMaxDate(iYear, 12)
        lDetailRows = Sheet13.Cells(Rows.Count, 27).End(xlUp).Row
    With Sheet13
       .Cells(lDetailRows + 1, 27) = 12
       .Cells(lDetailRows + 1, 28) = dteMaxDate
       .Cells(lDetailRows + 1, 29) = ""
       .Cells(lDetailRows + 1, 30) = ""
       .Cells(lDetailRows + 1, 31) = "结转下年"
       .Cells(lDetailRows + 1, 32) = ""
       .Cells(lDetailRows + 1, 33) = ""
       .Cells(lDetailRows + 1, 34) = ""
       .Cells(lDetailRows + 1, 35) = ""
       .Cells(lDetailRows + 1, 36) = 4
    End With
    End If
    
    lDetailRows = Sheet13.Cells(Rows.Count, 28).End(xlUp).Row
    
    Range("AB2:AB" & lDetailRows).Select
    Selection.TextToColumns Destination:=Range("AB2"), DataType:=xlDelimited, _
        TextQualifier:=xlDoubleQuote, ConsecutiveDelimiter:=False, Tab:=True, _
        Semicolon:=False, Comma:=False, Space:=False, Other:=False, FieldInfo _
        :=Array(1, 5), TrailingMinusNumbers:=True
    
    Sheet13.Cells(2, 1) = strShowName
    
    Call setTempDateFormat
    Call sortTempData
    Call CopyTempData
    Call CalDetailData
    Call SetDetailColor
    'Call clearDetailTemp
    
sqlClose

    Unload Me
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True

End Sub

Private Sub UserForm_Initialize()

    iBeginPeriod = CInt(GetBeginPeriod())
    iOpenPeriod = CInt(GetOpenPeriod())
    
    If iBeginPeriod = iOpenPeriod Then
        For i = iBeginPeriod To 12
            cbo_PeriodFrom.AddItem i
        Next
    Else
        cbo_PeriodFrom.AddItem iBeginPeriod
        For i = iOpenPeriod To 12
            cbo_PeriodFrom.AddItem i
        Next
    End If
    
    cbo_PeriodFrom.Value = iBeginPeriod
    
    If iBeginPeriod = iOpenPeriod Then
        For i = iBeginPeriod To 12
            cbo_PeriodTo.AddItem i
        Next
    Else
        cbo_PeriodTo.AddItem iBeginPeriod
        For i = iOpenPeriod To 12
            cbo_PeriodTo.AddItem i
        Next
    End If
    
    cbo_PeriodTo.Value = iBeginPeriod
    
    With Me.cbo_Account
        .List = arrAccMulti
        .ListIndex = 0
    End With
    
End Sub
Attribute VB_Name = "frm_Post"
Attribute VB_Base = "0{8B729D33-65C3-49A6-BFA6-6D6BD5887789}{5ED751F2-E7AE-4239-BF1C-30C42992BF39}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btn_Cancel_Click()

    Unload Me
    
End Sub
Private Sub btn_Post_Click()

Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    If cbo_Poster.Value = "" Then
        MsgBox ("记账人不能为空，请选择！"): Exit Sub
    End If

    Dim iYear As Integer
    Dim iPeriod As Integer
    Dim strPoster As String
    
    iYear = GetCurrentYear()
    iPeriod = GetCurrentPeriod()
    strPoster = CStr(cbo_Poster.Text)
    
    Call SetPostStatus(iYear, iPeriod, strPoster)
      
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True

    MsgBox ("快狗提示：记账成功！")
    
    Unload Me
    
End Sub

Private Sub btn_UnPost_Click()

Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    Dim iYear As Integer
    Dim iPeriod As Integer
    iYear = GetCurrentYear()
    iPeriod = GetCurrentPeriod()
    
    Call SetUnpostStatus(iYear, iPeriod)
      
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True

    MsgBox ("快狗提示：反记账成功！")
    
    Unload Me

End Sub
Private Sub cmd_clear_Click()

    cbo_Group.Text = ""
    cbo_Poster.Text = ""
    txt_Num.Text = ""
    
End Sub

Private Sub txt_num_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    Select Case KeyAscii
        Case 45, 46, vbKey0 To vbKey9, vbKeyBack
        Case Else
            KeyAscii = 0
    End Select
End Sub
Private Sub UserForm_Initialize()

    iCurrentYear = GetCurrentYear()
    iCurrentPeriod = GetCurrentPeriod()
    txt_Year.Value = iCurrentYear
    txt_Period.Value = iCurrentPeriod
    
    Dim iUserRows As Integer
    iUserRows = Sheet15.Cells(Rows.Count, 7).End(xlUp).Row

    For i = 2 To iUserRows
        cbo_Poster.AddItem Sheet15.Cells(i, 7)
    Next
    
End Sub
Attribute VB_Name = "frm_Reg"
Attribute VB_Base = "0{1DC82B33-01AD-4BA0-A576-2FDE234933BC}{5D2780DB-8B9F-405D-B105-CC97491F4B1C}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btn_Cancel_Click()

    Me.Show
    
End Sub
Attribute VB_Name = "frm_Settle"
Attribute VB_Base = "0{F39EBAF2-2905-4E19-A970-59FA40958FF5}{F12C67FB-B6DD-4C1D-8BF0-522099949526}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btn_Cancel_Click()
    Unload Me
End Sub
Private Sub btn_Settle_Click()

    Dim iYear As Integer
    Dim iPeriod As Integer
    Dim dteMinDate As Date
    
    iYear = CInt(txt_Year.Value)
    iPeriod = CInt(txt_Period.Value)

    If MsgBox("是否结转到下一期？", vbOKCancel, "期末结账") = vbOK Then
        If iPeriod = 12 Then
            Sheet15.Cells(5, 3) = Sheet15.Cells(5, 3) + 1
            Sheet15.Cells(6, 3) = 1
            iCurrentYear = iCurrentYear + 1
            iCurrentPeriod = 1
            iReportPeriod = 1
        Else
            Sheet15.Cells(6, 3) = Sheet15.Cells(6, 3) + 1
            iCurrentPeriod = iPeriod + 1
            iReportPeriod = iPeriod + 1
        End If
            With Application
                .StatusBar = "当前期间：" & iCurrentYear & "年" & iCurrentPeriod & "月"
                .ScreenUpdating = False
            End With
            
            dteMinDate = GetMinDate(iCurrentYear, iCurrentPeriod)
            Sheet5.Cells(2, 6) = dteMinDate
            
            MsgBox "快狗提示：结账成功！"
    End If
    
    Unload Me

End Sub
Private Sub btn_UnSettle_Click()

    Dim iYear As Integer
    Dim iPeriod As Integer
    Dim dteMaxDate As Date
    
    iYear = CInt(txt_Year.Value)
    iPeriod = CInt(txt_Period.Value)
    iCurrentYear = GetCurrentYear()
    iOpenPeriod = GetOpenPeriod()
    iBeginYear = GetBeginYear()
        
    If iPeriod = iOpenPeriod And iYear = iBeginYear Then
        MsgBox ("当前期间为系统启用期间，不能反结账！"): Exit Sub
    ElseIf iPeriod = 1 And iYear = iBeginYear Then
        MsgBox ("当前期间为系统启用期间，不能反结账！"): Exit Sub
    End If

    If MsgBox("是否反结账到上一期？", vbOKCancel, "期末反结账") = vbOK Then
        If iPeriod = 1 And iYear > iBeginYear Then
            Sheet15.Cells(5, 3) = Sheet15.Cells(5, 3) - 1
            Sheet15.Cells(6, 3) = 12
            iCurrentYear = iCurrentYear - 1
            iCurrentPeriod = 12
            iReportPeriod = CInt(iPeriod)
        Else
            Sheet15.Cells(6, 3) = Sheet15.Cells(6, 3) - 1
            iCurrentPeriod = iPeriod - 1
            iReportPeriod = CInt(iPeriod + 1)
        End If
        
            With Application
                .StatusBar = "当前期间：" & iCurrentYear & "年" & iCurrentPeriod & "月"
                .ScreenUpdating = False
            End With
    
            dteMaxDate = GetMaxDate(iCurrentYear, iCurrentPeriod)
            Sheet5.Cells(2, 6) = dteMaxDate
            
            MsgBox "快狗提示：反结账成功！"
    End If
    
    Unload Me
    
End Sub

Private Sub UserForm_Initialize()

    iCurrentYear = GetCurrentYear()
    iCurrentPeriod = GetCurrentPeriod()
    txt_Year.Value = iCurrentYear
    txt_Period.Value = iCurrentPeriod

End Sub


Attribute VB_Name = "frm_VchQuery"
Attribute VB_Base = "0{920AAD44-938C-4F47-9DBA-A0B08884B3F8}{FA953E3D-6AB0-40FF-A003-EEADCD965F6D}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub cmd_Cancel_Click()

    Me.Hide
    
End Sub
Private Sub cmd_Query_Click()
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    Call UnprotectVchData
    Call ClearVchData

    If txt_Num.Value = "" Then
        MsgBox ("凭证号不能为空，请重新输入！"): Exit Sub
    End If

    Dim iPeriod As Integer
    Dim strGroup As String
    Dim iVchNum As Integer
    Dim m As Integer
    
    iCurrentPeriod = GetCurrentPeriod()
    iPeriod = CInt(cbo_Period.Value)
    strGroup = CStr(cbo_Group.Value)
    iVchNum = CInt(txt_Num.Value)
    m = 0
    
    Dim lVchRows As Long
    lVchRows = Sheet17.Cells(Rows.Count, 1).End(xlUp).Row
    If lVchRows >= 3 Then
        For l = 3 To lVchRows
            If Sheet17.Cells(l, 1) = iPeriod And Sheet17.Cells(l, 3) = strGroup And Sheet17.Cells(l, 4) = iVchNum Then
                m = m + 1
            End If
        Next
    End If
    
    If m >= 1 Then
        Dim arr()
        ReDim arr(1 To m, 1 To 16)
        n = 1
        For l = 3 To lVchRows
            If Sheet17.Cells(l, 1) = iPeriod And Sheet17.Cells(l, 3) = strGroup And Sheet17.Cells(l, 4) = iVchNum Then
                arr(n, 1) = Sheet17.Cells(l, 1)
                arr(n, 2) = Sheet17.Cells(l, 2)
                arr(n, 3) = Sheet17.Cells(l, 3)
                arr(n, 4) = Sheet17.Cells(l, 4)
                arr(n, 5) = Sheet17.Cells(l, 5)
                arr(n, 6) = Sheet17.Cells(l, 6)
                arr(n, 7) = Sheet17.Cells(l, 7)
                arr(n, 8) = Sheet17.Cells(l, 8)
                arr(n, 9) = Sheet17.Cells(l, 9)
                arr(n, 10) = Sheet17.Cells(l, 10)
                arr(n, 11) = Sheet17.Cells(l, 11)
                arr(n, 12) = Sheet17.Cells(l, 12)
                arr(n, 13) = Sheet17.Cells(l, 13)
                arr(n, 14) = Sheet17.Cells(l, 14)
                arr(n, 15) = Sheet17.Cells(l, 15)
                arr(n, 16) = Sheet17.Cells(l, 16)
                n = n + 1
            End If
        Next
        
        Dim dteDate As Date
        Dim strMaker As String
        Dim strChecker As String
        Dim strPoster As String
        Dim iAttachment As Integer
        Dim iRowNum As Integer
        Dim strExplanation As String
        Dim strAccNum As String
        Dim strAccFullName As String
        Dim iRow As Integer
        Dim dblDebit As Double
        Dim dblCredit As Double
        
        With Sheet5
            For i = 1 To UBound(arr)
                dteDate = arr(i, 2)
                strGroup = arr(i, 3)
                iVchNum = arr(i, 4)
                iRowNum = arr(i, 5)
                strExplanation = arr(i, 6)
                strAccNum = arr(i, 7)
                strAccFullName = arr(i, 8)
                dblDebit = arr(i, 9)
                dblCredit = arr(i, 10)
                strMaker = arr(i, 12)
                strChecker = arr(i, 13)
                strPoster = arr(i, 14)
                iAttachment = arr(i, 11)
                
                If iRowNum = 1 Then
                    .Cells(2, 6) = dteDate
                    .Cells(2, 11) = strGroup
                    .Cells(2, 12) = iVchNum
                    .Cells(3, 12) = iAttachment
                    .Cells(507, 12) = strMaker
                    .Cells(507, 5) = strPoster
                    .Cells(507, 8) = strCheck
                End If
                
                .Cells(iRowNum + 5, 3) = strExplanation
                .Cells(iRowNum + 5, 5) = strAccNum
                .Cells(iRowNum + 5, 6) = strAccFullName
                If dblDebit <> 0 Then
                    Sheet5.Cells(iRowNum + 5, 9) = dblDebit
                End If
                If dblCredit <> 0 Then
                    Sheet5.Cells(iRowNum + 5, 11) = dblCredit
                End If
            Next
        End With
    Else
        MsgBox "快狗提示：凭证不存在，请重新输入凭证号！"
        Exit Sub
    End If

        Call ProtectVchData
        Me.Hide
    
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
End Sub
Private Sub UserForm_Initialize()

    iOpenPeriod = GetOpenPeriod()
    
    For i = iOpenPeriod To 12
        cbo_Period.AddItem i
    Next
    
    cbo_Period.Value = iOpenPeriod

    Dim iGroupRows As Integer
    lGroupRows = Sheet15.Cells(Rows.Count, 5).End(xlUp).Row
    For l = 2 To lGroupRows
        strGroup = Sheet15.Cells(l, 5)
        cbo_Group.AddItem strGroup
    Next
    cbo_Group.ListIndex = 0

End Sub

Attribute VB_Name = "frm_VchQueryPrint"
Attribute VB_Base = "0{538C7E0E-BA56-4D67-A3BA-EA1E6839F86D}{F54D170C-7612-4934-A0A5-2C6AB6E3C38B}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub cmd_Cancel_Click()

    Me.Hide

End Sub
Private Sub cmd_Query_Click()
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    Call SetVchPrintFormat
    Call ClearVchPrintData

'判断凭证号输入是否为空
    If txt_Num.Value = "" Then
        MsgBox ("凭证号不能为空，请重新输入！"): Exit Sub
    End If
    
    Dim iYear As Integer
    Dim iPeriod As Integer
    Dim iVchNum As Integer
    Dim iPagePrintRows As Integer
    Dim iPages As Integer
    Dim iPageRows As Integer
    Dim m As Integer

    iCurrentPeriod = GetCurrentPeriod()
    iYear = CInt(cbo_Year.Value)
    iPeriod = CInt(cbo_Period.Value)
    iVchNum = CInt(txt_Num.Value)
    iPagePrintRows = Sheet16.Cells(3, 3)
    m = 0

'获取凭证行数
    Dim lVchRows As Long
    lVchRows = Sheet17.Cells(Rows.Count, 2).End(xlUp).Row
    If lVchRows >= 3 Then
        For l = 3 To lVchRows
            If CInt(Sheet17.Cells(l, 2)) = iYear And CInt(Sheet17.Cells(l, 3)) = iPeriod And CInt(Sheet17.Cells(l, 6)) = iVchNum Then
                m = m + 1
            End If
        Next
    End If

'建立凭证数组
    If m >= 1 Then
    Dim arr()
    ReDim arr(1 To m, 1 To 15)
    n = 1
        For l = 3 To lVchRows
            If CInt(Sheet17.Cells(l, 2)) = iYear And CInt(Sheet17.Cells(l, 3)) = iPeriod And CInt(Sheet17.Cells(l, 6)) = iVchNum Then
                arr(n, 1) = Sheet17.Cells(l, 2)
                arr(n, 2) = Sheet17.Cells(l, 3)
                arr(n, 3) = Sheet17.Cells(l, 4)
                arr(n, 4) = Sheet17.Cells(l, 5)
                arr(n, 5) = Sheet17.Cells(l, 6)
                arr(n, 6) = Sheet17.Cells(l, 7)
                arr(n, 7) = Sheet17.Cells(l, 8)
                arr(n, 8) = Sheet17.Cells(l, 9)
                arr(n, 9) = Sheet17.Cells(l, 10)
                arr(n, 10) = Sheet17.Cells(l, 11)
                arr(n, 11) = Sheet17.Cells(l, 12)
                arr(n, 12) = Sheet17.Cells(l, 13)
                arr(n, 13) = Sheet17.Cells(l, 14)
                arr(n, 14) = Sheet17.Cells(l, 15)
                arr(n, 15) = Sheet17.Cells(l, 16)
                n = n + 1
            End If
        Next
    Else
        MsgBox "快狗提示：凭证不存在，请重新输入凭证号！"
        Exit Sub
    End If

    'Call UnprotectVchPrintData

If UBound(arr) >= 1 Then
'判断打印页数
    iPages = 1
    Do While m > iPagePrintRows
        iPages = iPages + 1
        m = m - iPagePrintRows
    Loop

    iPageRows = 7 + iPagePrintRows

    If iPages > 1 Then
        For x = 1 To iPages - 1
            Rows("1:" & iPageRows).Select
            Selection.Copy
            Cells(iPageRows * x + 1, 1).Select
            ActiveSheet.Paste
        Next
        Application.CutCopyMode = False
    End If

'写入数据
    Dim dteDate As Date
    Dim strMaker As String
    Dim strChecker As String
    Dim strPoster As String
    Dim iAttachment As Integer
    Dim iRowNum As Integer
    Dim strExplanation As String
    Dim strAccNum As String
    Dim strAccFullName As String
    Dim iRow As Integer
    Dim dblDebit As Double
    Dim dblCredit As Double
    Dim dblTotalDebit, dblTotalCredit As Double
    Dim j, k As Integer

    With Sheet9
        For i = 1 To UBound(arr)
            dteDate = arr(i, 3)
            strGroup = arr(i, 4)
            iVchNum = arr(i, 5)
            iRowNum = arr(i, 6)
            strExplanation = arr(i, 7)
            strAccNum = arr(i, 8)
            strAccFullName = arr(i, 9)
            dblDebit = arr(i, 10)
            dblCredit = arr(i, 11)
            strMaker = arr(i, 13)
            strChecker = arr(i, 14)
            strPoster = arr(i, 15)
            iAttachment = arr(i, 12)
            If iPages = 1 Then
                If iRowNum = 1 Then
                    .Cells(1, 10) = "第1页 共1页"
                    .Cells(2, 5) = dteDate
                    .Cells(2, 10) = strGroup
                    .Cells(2, 11) = iVchNum
                    .Cells(3, 11) = iAttachment
                    .Cells(iPagePrintRows + 6, 11) = strMaker
                    .Cells(iPagePrintRows + 6, 4) = strPoster
                    .Cells(iPagePrintRows + 6, 7) = strChecker
                End If
                .Cells(iRowNum + 4, 1) = strExplanation
                .Cells(iRowNum + 4, 4) = strAccNum & "-" & strAccFullName
                If dblDebit <> 0 Then
                    Sheet9.Cells(iRowNum + 4, 8) = dblDebit
                End If
                If dblCredit <> 0 Then
                    Sheet9.Cells(iRowNum + 4, 10) = dblCredit
                End If
            Else
                j = Application.Ceiling(i / iPagePrintRows, 1)
                k = i Mod iPagePrintRows
                If k = 0 Then
                    k = iPagePrintRows
                End If

                If k = 1 Then
                    .Cells(1 + (j - 1) * iPageRows, 10) = "第" & j & "页  共" & iPages & "页"
                    .Cells(2 + (j - 1) * iPageRows, 5) = dteDate
                    .Cells(2 + (j - 1) * iPageRows, 5) = dteDate
                    .Cells(2 + (j - 1) * iPageRows, 10) = strGroup
                    .Cells(2 + (j - 1) * iPageRows, 11) = iVchNum
                    .Cells(3 + (j - 1) * iPageRows, 11) = iAttachment
                    .Cells(iPagePrintRows + 6 + (j - 1) * iPageRows, 11) = strMaker
                    .Cells(iPagePrintRows + 6 + (j - 1) * iPageRows, 4) = strPoster
                    .Cells(iPagePrintRows + 6 + (j - 1) * iPageRows, 7) = strChecker
                End If
                .Cells(k + 4 + (j - 1) * iPageRows, 1) = strExplanation
                .Cells(k + 4 + (j - 1) * iPageRows, 4) = strAccNum & "-" & strAccFullName
                If dblDebit <> 0 Then
                    .Cells(k + 4 + (j - 1) * iPageRows, 8) = dblDebit
                End If
                If dblCredit <> 0 Then
                    .Cells(k + 4 + (j - 1) * iPageRows, 10) = dblCredit
                End If
            End If
            dblTotalDebit = dblTotalDebit + dblDebit
            dblTotalCredit = dblTotalCredit + dblCredit
        Next
        For y = 1 To iPages
            .Cells(iPagePrintRows + 5 + (y - 1) * iPageRows, 8) = dblTotalDebit
            .Cells(iPagePrintRows + 5 + (y - 1) * iPageRows, 10) = dblTotalCredit
        Next
    End With
End If

    Me.Hide
    'Set arr() = Nothing

'Call ProtectVchPrintData
'
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
End Sub
Private Sub UserForm_Initialize()

    iBeginYear = CInt(GetBeginYear)
    iBeginPeriod = CInt(GetBeginPeriod())
    iOpenPeriod = CInt(GetOpenPeriod())
    iCurrentYear = CInt(GetCurrentYear)
    iCurrentPeriod = CInt(GetCurrentPeriod)
'设置年份下列框
    If iBeginYear = iCurrentYear Then
        cbo_Year.AddItem iBeginYear
        cbo_Year.Value = iBeginYear
    ElseIf iCurrentYear > iBeginYear Then
        For i = iBeginYear To iCurrentYear
            cbo_Year.AddItem i
        Next
        cbo_Year.Value = iBeginYear
    End If
    
'设置月份下列框
    For i = 1 To 12
        cbo_Period.AddItem i
    Next
    cbo_Period.Value = 1

End Sub
Attribute VB_Name = "frm_balReCal"
Attribute VB_Base = "0{60877A60-08B4-4B47-AC4C-3B119A999F21}{8E61E2BB-ABAA-4BFA-BD7E-81E85A37EB29}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub cmd_Cancel_Click()
    
    Unload Me
    
End Sub

Private Sub cmd_OK_Click()

Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

    Dim iPeriod As Integer
    iPeriod = CInt(cbo_Period.Value)
    Call CalDetailBal(iPeriod)
    Call calParentBal(iPeriod)
    
    Unload Me
    
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
    
End Sub
Private Sub UserForm_Initialize()

    iOpenPeriod = GetOpenPeriod()
    
    For i = iOpenPeriod To 12
        cbo_Period.AddItem i
    Next
    
    cbo_Period.Value = iOpenPeriod
    
End Sub
Attribute VB_Name = "menu_Accounts"
Attribute VB_Base = "0{F6FA1CCD-D5AA-4646-AD46-08979C835D89}{7A68FDC0-8EAF-4CF6-940D-5ECA2D5BA480}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btn_Back_Click()

    Unload Me
    Sheet12.Visible = xlSheetHidden
    Sheet1.Activate
    
End Sub

Private Sub btn_Cal_Click()

    Call CalAccBeginBal
    Call calBeginParentBal
    MsgBox "快狗提示：期初数据计算完成！"
    
End Sub

Private Sub btn_calAllBal_Click()

    Dim iBeginPeriod As Integer
    Dim iCurrentPeriod As Integer
    Dim i As Integer
    
    iBeginPeriod = CInt(Sheet15.Cells(3, 2))
    iCurrentPeriod = CInt(Sheet15.Cells(4, 2))
    
    For i = iBeginPeriod To iCurrentPeriod
        Call calPeriodBal(i)
        Call calParentBal(i)
    Next
     
     MsgBox "快狗提示：数据汇总完成！"
     
End Sub

Private Sub btn_calBalance_Click()

    Call calBalance
    
End Sub

Private Sub btn_calPeriodBal_Click()

    Dim iPeriod As Integer
    iPeriod = CInt(Sheet15.Cells(4, 2))
    Call calPeriodBal(iPeriod)
    Call calParentBal(iPeriod)

    MsgBox "快狗提示：当前期间数据汇总完成！"
    
End Sub

Private Sub btn_clearData_Click()
    Call clearData
End Sub

Private Sub btn_ClearColor_Click()

    Call clearColor
    
End Sub

Private Sub btn_displayZero_Click()

    Dim iAccRows As Integer
    iAccRows = Sheet12.Cells(Rows.Count, 1).End(xlUp).Row
    If iAccRows >= 2 Then
    Sheet12.Range("I2:AK" & iAccRows).Select
    Selection.NumberFormatLocal = "0.00 "
    End If
    
End Sub

Private Sub btn_EndInit_Click()

    Dim iInit As Integer
    iInit = CInt(Sheet15.Cells(7.2))
    
    If iInit = 1 Then
        MsgBox "快狗提示：初始化已经结束，不用再操作！": Exit Sub
    Else
        Sheet15.Cells(7.2) = 1
        MsgBox "快狗提示：初始化结束！"
    End If
    
End Sub

Private Sub btn_hideZero_Click()

    Dim iAccRows As Integer
    iAccRows = Sheet12.Cells(Rows.Count, 1).End(xlUp).Row
    If iAccRows >= 2 Then
    Sheet12.Range("I2:AK" & iAccRows).Select
    Selection.NumberFormatLocal = "0.00;-0.00;;@"
    End If
    
End Sub

Private Sub btn_SetColor_Click()

    Call clearColor
    Call setColor
    
End Sub
Private Sub btn_test_Click()
    Call clearColor
End Sub
Private Sub setColor()

    Dim lAccRows As Long
    lAccRows = Sheet12.Cells(Rows.Count, 1).End(xlUp).Row

    For l = 2 To lAccRows
        If Sheet12.Cells(l, 7) = 0 Then
            Sheet12.Range("A" & l & ":L" & l).Select
            With Selection.Interior
                .Pattern = xlSolid
                .PatternColorIndex = xlAutomatic
                .Color = 13434879
                .TintAndShade = 0
                .PatternTintAndShade = 0
            End With
        End If
    Next
    
    If Sheet15.Cells(3, 2) <> 1 Then
    Sheet12.Range("I2" & ":I" & lAccRows).Select
    With Selection.Interior
                .Pattern = xlSolid
                .PatternColorIndex = xlAutomatic
                .Color = 13434879
                .TintAndShade = 0
                .PatternTintAndShade = 0
    End With
    Else
    Sheet12.Range("L2" & ":L" & lAccRows).Select
    With Selection.Interior
                .Pattern = xlSolid
                .PatternColorIndex = xlAutomatic
                .Color = 13434879
                .TintAndShade = 0
                .PatternTintAndShade = 0
    End With
    End If
    
    Sheet12.Range("M2" & ":AJ" & lAccRows).Select
    With Selection.Interior
                .Pattern = xlSolid
                .PatternColorIndex = xlAutomatic
                .Color = 13434879
                .TintAndShade = 0
                .PatternTintAndShade = 0
    End With
    
End Sub
Private Sub clearColor()

    Dim lAccRows As Long
    lAccRows = Sheet12.Cells(Rows.Count, 1).End(xlUp).Row
    
    Sheet12.Range("A2" & ":AJ" & lAccRows).Select
    With Selection.Interior
                .Pattern = xlSolid
                .PatternColorIndex = xlAutomatic
                .ThemeColor = xlThemeColorDark1
                .TintAndShade = 0
                .PatternTintAndShade = 0
    End With
    
End Sub
Private Sub calBalance()

    Dim lAccRows As Long
    Dim dblBeginBal As Double '期初余额
    Dim dblTotalBal As Double '累计借方发生
    Dim dblEndBal As Double '期末余额
    
'计算上级非明细科目金额
     Call CalAccBeginBal
     Call calBeginParentBal
    
'变量赋值
    dblBeginBal = 0
    dblEndBal = 0
    dblToralBal = 0
    
    lAccRows = Sheet12.Cells(Rows.Count, 1).End(xlUp).Row
    
    If Sheet15.Cells(3, 2) <> 1 Then
        For i = 2 To lAccRows
            If Sheet12.Cells(i, 8) = 1 Then
                dblTotalBal = dblTotalBal + Sheet12.Cells(i, 10) + Sheet12.Cells(i, 11)
                dblBeginBal = dblBeginBal + Sheet12.Cells(i, 9)
            End If
        Next i
        Else
        For i = 2 To lAccRows
            If Sheet12.Cells(i, 8) = 1 Then
               dblBeginBal = dblBeginBal + Sheet12.Cells(i, 9)
            End If
        Next i
    End If
    
    If dblToalBal = 0 And dblBeginBal = 0 Then
        MsgBox "快狗提示：试算平衡！"
        Else
        MsgBox "快狗提示：试算不平衡，请检查！"
    End If
    
End Sub
Private Sub CalAccBeginBal()

    Dim lAccRows As Long
    Dim strParentNum As String
        
    lAccRows = Sheet12.Cells(Rows.Count, 1).End(xlUp).Row
    
    If Sheet15.Cells(3, 2) <> 1 Then
        
        For l = lAccRows To 2 Step -1
            If Abs(Sheet12.Cells(l, 12)) + Abs(Sheet12.Cells(l, 11)) + Abs(Sheet12.Cells(l, 10)) <> 0 Then
                Sheet12.Cells(l, 9) = Sheet12.Cells(l, 12) - Sheet12.Cells(l, 11) - Sheet12.Cells(l, 10)
            End If
        Next
        
    End If
        
End Sub

'Private Sub calParentBal()
'
't = Timer
'
'
'    Dim lAccRows As Long
'    lAccRows = Sheet12.Cells(rows.Count, 1).End(xlUp).Row
'
'            Dim strParentNum As String
'            Dim iLevel As Integer
'            Dim dblaadebit, dblaacredit, dblbbdebit, dblbbcredit, dblccdebit, dblcccredit, dbldddebit, dblddcredit As Double
'            Dim dbleedebit, dbleecredit, dblffdebit, dblffcredit, dblggdebit, dblggcredit, dblhhdebit, dblhhcredit As Double
'            Dim dbliidebit, dbliicredit, dbljjdebit, dbljjcredit, dblkkdebit, dblkkcredit, dbllldebit, dblllcredit As Double
'
'
'        For l = lAccRows To 2 Step -1
'
'            If Sheet12.Cells(l, 7) = 0 Then
'
'                strParentNum = Sheet12.Cells(l, 1)
'
'                dblaadebit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("M" & l & ":M" & lAccRows))
'                dblaacredit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("N" & l & ":N" & lAccRows))
'                dblbbdebit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("O" & l & ":O" & lAccRows))
'                dblbbcredit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("P" & l & ":P" & lAccRows))
'                dblccdebit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("Q" & l & ":Q" & lAccRows))
'                dblcccredit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("R" & l & ":R" & lAccRows))
'                dbldddebit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("S" & l & ":S" & lAccRows))
'                dblddcredit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("T" & l & ":T" & lAccRows))
'                dbleedebit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("U" & l & ":U" & lAccRows))
'                dbleecredit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("V" & l & ":V" & lAccRows))
'                dblffdebit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("W" & l & ":W" & lAccRows))
'                dblffcredit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("X" & l & ":X" & lAccRows))
'                dblggdebit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("Y" & l & ":Y" & lAccRows))
'                dblggcredit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("Z" & l & ":Z" & lAccRows))
'                dblhhdebit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("AA" & l & ":AA" & lAccRows))
'                dblhhcredit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("AB" & l & ":AB" & lAccRows))
'                dbliidebit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("AC" & l & ":AC" & lAccRows))
'                dbliicredit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("AD" & l & ":AD" & lAccRows))
'                dbljjdebit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("AE" & l & ":AE" & lAccRows))
'                dbljjcredit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("AF" & l & ":AF" & lAccRows))
'                dblkkdebit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("AG" & l & ":AG" & lAccRows))
'                dblkkcredit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("AH" & l & ":AH" & lAccRows))
'                dbllldebit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("AI" & l & ":AI" & lAccRows))
'                dblllcredit = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("AJ" & l & ":AJ" & lAccRows))
'
'
'                Sheet12.Cells(l, 13) = dblaadebit
'                Sheet12.Cells(l, 14) = dblaacredit
'                Sheet12.Cells(l, 15) = dblbbdebit
'                Sheet12.Cells(l, 16) = dblbbcredit
'                Sheet12.Cells(l, 17) = dblccdebit
'                Sheet12.Cells(l, 18) = dblcccredit
'                Sheet12.Cells(l, 19) = dbldddebit
'                Sheet12.Cells(l, 20) = dblddcredit
'                Sheet12.Cells(l, 21) = dbleedebit
'                Sheet12.Cells(l, 22) = dbleecredit
'                Sheet12.Cells(l, 23) = dblffdebit
'                Sheet12.Cells(l, 24) = dblffcredit
'                Sheet12.Cells(l, 25) = dblggdebit
'                Sheet12.Cells(l, 26) = dblggcredit
'                Sheet12.Cells(l, 27) = dblhhdebit
'                Sheet12.Cells(l, 28) = dblhhcredit
'                Sheet12.Cells(l, 29) = dbliidebit
'                Sheet12.Cells(l, 30) = dbliicredit
'                Sheet12.Cells(l, 31) = dbljjdebit
'                Sheet12.Cells(l, 32) = dbljjcredit
'                Sheet12.Cells(l, 33) = dblkkdebit
'                Sheet12.Cells(l, 34) = dblkkcredit
'                Sheet12.Cells(l, 35) = dbllldebit
'                Sheet12.Cells(l, 36) = dblllcredit
'
'            '数据置零
'
'                dblaadebit = 0
'                dblaacredit = 0
'                dblbbdebit = 0
'                dblbbcredit = 0
'                dblccdebit = 0
'                dblccbcredit = 0
'                dbldddebit = 0
'                dblddcredit = 0
'                dbleedebit = 0
'                dbleecredit = 0
'                dblffdebit = 0
'                dblffbcredit = 0
'                dblggdebit = 0
'                dblggcredit = 0
'                dblhhdebit = 0
'                dblhhcredit = 0
'                dbliidebit = 0
'                dbliibcredit = 0
'                dbljjdebit = 0
'                dbljjcredit = 0
'                dblkkdebit = 0
'                dblkkcredit = 0
'                dbllldebit = 0
'                dblllbcredit = 0
'
'            End If
'        Next
'    MsgBox Timer - t
'End Sub
Public Sub calBeginParentBal()

    Dim lAccRows As Long
    Dim strParentNum As String
            
    lAccRows = Sheet12.Cells(Rows.Count, 1).End(xlUp).Row
        
        For l = lAccRows To 2 Step -1
            
            If Sheet12.Cells(l, 7) = 0 Then
                strParentNum = Sheet12.Cells(l, 1)
                If Sheet15.Cells(3, 2) <> 1 Then
                    
                    Sheet12.Cells(l, 9) = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("I" & l & ":I" & lAccRows))
                    Sheet12.Cells(l, 10) = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("J" & l & ":J" & lAccRows))
                    Sheet12.Cells(l, 11) = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("K" & l & ":K" & lAccRows))
                    Sheet12.Cells(l, 12) = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("L" & l & ":L" & lAccRows))

                Else

                    Sheet12.Cells(l, 9) = Application.WorksheetFunction.SumIf(Sheet12.Range("F" & l & ":F" & lAccRows), strParentNum, Sheet12.Range("I" & l & ":I" & lAccRows))
                
                End If

            End If
        Next
        
End Sub

Private Sub CommandButton1_Click()
    Call calBeginParentBal
End Sub

Attribute VB_Name = "menu_ProfitReport"
Attribute VB_Base = "0{8C6D0489-B70A-4208-A816-6B1BDBC48E56}{F251D61E-5DC3-490E-A9E0-1D17BB9A936F}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btn_Back_Click()

    Unload Me
    Sheet11.Visible = xlSheetHidden
    Sheet1.Activate
    
End Sub

Private Sub btn_Dispaly_Click()

    Dim iYear As Integer
    Dim iPeriod As Integer
    Dim dteMaxDate As Date
    
    iYear = CInt(Sheet15.Cells(2, 2))
    iPeriod = CInt(cbo_Period.Value)
    dteMaxDate = GetMaxDate(iYear, iPeriod)
    
    Sheet11.Cells(3, 2) = dteMaxDate
    iReportPeriod = iPeriod
    
    Unload Me
    
    Calculate
    
End Sub
Private Sub UserForm_Initialize()

    cbo_Period.AddItem "1"
    cbo_Period.AddItem "2"
    cbo_Period.AddItem "3"
    cbo_Period.AddItem "4"
    cbo_Period.AddItem "5"
    cbo_Period.AddItem "6"
    cbo_Period.AddItem "7"
    cbo_Period.AddItem "8"
    cbo_Period.AddItem "9"
    cbo_Period.AddItem "10"
    cbo_Period.AddItem "11"
    cbo_Period.AddItem "12"
    
    cbo_Period.Value = 1
    
End Sub

Attribute VB_Name = "temp"
Sub SetTempBalanceTitle()
    With Sheets("Temp")
        .Cells(1, 1) = "科目代码"
        .Cells(1, 2) = "科目全称"
        .Cells(1, 3) = "余额方向"
        .Cells(1, 4) = "上级科目"
        .Cells(1, 5) = "是否明细"
        .Cells(1, 6) = "科目级别"
        .Cells(1, 7) = "初始年初余额"
        .Cells(1, 8) = "初始累计借方"
        .Cells(1, 9) = "初始累计贷方"
        .Cells(1, 10) = "初始余额"
        .Cells(1, 11) = "年度发生额"
        .Cells(1, 12) = "期初发生"
        .Cells(1, 13) = "期初方向"
        .Cells(1, 14) = "期初余额"
        .Cells(1, 15) = "本期借方"
        .Cells(1, 16) = "本期贷方"
        .Cells(1, 17) = "累计借方"
        .Cells(1, 18) = "累计贷方"
        .Cells(1, 19) = "本年累计借方"
        .Cells(1, 20) = "本年累计贷方"
        .Cells(1, 21) = "期末方向"
        .Cells(1, 22) = "期末余额"
        .Cells(1, 23) = "合计绝对值"
    End With
End Sub
Sub AddSheetTemp()
    Dim d
    Dim sht As Worksheet
    Dim strName As String
    strName = "Temp"
    Set d = CreateObject("Scripting.Dictionary")
    For Each sht In Worksheets
       d(sht.Name) = ""
    Next
    If Not d.exists(strName) Then
        Worksheets.Add().Name = "Temp"
    End If
    Set d = Nothing
End Sub
Sub DeleteSheetTemp()
    Dim d
    Dim sht As Worksheet
    Dim strName As String
    strName = "Temp"
    Set d = CreateObject("Scripting.Dictionary")
    For Each sht In Worksheets
       d(sht.Name) = ""
    Next
    If d.exists(strName) Then
        Application.DisplayAlerts = 0
        Sheets("Temp").Delete
        Application.DisplayAlerts = 1
    End If
    Set d = Nothing
End Sub
Sub SetTempDetailTitle()
    With Sheets("Temp")
        .Cells(1, 1) = "年度"
        .Cells(1, 2) = "期间"
        .Cells(1, 3) = "日期"
        .Cells(1, 4) = "凭证字"
        .Cells(1, 5) = "凭证号"
        .Cells(1, 6) = "摘要"
        .Cells(1, 7) = "借方"
        .Cells(1, 8) = "贷方"
        .Cells(1, 9) = "方向"
        .Cells(1, 10) = "余额"
        .Cells(1, 11) = "排序"
    End With
End Sub
Sub SortTempDetailData()

    Dim lTempRows As Long
    lTempRows = Sheets("Temp").Cells(Rows.Count, 1).End(xlUp).Row
    
    If lTempRows >= 2 Then
        Sheets("Temp").Range("A1:K" & lTempRows).Sort _
        Key1:=Sheets("Temp").Range("B2"), _
        Key2:=Sheets("Temp").Range("K2"), _
        Key3:=Sheets("Temp").Range("E2"), _
        Header:=xlGuess
    End If
    
End Sub
Sub CopyTempDetailData()

    Dim lTempRows As Long
    lTempRows = Sheets("Temp").Cells(Rows.Count, 1).End(xlUp).Row
    
    If lTempRows >= 2 Then
        Sheets("Temp").Range("A2:J" & lTempRows).Copy
        Sheet13.Range("B4").Select
        ActiveSheet.Paste
    End If
    
End Sub
Sub SetTempLedgerTitle()
    With Sheets("Temp")
        .Cells(1, 1) = "年度"
        .Cells(1, 2) = "期间"
        .Cells(1, 3) = "摘要"
        .Cells(1, 4) = "借方"
        .Cells(1, 5) = "贷方"
        .Cells(1, 6) = "方向"
        .Cells(1, 7) = "余额"
        .Cells(1, 8) = "排序"
    End With
End Sub
Sub CopyTempLedgerData()

    Dim lTempRows As Long
    Dim myRange1 As Range
    Dim myRange2 As Range
    lTempRows = Sheets("Temp").Cells(Rows.Count, 1).End(xlUp).Row
    
    If lTempRows >= 2 Then
        Set myRange1 = Sheets("Temp").Range("A2:G" & lTempRows)
        Set myRange2 = Sheet14.Range("B4")
        myRange1.Copy Destination:=myRange2
    End If
    
End Sub
Attribute VB_Name = "模块1"
Sub 宏1()
Attribute 宏1.VB_ProcData.VB_Invoke_Func = " \n14"
'
' 宏1 宏
'

'
    Rows("5:5").Select
    Selection.Copy
    Selection.Insert Shift:=xlDown
    Application.CutCopyMode = False
    ActiveWorkbook.Save
End Sub
